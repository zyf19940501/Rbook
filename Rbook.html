<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>R学习笔记</title>
  <meta name="description" content="个人学习R语言笔记" />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="R学习笔记" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="个人学习R语言笔记" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R学习笔记" />
  
  <meta name="twitter:description" content="个人学习R语言笔记" />
  

<meta name="author" content="Yufei Zhong" />


<meta name="date" content="2021-05-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">R学习笔记</h1>
<p class="author"><em>Yufei Zhong</em></p>
<p class="date" style="margin-top: 1.5em;"><em>2021-05-10</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#说明"><span class="toc-section-number">1</span> 说明</a></li>
<li><a href="#data.table"><span class="toc-section-number">2</span> data.table</a>
<ul>
<li><a href="#基础介绍"><span class="toc-section-number">2.1</span> 基础介绍</a>
<ul>
<li><a href="#读取数据"><span class="toc-section-number">2.1.1</span> 读取数据</a></li>
<li><a href="#基本格式"><span class="toc-section-number">2.1.2</span> 基本格式</a></li>
<li><a href="#i-j-by-使用"><span class="toc-section-number">2.1.3</span> i j by 使用</a></li>
<li><a href="#行列筛选总结"><span class="toc-section-number">2.1.4</span> 行列筛选总结</a></li>
</ul></li>
<li><a href="#常规操作"><span class="toc-section-number">2.2</span> 常规操作</a>
<ul>
<li><a href="#新增更新列"><span class="toc-section-number">2.2.1</span> 新增更新列</a></li>
<li><a href="#排序"><span class="toc-section-number">2.2.2</span> 排序</a></li>
<li><a href="#行筛选"><span class="toc-section-number">2.2.3</span> 行筛选</a></li>
<li><a href="#特殊符号"><span class="toc-section-number">2.2.4</span> 特殊符号</a></li>
</ul></li>
<li><a href="#常用函数"><span class="toc-section-number">2.3</span> 常用函数</a>
<ul>
<li><a href="#排序函数-frank"><span class="toc-section-number">2.3.1</span> 排序函数 frank</a></li>
<li><a href="#判断函数"><span class="toc-section-number">2.3.2</span> 判断函数</a></li>
<li><a href="#交集-差集-合并"><span class="toc-section-number">2.3.3</span> 交集 差集 合并</a></li>
<li><a href="#连接"><span class="toc-section-number">2.3.4</span> 连接</a></li>
<li><a href="#透视表功能"><span class="toc-section-number">2.3.5</span> 透视表功能</a></li>
<li><a href="#非重复计数"><span class="toc-section-number">2.3.6</span> 非重复计数</a></li>
<li><a href="#rleid"><span class="toc-section-number">2.3.7</span> rleid</a></li>
<li><a href="#shift"><span class="toc-section-number">2.3.8</span> shift</a></li>
</ul></li>
<li><a href="#运用"><span class="toc-section-number">2.4</span> 运用</a>
<ul>
<li><a href="#自定义函数计算"><span class="toc-section-number">2.4.1</span> 自定义函数计算</a></li>
<li><a href="#带汇总的聚合运算"><span class="toc-section-number">2.4.2</span> 带汇总的聚合运算</a></li>
<li><a href="#行列转变"><span class="toc-section-number">2.4.3</span> 行列转变</a></li>
</ul></li>
</ul></li>
<li><a href="#database"><span class="toc-section-number">3</span> database</a>
<ul>
<li><a href="#安装数据库"><span class="toc-section-number">3.1</span> 安装数据库</a></li>
<li><a href="#dbi"><span class="toc-section-number">3.2</span> DBI</a>
<ul>
<li><a href="#安装"><span class="toc-section-number">3.2.1</span> 安装</a></li>
<li><a href="#连接数据库"><span class="toc-section-number">3.2.2</span> 连接数据库</a></li>
<li><a href="#执行sql任务"><span class="toc-section-number">3.2.3</span> 执行sql任务</a></li>
<li><a href="#函数介绍"><span class="toc-section-number">3.2.4</span> 函数介绍</a></li>
</ul></li>
<li><a href="#odbc包"><span class="toc-section-number">3.3</span> odbc包</a></li>
<li><a href="#rodbc包"><span class="toc-section-number">3.4</span> RODBC包</a></li>
<li><a href="#roracle包"><span class="toc-section-number">3.5</span> ROracle包</a></li>
<li><a href="#rmysql包"><span class="toc-section-number">3.6</span> RMySQL包</a>
<ul>
<li><a href="#安装-1"><span class="toc-section-number">3.6.1</span> 安装</a></li>
<li><a href="#连接使用"><span class="toc-section-number">3.6.2</span> 连接使用</a></li>
</ul></li>
<li><a href="#常见问题"><span class="toc-section-number">3.7</span> 常见问题</a>
<ul>
<li><a href="#乱码问题"><span class="toc-section-number">3.7.1</span> 乱码问题</a></li>
<li><a href="#无法连接问题"><span class="toc-section-number">3.7.2</span> 无法连接问题</a></li>
<li><a href="#远程连接"><span class="toc-section-number">3.7.3</span> 远程连接</a></li>
</ul></li>
<li><a href="#dbplyr"><span class="toc-section-number">3.8</span> dbplyr</a>
<ul>
<li><a href="#基础用法"><span class="toc-section-number">3.8.1</span> 基础用法</a></li>
<li><a href="#无法正确转化"><span class="toc-section-number">3.8.2</span> 无法正确转化</a></li>
</ul></li>
<li><a href="#参考资料"><span class="toc-section-number">3.9</span> 参考资料</a></li>
</ul></li>
<li><a href="#stringr"><span class="toc-section-number">4</span> stringr</a>
<ul>
<li><a href="#基础"><span class="toc-section-number">4.1</span> 基础</a>
<ul>
<li><a href="#单双引号"><span class="toc-section-number">4.1.1</span> 单双引号</a></li>
<li><a href="#转义"><span class="toc-section-number">4.1.2</span> 转义</a></li>
<li><a href="#字符串长度"><span class="toc-section-number">4.1.3</span> 字符串长度</a></li>
<li><a href="#连接字符串"><span class="toc-section-number">4.1.4</span> 连接字符串</a></li>
<li><a href="#r4.0后新特性"><span class="toc-section-number">4.1.5</span> R4.0后新特性</a></li>
</ul></li>
<li><a href="#常用函数-1"><span class="toc-section-number">4.2</span> 常用函数</a>
<ul>
<li><a href="#截取"><span class="toc-section-number">4.2.1</span> 截取</a></li>
<li><a href="#匹配"><span class="toc-section-number">4.2.2</span> 匹配</a></li>
<li><a href="#添加字符"><span class="toc-section-number">4.2.3</span> 添加字符</a></li>
<li><a href="#去除空格"><span class="toc-section-number">4.2.4</span> 去除空格</a></li>
<li><a href="#分割字符"><span class="toc-section-number">4.2.5</span> 分割字符</a></li>
<li><a href="#替换字符"><span class="toc-section-number">4.2.6</span> 替换字符</a></li>
<li><a href="#移除字符"><span class="toc-section-number">4.2.7</span> 移除字符</a></li>
<li><a href="#字符排序"><span class="toc-section-number">4.2.8</span> 字符排序</a></li>
<li><a href="#提取单词"><span class="toc-section-number">4.2.9</span> 提取单词</a></li>
<li><a href="#其他函数"><span class="toc-section-number">4.2.10</span> 其他函数</a></li>
</ul></li>
<li><a href="#r实现excel字符函数"><span class="toc-section-number">4.3</span> R实现Excel字符函数</a></li>
</ul></li>
<li><a href="#lubridate"><span class="toc-section-number">5</span> lubridate</a>
<ul>
<li><a href="#基础用法-1"><span class="toc-section-number">5.1</span> 基础用法</a>
<ul>
<li><a href="#安装包"><span class="toc-section-number">5.1.1</span> 安装包</a></li>
<li><a href="#获取当前时间日期"><span class="toc-section-number">5.1.2</span> 获取当前时间日期</a></li>
<li><a href="#获取日期时间中的组成部分"><span class="toc-section-number">5.1.3</span> 获取日期时间中的组成部分</a></li>
</ul></li>
<li><a href="#处理时区"><span class="toc-section-number">5.2</span> 处理时区</a></li>
<li><a href="#解析日期和时间"><span class="toc-section-number">5.3</span> 解析日期和时间</a></li>
<li><a href="#构造日期或时间"><span class="toc-section-number">5.4</span> 构造日期或时间</a></li>
<li><a href="#时间间隔"><span class="toc-section-number">5.5</span> 时间间隔</a></li>
<li><a href="#时间日期计算"><span class="toc-section-number">5.6</span> 时间日期计算</a></li>
<li><a href="#案例"><span class="toc-section-number">5.7</span> 案例</a>
<ul>
<li><a href="#年同环比"><span class="toc-section-number">5.7.1</span> 年同环比</a></li>
<li><a href="#清洗不同类型日期格式"><span class="toc-section-number">5.7.2</span> 清洗不同类型日期格式</a></li>
<li><a href="#扫码后中奖时间匹配"><span class="toc-section-number">5.7.3</span> 扫码后中奖时间匹配</a></li>
</ul></li>
<li><a href="#资料"><span class="toc-section-number">5.8</span> 资料</a></li>
</ul></li>
<li><a href="#forcats"><span class="toc-section-number">6</span> forcats</a>
<ul>
<li><a href="#创建因子"><span class="toc-section-number">6.1</span> 创建因子</a></li>
</ul></li>
<li><a href="#tidyr"><span class="toc-section-number">7</span> tidyr</a>
<ul>
<li><a href="#安装-2"><span class="toc-section-number">7.1</span> 安装</a></li>
<li><a href="#主要功能"><span class="toc-section-number">7.2</span> 主要功能</a>
<ul>
<li><a href="#宽转长"><span class="toc-section-number">7.2.1</span> 宽转长</a></li>
<li><a href="#长转宽"><span class="toc-section-number">7.2.2</span> 长转宽</a></li>
<li><a href="#处理jsonhtml的数据"><span class="toc-section-number">7.2.3</span> 处理json,html的数据</a></li>
<li><a href="#嵌套数据"><span class="toc-section-number">7.2.4</span> 嵌套数据</a></li>
<li><a href="#嵌套数据和模型"><span class="toc-section-number">7.2.5</span> 嵌套数据和模型</a></li>
<li><a href="#拆分和合并"><span class="toc-section-number">7.2.6</span> 拆分和合并</a></li>
<li><a href="#缺失值处理"><span class="toc-section-number">7.2.7</span> 缺失值处理</a></li>
</ul></li>
</ul></li>
<li><a href="#dplyr"><span class="toc-section-number">8</span> dplyr</a>
<ul>
<li><a href="#前言"><span class="toc-section-number">8.1</span> 前言</a></li>
<li><a href="#安装-3"><span class="toc-section-number">8.2</span> 安装</a></li>
<li><a href="#基础用法-2"><span class="toc-section-number">8.3</span> 基础用法</a>
<ul>
<li><a href="#filter"><span class="toc-section-number">8.3.1</span> filter</a></li>
<li><a href="#select"><span class="toc-section-number">8.3.2</span> select</a></li>
<li><a href="#rename"><span class="toc-section-number">8.3.3</span> rename</a></li>
<li><a href="#relocate"><span class="toc-section-number">8.3.4</span> relocate</a></li>
<li><a href="#mutate"><span class="toc-section-number">8.3.5</span> mutate</a></li>
<li><a href="#arrange"><span class="toc-section-number">8.3.6</span> arrange</a></li>
<li><a href="#group_by"><span class="toc-section-number">8.3.7</span> group_by</a></li>
<li><a href="#summarise"><span class="toc-section-number">8.3.8</span> summarise</a></li>
</ul></li>
<li><a href="#表操作"><span class="toc-section-number">8.4</span> 表操作</a>
<ul>
<li><a href="#基础-4"><span class="toc-section-number">8.4.1</span> 基础</a></li>
<li><a href="#多表操作"><span class="toc-section-number">8.4.2</span> 多表操作</a></li>
</ul></li>
<li><a href="#列操作"><span class="toc-section-number">8.5</span> 列操作</a>
<ul>
<li><a href="#基本操作"><span class="toc-section-number">8.5.1</span> 基本操作</a></li>
<li><a href="#多种函数功能"><span class="toc-section-number">8.5.2</span> 多种函数功能</a></li>
<li><a href="#当前列"><span class="toc-section-number">8.5.3</span> 当前列</a></li>
</ul></li>
<li><a href="#行操作"><span class="toc-section-number">8.6</span> 行操作</a>
<ul>
<li><a href="#构造数据集"><span class="toc-section-number">8.6.1</span> 构造数据集</a></li>
<li><a href="#行汇总统计"><span class="toc-section-number">8.6.2</span> 行汇总统计</a></li>
</ul></li>
<li><a href="#分组操作"><span class="toc-section-number">8.7</span> 分组操作</a>
<ul>
<li><a href="#添加分组"><span class="toc-section-number">8.7.1</span> 添加分组</a></li>
<li><a href="#删除分组变量"><span class="toc-section-number">8.7.2</span> 删除分组变量</a></li>
<li><a href="#动词"><span class="toc-section-number">8.7.3</span> 动词</a></li>
</ul></li>
<li><a href="#常用函数-2"><span class="toc-section-number">8.8</span> 常用函数</a>
<ul>
<li><a href="#条件判断"><span class="toc-section-number">8.8.1</span> 条件判断</a></li>
<li><a href="#case_when"><span class="toc-section-number">8.8.2</span> case_when</a></li>
<li><a href="#计数函数"><span class="toc-section-number">8.8.3</span> 计数函数</a></li>
<li><a href="#排序函数"><span class="toc-section-number">8.8.4</span> 排序函数</a></li>
<li><a href="#提取向量"><span class="toc-section-number">8.8.5</span> 提取向量</a></li>
<li><a href="#group-系列"><span class="toc-section-number">8.8.6</span> group 系列</a></li>
<li><a href="#其它函数"><span class="toc-section-number">8.8.7</span> 其它函数</a></li>
</ul></li>
<li><a href="#用dplyr编程"><span class="toc-section-number">8.9</span> 用<code>dplyr</code>编程</a>
<ul>
<li><a href="#案例-1"><span class="toc-section-number">8.9.1</span> 案例</a></li>
</ul></li>
</ul></li>
<li><a href="#loop-structure"><span class="toc-section-number">9</span> Loop structure</a>
<ul>
<li><a href="#简单示例"><span class="toc-section-number">9.1</span> 简单示例</a></li>
<li><a href="#循环基础"><span class="toc-section-number">9.2</span> 循环基础</a>
<ul>
<li><a href="#循环结构"><span class="toc-section-number">9.2.1</span> 循环结构</a></li>
<li><a href="#next-break-用法"><span class="toc-section-number">9.2.2</span> next break 用法</a></li>
<li><a href="#嵌套循环"><span class="toc-section-number">9.2.3</span> 嵌套循环</a></li>
</ul></li>
<li><a href="#循环变化"><span class="toc-section-number">9.3</span> 循环变化</a>
<ul>
<li><a href="#修改已有对象"><span class="toc-section-number">9.3.1</span> 修改已有对象</a></li>
<li><a href="#循环模式"><span class="toc-section-number">9.3.2</span> 循环模式</a></li>
<li><a href="#未知长度输出"><span class="toc-section-number">9.3.3</span> 未知长度输出</a></li>
</ul></li>
</ul></li>
<li><a href="#iteration"><span class="toc-section-number">10</span> Iteration</a>
<ul>
<li><a href="#简单用法"><span class="toc-section-number">10.1</span> 简单用法</a></li>
<li><a href="#map系列常用函数"><span class="toc-section-number">10.2</span> map系列常用函数</a></li>
<li><a href="#归约累计函数"><span class="toc-section-number">10.3</span> 归约累计函数</a></li>
<li><a href="#安全函数"><span class="toc-section-number">10.4</span> 安全函数</a></li>
<li><a href="#映射多个参数"><span class="toc-section-number">10.5</span> 映射多个参数</a></li>
<li><a href="#其他函数介绍"><span class="toc-section-number">10.6</span> 其他函数介绍</a></li>
</ul></li>
<li><a href="#define-function"><span class="toc-section-number">11</span> define function</a>
<ul>
<li><a href="#简单示例-1"><span class="toc-section-number">11.1</span> 简单示例</a></li>
<li><a href="#条件执行"><span class="toc-section-number">11.2</span> 条件执行</a>
<ul>
<li><a href="#多条件执行"><span class="toc-section-number">11.2.1</span> 多条件执行</a></li>
</ul></li>
<li><a href="#函数参数"><span class="toc-section-number">11.3</span> 函数参数</a>
<ul>
<li><a href="#参数名称"><span class="toc-section-number">11.3.1</span> 参数名称</a></li>
<li><a href="#检查参数值"><span class="toc-section-number">11.3.2</span> 检查参数值</a></li>
<li><a href="#参数"><span class="toc-section-number">11.3.3</span> …参数</a></li>
</ul></li>
<li><a href="#返回值"><span class="toc-section-number">11.4</span> 返回值</a>
<ul>
<li><a href="#显式返回"><span class="toc-section-number">11.4.1</span> 显式返回</a></li>
<li><a href="#编写管道函数"><span class="toc-section-number">11.4.2</span> 编写管道函数</a></li>
</ul></li>
<li><a href="#环境"><span class="toc-section-number">11.5</span> 环境</a></li>
<li><a href="#拓展部分"><span class="toc-section-number">11.6</span> 拓展部分</a></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R学习笔记</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="说明" class="section level1" number="1">
<h1 number="1"><span class="header-section-number">1</span> 说明</h1>
<p>作为商业数据分析师，我学习使用<code>R</code>以及有一段时间，主要用<code>R</code>来处理数据，自动化报表，ETL，可视化等，另外用<code>shiny</code>做看板。</p>
<p><code>R</code>极大的拓展了数据处理能力,让我很轻松方便处理数据，有更多精力时间聚焦在具体问题上。</p>
<p>本文主要记录个人学习过程中的经验，因个人能力有限，难免出现错误，如阅读中发现错误，欢迎联系本人更正。</p>
<p>Email: <a href="mailto:598253220@qq.com" class="email">598253220@qq.com</a></p>
<p>微信公众号: 宇飞的世界</p>
<p>语雀: <a href="https://www.yuque.com/zyufei" class="uri">https://www.yuque.com/zyufei</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#查看版本信息</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R version 4.0.3 (2020-10-10)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Running under: Windows 10 x64 (build 19041)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] LC_COLLATE=Chinese (Simplified)_China.936 </span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.936   </span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.936</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4] LC_NUMERIC=C                              </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.936    </span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] bookdown_0.22     digest_0.6.27     R6_2.5.0          jsonlite_1.7.2   </span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] magrittr_2.0.1    evaluate_0.14     stringi_1.5.3     rlang_0.4.10     </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] rstudioapi_0.13   jquerylib_0.1.3   bslib_0.2.4       rmarkdown_2.7    </span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] tools_4.0.3       stringr_1.4.0     xfun_0.22         yaml_2.2.1       </span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] compiler_4.0.3    htmltools_0.5.1.1 knitr_1.32        sass_0.3.1</span></span></code></pre></div>
<!--chapter:end:index.Rmd-->
</div>
<div id="data.table" class="section level1" number="2">
<h1 number="2"><span class="header-section-number">2</span> data.table</h1>
<p>data.table包是我最常用的R包，是我目前觉得最好用的数据处理包,大部分我需要用到的功能集成在包里，不需要很多的依赖包。我简单接触过python，julia两种语言，并没有深入比较，所以我这个好用的印象仅仅是个人感受。</p>
<p>data.table包是我用了较长一段时间tidyverse系列后发现的“数据处理包”。已经忘记最初是什么吸引了我，我猜测可能是“大数据处理利器”之类的标签吸引了我，因为我喜欢“快”。但是和大部分人可能不同的是，初次接触时，语法的“怪异”并没有给我带来多少麻烦，因为我本来就没有编程基础以及很深的R语言基础。</p>
<p>所以我死记硬背data.table里一些常用用法，尤其喜欢拿Excle的一些用法参照，去实现Excle上面的部分操作，从读取、增、改、删除、筛选、计算列等常规操作入手。慢慢熟悉data.table语法之后，将会享受data.table带来的便利，其简洁的语法以及高效的计算速度（相比tidyverse系列）。</p>
<p>另外，Python中也有该包，目前正在积极开发中，期待ing，毕竟python也是很好用，在不同需求下选择不同的语言实现功能。</p>
<p>官方关于data.table的基础介绍请参阅:</p>
<p><a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html" class="uri">https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html</a></p>
<p>data.table 优势：</p>
<ul>
<li>速度快</li>
<li>内存效率高</li>
<li>API生命周期管理好</li>
<li>语法简洁</li>
</ul>
<p>1.安装</p>
<p>安装详细信息请参考<a href="https://github.com/Rdatatable/data.table/wiki/Installation">the Installation wiki</a>，有关于不同系统安装首次以及相关说明。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># latest development version:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">update.dev.pkg</span>()</span></code></pre></div>
<div id="基础介绍" class="section level2" number="2.1">
<h2 number="2.1"><span class="header-section-number">2.1</span> 基础介绍</h2>
<p>本部分简单介绍data.table句式语法，实现基础行列筛选和聚合计算。</p>
<div id="读取数据" class="section level3" number="2.1.1">
<h3 number="2.1.1"><span class="header-section-number">2.1.1</span> 读取数据</h3>
<p>在我实际工作中接触的数据大部分以数据库,csv,Excel等形式存在，并且CSV格式数据较少。但是data.table包读取数据的<code>fread</code>函数仅接受CSV格式。如果是Excel格式文件，需要通过如<code>readxl</code>，<code>openxlsx</code>等包读入后转换为<code>data.table</code>格式数据。</p>
<p>fread 函数可以直接读取CSV格式文件,无论是本地文件或者在线文件.</p>
<p>本文会照搬很多官方关于data.table的demo.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">&quot;./data/flights.csv&quot;</span>)) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;./data/flights.csv&quot;</span> <span class="co">#本地文件</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights.csv&quot;</span> <span class="co">#在线文件需翻墙</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">fread</span>(input) <span class="co">#具体参数请参照文档  实际工作中可能会用到的encoding参数,编码 encoding=&#39;UTF-8&#39;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(flights)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    year month day dep_delay arr_delay carrier origin dest air_time distance</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 2014     1   1        14        13      AA    JFK  LAX      359     2475</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 2014     1   1        -3        13      AA    JFK  LAX      363     2475</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 2014     1   1         2         9      AA    JFK  LAX      351     2475</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: 2014     1   1        -8       -26      AA    LGA  PBI      157     1035</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: 2014     1   1         2         1      AA    JFK  LAX      350     2475</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: 2014     1   1         4         0      AA    EWR  LAX      339     2454</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    hour</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:    9</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:   11</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:   19</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:    7</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:   13</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:   18</span></span></code></pre></div>
<p>本文读取本地文件,如果该数据集下载失败,可更改地址为(<a href="http://www.zhongyufei.com/datatable/data/flights.csv" class="uri">http://www.zhongyufei.com/datatable/data/flights.csv</a>)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;http://www.zhongyufei.com/datatable/data/flights.csv&quot;</span>)</span></code></pre></div>
<p>数据集记录的是 2014 年,纽约市3大机场(分别为:JFK 肯尼迪国际机场、 LGA 拉瓜迪亚机场,和 EWR 纽瓦克自由国际机场)起飞的航班信息。</p>
<p>具体的记录信息(特征列)，包括起飞时间、到达时间、延误时长、航空公司、始发机场、目的机场、飞行时长，和飞行距离等。</p>
</div>
<div id="基本格式" class="section level3" number="2.1.2">
<h3 number="2.1.2"><span class="header-section-number">2.1.2</span> 基本格式</h3>
<p><code>DT[i, j, by]</code>是data.table的基本样式，在不同位置上实现不同功能。</p>
<div class="figure">
<img src="https://gitee.com/zhongyufei/photo-bed/raw/pic/img/data.table-i-j-by%E4%BB%8B%E7%BB%8D.png" alt="" />
<p class="caption">i-j-by</p>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>DT[i, j, by]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   R:                 i                 j        by</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">## SQL:  where | order by   select | update  group by</span></span></code></pre></div>
<p>data.table个人理解主要有三大类参数,i参数做筛选,j参数做计算,by参数做分组.</p>
<p>拿Excel透视表类别,i位置参数当作『筛选』,by位置用来做汇总字段『行』,j位置当作『值』,如下所示:</p>
<div class="figure">
<img src="picture/chap1/01picture.png" alt="" />
<p class="caption">透视表截图</p>
</div>
<p>1.代码实例</p>
<p>代码求2014年6月,从各始发机场到各目的机场的飞行距离求和.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;./data/flights.csv&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>flights[year<span class="sc">==</span><span class="dv">2014</span> <span class="sc">&amp;</span> month<span class="sc">==</span><span class="dv">6</span>,.(求和项<span class="at">distance=</span><span class="fu">sum</span>(distance)),by<span class="ot">=</span>.(origin,dest)]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      origin dest 求和项distance</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   1:    JFK  LAX        2663100</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   2:    JFK  DFW          82069</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   3:    JFK  LAS         795792</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   4:    JFK  SFO        1967946</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   5:    JFK  SAN         349778</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  ---                           </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 191:    EWR  ANC          13480</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 192:    EWR  BZN          15056</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 193:    LGA  TVC           7205</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 194:    LGA  BZN           3788</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 195:    JFK  HYA            980</span></span></code></pre></div>
<p>2.代码解释</p>
<p>i 的部分：条件year==2014 和 month==6 ;</p>
<p>j 的部分：求和项distance=sum(distance)，写在.()中或者list()中；</p>
<p>by 的部分.(origin,dest),重点是写在.()中,和Excel透视表一一对应。</p>
<p>至于为什么要用.()包裹起来，最开始默认为格式强制要求。就这个问题我想说：大部分人可能觉得是比较“怪异”的用法，并且不理解，从而可能留下data.table不好用，很古怪的印象，但是我觉得任何东西存在即合理，你学一个东西总得接受一些你可能不认可的东西，这样可能才是真正的学习，就像拿Python来做数据分析，我刚开始觉得pandas很难用，很反人类，但是后来知道python代码可以直接打包封装成exe后，觉得真香，说这么多主要是想表达我们学会挑选合适的工具用，适应它，用好它就可以了。</p>
</div>
<div id="i-j-by-使用" class="section level3" number="2.1.3">
<h3 number="2.1.3"><span class="header-section-number">2.1.3</span> i j by 使用</h3>
<p>使用data.table处理数据，接下来我们就用该函数读取数据演示i,j,by的简单使用。</p>
<div id="i行筛选" class="section level4" number="2.1.3.1">
<h4 number="2.1.3.1"><span class="header-section-number">2.1.3.1</span> i行筛选</h4>
<p>行筛选是一种很常见的数据操作行为，类似我们Excel中的筛选，即按照一定条件筛选符合要求的数据。条件筛选一般分为单条件筛选、多条件筛选；</p>
<p>在筛选时涉及到条件判断，R语言中常用的条件判断分为逻辑运算、关系运算。常用的关系运算符 &gt;、 &lt;、==、!=、&gt;=、&lt;=分别代表大于、小于、等于、不等于、大于等于、小于等于。常用的逻辑运算符 &amp;、|、！等。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#单条件筛选</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>filghts[year <span class="sc">==</span> <span class="dv">2014</span>] <span class="co">#筛选year==2014</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#多条件筛选 用 &amp; 链接</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>flights[ year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span>] </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># | 相当于中文条件或 </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>flights[ month <span class="sc">==</span> <span class="dv">5</span> <span class="sc">|</span> month <span class="sc">==</span> <span class="dv">6</span>] </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># %in% 类似sql中in用法</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>flights[month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">9</span>)] </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># %between% 类似sql中between and 用法</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>flights[month <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)]</span></code></pre></div>
</div>
<div id="j列操作" class="section level4" number="2.1.3.2">
<h4 number="2.1.3.2"><span class="header-section-number">2.1.3.2</span> j列操作</h4>
<p>数据集较大、字段较多时，由于无效信息较多可以做适当精选，这时需要我们筛选列。与sql中的select用法一致，即保留想要的字段。</p>
<p>.()或list()是data.table中的比较特殊的实现列筛选的用法。常规数字索引，字符向量索引同样有效。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#注意前面的. .()</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>flights[,.(year,month,day,dep_delay,carrier,origin)] </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         year month day dep_delay carrier origin</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      1: 2014     1   1        14      AA    JFK</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      2: 2014     1   1        -3      AA    JFK</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      3: 2014     1   1         2      AA    JFK</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      4: 2014     1   1        -8      AA    LGA</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      5: 2014     1   1         2      AA    JFK</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     ---                                        </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 253312: 2014    10  31         1      UA    LGA</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 253313: 2014    10  31        -5      UA    EWR</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 253314: 2014    10  31        -8      MQ    LGA</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 253315: 2014    10  31        -4      MQ    LGA</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 253316: 2014    10  31        -5      MQ    LGA</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># flights[,list(year,month,day,dep_delay,carrier,origin)]  same above</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># flights[,1:3]</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># flights[,c(&#39;year&#39;,&#39;month&#39;,&#39;day&#39;)]</span></span></code></pre></div>
<p>setcolorder函数可以调整列的顺序，将常用的字段信息排在前面可以用过该函数实现。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># setcolorder(x = flights,neworder = c( &quot;month&quot;,&quot;day&quot;,&quot;dep_delay&quot; ,&quot;arr_delay&quot;,&quot;carrier&quot; )) </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 按照指定列顺序排序 其余字段保持不变,不是建立副本,是直接修改了flights 数据的列顺序</span></span></code></pre></div>
<ul>
<li>常规计算</li>
</ul>
<p>根据最开始的Excel透视表截图，我们想要获得如截图一样的结果该怎么实现呢？代码如下：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>flights[year<span class="sc">==</span><span class="dv">2014</span> <span class="sc">&amp;</span> month<span class="sc">==</span><span class="dv">6</span>,.(求和项<span class="at">distance=</span><span class="fu">sum</span>(distance),平均距离<span class="ot">=</span><span class="fu">mean</span>(distance)),by<span class="ot">=</span>.(origin,dest)]</span></code></pre></div>
<p>在i的位置做筛选，j的位置做计算，by指定分组字段。在j的位置可以做各种各样的计算，R中自带的函数，或者是自己定义的函数。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>flights[year<span class="sc">==</span><span class="dv">2014</span> <span class="sc">&amp;</span> month<span class="sc">==</span><span class="dv">6</span>,.(<span class="fu">myfun</span>(distance)),by<span class="ot">=</span>.(origin,dest)]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        origin dest      V1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     1:    JFK  LAX 3062813</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     2:    JFK  LAX 3062813</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     3:    JFK  LAX 3062813</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     4:    JFK  LAX 3062813</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     5:    JFK  LAX 3062813</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    ---                    </span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26484:    JFK  HYA   19208</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26485:    JFK  HYA   19208</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26486:    JFK  HYA   19208</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26487:    JFK  HYA   19208</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26488:    JFK  HYA   19208</span></span></code></pre></div>
</div>
<div id="by-分组" class="section level4" number="2.1.3.3">
<h4 number="2.1.3.3"><span class="header-section-number">2.1.3.3</span> by 分组</h4>
<p>分组是按照某种分组实现一定条件下某种聚合方式的计算。分组可以是单字段，多字段以及条件字段等。</p>
<p>1.按月分组</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>flights[,.(<span class="fu">sum</span>(distance)),by<span class="ot">=</span>.(month)]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     month       V1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:     1 25112563</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:     2 22840391</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:     3 28716598</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:     4 27816797</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:     5 28030020</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:     6 29093557</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:     7 30059175</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:     8 30322047</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:     9 27615097</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    10 28900834</span></span></code></pre></div>
<p>2.多条件分组</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> flights[,.(<span class="fu">sum</span>(distance)),by<span class="ot">=</span>.(carrier,origin)]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    carrier origin       V1</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:      AA    JFK 20492213</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:      AA    LGA 12365282</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:      AA    EWR  3550217</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:      AS    EWR  1378748</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:      B6    JFK 38117662</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:      B6    EWR  4508574</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#可直接重新命名</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> flights[,.(<span class="fu">sum</span>(distance)),by<span class="ot">=</span>.(<span class="at">newcol1 =</span> carrier,<span class="at">newcol2 =</span> origin)]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    newcol1 newcol2       V1</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:      AA     JFK 20492213</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:      AA     LGA 12365282</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:      AA     EWR  3550217</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:      AS     EWR  1378748</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:      B6     JFK 38117662</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:      B6     EWR  4508574</span></span></code></pre></div>
<p>3.按月份是否大于6分组</p>
<p>即得到是否大于6的两类分组</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> flights[,.(<span class="fu">sum</span>(distance)),by<span class="ot">=</span>.(month<span class="sc">&gt;</span><span class="dv">6</span>)] <span class="co">#by里面可以做计算</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    month        V1</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: FALSE 161609926</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:  TRUE 116897153</span></span></code></pre></div>
</div>
</div>
<div id="行列筛选总结" class="section level3" number="2.1.4">
<h3 number="2.1.4"><span class="header-section-number">2.1.4</span> 行列筛选总结</h3>
<p>行筛选在 i 的位置上进行, 列筛选在 j 的位置上进行;data.table中j的位置比较灵活多变，但是i的位置大部分时候都是进行条件筛选。我们通过上述的行列筛选已经大概知道data.table中i,j的用法。也就是我们常规数据清洗过程中的数据筛选过程，筛选符合要求的数据记录。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> flights[ year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span> <span class="sc">&amp;</span> day <span class="sc">&gt;=</span><span class="dv">15</span>,.(year,month,day,dep_delay,carrier,origin)] </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    year month day dep_delay carrier origin</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 2014     6  15        -4      AA    JFK</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 2014     6  15        -8      AA    JFK</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 2014     6  15       -12      AA    JFK</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: 2014     6  15        -4      AA    LGA</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: 2014     6  15        -3      AA    JFK</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: 2014     6  15         5      AA    JFK</span></span></code></pre></div>
</div>
</div>
<div id="常规操作" class="section level2" number="2.2">
<h2 number="2.2"><span class="header-section-number">2.2</span> 常规操作</h2>
<div id="新增更新列" class="section level3" number="2.2.1">
<h3 number="2.2.1"><span class="header-section-number">2.2.1</span> 新增更新列</h3>
<p>新增或删除或更新列是我们数据清洗过程中的常规操作，<code>data.table中</code>实现该类功能是通过<code>:=</code>符号实现。</p>
<ul>
<li>新增</li>
</ul>
<p>如下所示:新增addcol列，最后的[]是为了显示新增列的数据框,可不增加。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data.table()函数创建data.table数据框</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">col1=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">col2=</span>letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],<span class="at">col3=</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],<span class="at">col4=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 新增列 :=</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>dt[,addcol<span class="sc">:</span><span class="er">=</span><span class="fu">rep</span>(<span class="st">&#39;新列&#39;</span>,<span class="dv">10</span>)][] <span class="co">#最后的[]是为了显示新增列的数据框,可不增加</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col1 col2 col3 col4 addcol</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    1    a    A    1   新列</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    2    b    B    2   新列</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    3    c    C    3   新列</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    4    d    D    4   新列</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    5    e    E    5   新列</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    6    f    F    6   新列</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    7    g    G    7   新列</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    8    h    H    8   新列</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    9    i    I    9   新列</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:   10    j    J   10   新列</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">#dt[,addcol:=rep(&#39;新列&#39;,10)] 不会显示返回结果,加上[]会显示返回</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 新增多列</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">newcol1=</span><span class="fu">rep</span>(<span class="st">&#39;newcol1&#39;</span>,<span class="dv">10</span>),<span class="at">newcol2=</span><span class="fu">rep</span>(<span class="st">&#39;newcol2&#39;</span>,<span class="dv">10</span>))][]</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col1 col2 col3 col4 addcol newcol1 newcol2</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    1    a    A    1   新列 newcol1 newcol2</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    2    b    B    2   新列 newcol1 newcol2</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    3    c    C    3   新列 newcol1 newcol2</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    4    d    D    4   新列 newcol1 newcol2</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    5    e    E    5   新列 newcol1 newcol2</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    6    f    F    6   新列 newcol1 newcol2</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    7    g    G    7   新列 newcol1 newcol2</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    8    h    H    8   新列 newcol1 newcol2</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    9    i    I    9   新列 newcol1 newcol2</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:   10    j    J   10   新列 newcol1 newcol2</span></span></code></pre></div>
<ul>
<li>删除</li>
</ul>
<p>删除列即将列赋值NULL即可</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 删除列</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dt[,col1<span class="sc">:</span><span class="er">=</span><span class="cn">NULL</span>][]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col2 col3 col4 addcol newcol1 newcol2</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    a    A    1   新列 newcol1 newcol2</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    b    B    2   新列 newcol1 newcol2</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    c    C    3   新列 newcol1 newcol2</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    d    D    4   新列 newcol1 newcol2</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    e    E    5   新列 newcol1 newcol2</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    f    F    6   新列 newcol1 newcol2</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    g    G    7   新列 newcol1 newcol2</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    h    H    8   新列 newcol1 newcol2</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    i    I    9   新列 newcol1 newcol2</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    j    J   10   新列 newcol1 newcol2</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 删除多列</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>dt[,<span class="fu">c</span>(<span class="st">&#39;newcol1&#39;</span>,<span class="st">&#39;newcol2&#39;</span>)<span class="sc">:</span><span class="er">=</span><span class="cn">NULL</span>][]</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col2 col3 col4 addcol</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    a    A    1   新列</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    b    B    2   新列</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    c    C    3   新列</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    d    D    4   新列</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    e    E    5   新列</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    f    F    6   新列</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    g    G    7   新列</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    h    H    8   新列</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    i    I    9   新列</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    j    J   10   新列</span></span></code></pre></div>
<ul>
<li>更新</li>
</ul>
<p>更新即重新赋值，将现有列参与计算等于是重新赋值，可以看成是更新列。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 更新列</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>dt[,col1<span class="sc">:</span><span class="er">=</span><span class="dv">11</span><span class="sc">:</span><span class="dv">20</span>][]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col2 col3 col4 addcol col1</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    a    A    1   新列   11</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    b    B    2   新列   12</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    c    C    3   新列   13</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    d    D    4   新列   14</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    e    E    5   新列   15</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    f    F    6   新列   16</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    g    G    7   新列   17</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    h    H    8   新列   18</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    i    I    9   新列   19</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    j    J   10   新列   20</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># not run </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 两列间计算 也可以理解为更新</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>dt[,newcol<span class="sc">:</span><span class="er">=</span>col1<span class="sc">/</span>col4]</span></code></pre></div>
</div>
<div id="排序" class="section level3" number="2.2.2">
<h3 number="2.2.2"><span class="header-section-number">2.2.2</span> 排序</h3>
<p>当我们清洗数据时，我们需要将数据框排序，我们可以使用<code>setorder</code>或<code>setorderv</code>函数实现排序。函数是<code>data.table</code>包的函数，比base R 中的<code>order</code>函数要节省内存。
注意：按照函数文档说法：Note that queries like x[order(.)] are optimised internally to use data.table’s fast order。即x[order(.)]这样的用法会被优化为data.table的排序方法。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(45L)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">A=</span><span class="fu">sample</span>(<span class="dv">3</span>, <span class="dv">10</span>, <span class="cn">TRUE</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">B=</span><span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="dv">10</span>, <span class="cn">TRUE</span>), <span class="at">C=</span><span class="fu">sample</span>(<span class="dv">10</span>))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(DT, A, <span class="sc">-</span>B) <span class="co">#将DT按照A、B排序 A 升序,-B降序</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 和上面同样的效果 但是函数变成 setorderv</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">setorderv</span>(DT, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span></code></pre></div>
</div>
<div id="行筛选" class="section level3" number="2.2.3">
<h3 number="2.2.3"><span class="header-section-number">2.2.3</span> 行筛选</h3>
<p>上文已经大致讲过行筛选，但是行筛选使用有一定的技巧，涉及到运算的快慢。主要是逻辑条件的设置，交集并集之间的差异。除了上文中的关系运算筛选，逻辑运算筛选除外，data.table中还有几个常用的筛选函数。</p>
<ul>
<li>数字向量筛选</li>
</ul>
<p>%in%用法与 sql 中 in 用法类似。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 筛选 %in% </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>flights[ hour <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">24</span>,<span class="dv">2</span>) ]</span></code></pre></div>
<ul>
<li>字符向量筛选</li>
</ul>
<p>%chin%用法与 %in% 类似，但仅仅针对字符。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 字符筛选</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>flights[ origin <span class="sc">%chin%</span> <span class="fu">c</span>(<span class="st">&#39;JFK&#39;</span>,<span class="st">&#39;LGA&#39;</span>)]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># not run 同上 %chin% 对字符速度筛选速度更快</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#flights[ origin %in% c(&#39;JFK&#39;,&#39;LGA&#39;)]</span></span></code></pre></div>
<ul>
<li>between 筛选</li>
</ul>
<p>该函数的新特性矢量化挺实用。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#between 函数参数</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#between(x, lower, upper, incbounds=TRUE, NAbounds=TRUE, check=FALSE)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="at">a=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">b=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">c=</span><span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>X[b <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">9</span>)]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    a b c</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 2 7 4</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 3 8 3</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 4 9 2</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>X[<span class="fu">between</span>(b, <span class="dv">7</span>, <span class="dv">9</span>)] <span class="co">#效果同上</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    a b c</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 2 7 4</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 3 8 3</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 4 9 2</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>X[c <span class="sc">%between%</span> <span class="fu">list</span>(a,b)] <span class="co"># 矢量化</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    a b c</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 1 6 5</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 2 7 4</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 3 8 3</span></span></code></pre></div>
<ul>
<li>like 筛选</li>
</ul>
<p>%like% 用法与SQL中 like 类似。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %like% 用法与SQL中 like 类似</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">Name=</span><span class="fu">c</span>(<span class="st">&quot;Mary&quot;</span>,<span class="st">&quot;George&quot;</span>,<span class="st">&quot;Martha&quot;</span>), <span class="at">Salary=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>DT[Name <span class="sc">%like%</span> <span class="st">&quot;^Mar&quot;</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      Name Salary</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:   Mary      2</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: Martha      4</span></span></code></pre></div>
</div>
<div id="特殊符号" class="section level3" number="2.2.4">
<h3 number="2.2.4"><span class="header-section-number">2.2.4</span> 特殊符号</h3>
<p>.SD,.BY,.N,.I,.NGRP和.GRP,.SDcols等,只能用在 j 的位置,.N 可以用在 i 的位置.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">x=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;b&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;c&quot;</span>),<span class="at">each=</span><span class="dv">3</span>), <span class="at">v=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">y=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">6</span>), <span class="at">a=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">b=</span><span class="dv">9</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>DT</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v y a b</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 1 1 1 9</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: b 1 3 2 8</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: b 1 6 3 7</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: a 2 1 4 6</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: a 2 3 5 5</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: a 1 6 6 4</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7: c 1 1 7 3</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8: c 2 3 8 2</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9: c 2 6 9 1</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="st">&quot;c&quot;</span>,<span class="st">&quot;b&quot;</span>), <span class="at">v=</span><span class="dv">8</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">foo=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">2</span>))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>X</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v foo</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: c 8   4</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: b 7   2</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 用在i的位置</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>DT[.N] <span class="co">#取DT最后一行,.N 计数函数</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v y a b</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: c 2 6 9 1</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>DT[,.N] <span class="co">#DT 共有多少行记录 返回一个整数</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 9</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>DT[, .N, by<span class="ot">=</span>x]  <span class="co">#分组计数</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x N</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 3</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: a 3</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: c 3</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>DT[, .SD, .SDcols<span class="ot">=</span>x<span class="sc">:</span>y]  <span class="co"># 选择x 到y 列</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v y</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 1 1</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: b 1 3</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: b 1 6</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: a 2 1</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: a 2 3</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: a 1 6</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7: c 1 1</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8: c 2 3</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9: c 2 6</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="co">#DT[, .SD, .SDcols=c(&quot;x&quot;,&quot;y&quot;)] 与上面不一样</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>DT[, .SD[<span class="dv">1</span>]] <span class="co">#取第一行</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v y a b</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 1 1 1 9</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>DT[, .SD[<span class="dv">1</span>], by<span class="ot">=</span>x] <span class="co">#按x列分组后</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x v y a b</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 1 1 1 9</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: a 2 1 4 6</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: c 1 1 7 3</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>DT[, <span class="fu">c</span>(.N, <span class="fu">lapply</span>(.SD, sum)), by<span class="ot">=</span>x] <span class="co">#按照x分组后 行数计数和每列求和</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x N v  y  a  b</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b 3 3 10  6 24</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: a 3 5 10 15 15</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: c 3 5 10 24  6</span></span></code></pre></div>
</div>
</div>
<div id="常用函数" class="section level2" number="2.3">
<h2 number="2.3"><span class="header-section-number">2.3</span> 常用函数</h2>
<div id="排序函数-frank" class="section level3" number="2.3.1">
<h3 number="2.3.1"><span class="header-section-number">2.3.1</span> 排序函数 frank</h3>
<p><code>frank</code>和<code>frankv</code>函数参数如下：</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">frank</span>(x, ..., <span class="at">na.last=</span><span class="cn">TRUE</span>, <span class="at">ties.method=</span><span class="fu">c</span>(<span class="st">&quot;average&quot;</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;first&quot;</span>, <span class="st">&quot;last&quot;</span>, <span class="st">&quot;random&quot;</span>, <span class="st">&quot;max&quot;</span>, <span class="st">&quot;min&quot;</span>, <span class="st">&quot;dense&quot;</span>))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x, <span class="at">cols=</span><span class="fu">seq_along</span>(x), <span class="at">order=</span>1L, <span class="at">na.last=</span><span class="cn">TRUE</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties.method=</span><span class="fu">c</span>(<span class="st">&quot;average&quot;</span>, <span class="st">&quot;first&quot;</span>, <span class="st">&quot;random&quot;</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;max&quot;</span>, <span class="st">&quot;min&quot;</span>, <span class="st">&quot;dense&quot;</span>))</span></code></pre></div>
<p>官方案例,如下所示:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># on vectors</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">4</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># NAs are considered identical (unlike base R)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># default is average</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x) <span class="co"># na.last=TRUE</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0 6.5 1.5 6.5 4.0</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x, <span class="at">na.last=</span><span class="cn">FALSE</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 6.0 3.5 6.0 1.5 3.5 1.5 6.0</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># on data.table</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(x, <span class="at">y=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="cn">NA</span>, <span class="dv">0</span>, <span class="dv">2</span>))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(DT, <span class="at">cols=</span><span class="st">&quot;x&quot;</span>) <span class="co"># same as frankv(x) from before</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0 6.5 1.5 6.5 4.0</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(DT, <span class="at">cols=</span><span class="st">&quot;x&quot;</span>, <span class="at">na.last=</span><span class="st">&quot;keep&quot;</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0  NA 1.5  NA 4.0</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(DT, <span class="at">cols=</span><span class="st">&quot;x&quot;</span>, <span class="at">ties.method=</span><span class="st">&quot;dense&quot;</span>, <span class="at">na.last=</span><span class="cn">NA</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 2 1 2 1 2</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="fu">frank</span>(DT, x, <span class="at">ties.method=</span><span class="st">&quot;dense&quot;</span>, <span class="at">na.last=</span><span class="cn">NA</span>) <span class="co"># equivalent of above using frank</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 2 1 2 1 2</span></span></code></pre></div>
<ul>
<li>frankv在排序时,NA被认为是一样的,基础base R 中认为不一样.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span>  <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">4</span>) </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0 6.5 1.5 6.5 4.0</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rank</span>(x)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0 6.0 1.5 7.0 4.0</span></span></code></pre></div>
<ul>
<li>升序降序选择</li>
</ul>
<p>order参数只能为1或者-1.默认为1代表升序</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">order =</span> 1L)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4.0 1.5 4.0 6.5 1.5 6.5 4.0</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">order =</span> <span class="sc">-</span>1L)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 2.0 4.5 2.0 6.5 4.5 6.5 2.0</span></span></code></pre></div>
<ul>
<li>排序方式选择</li>
</ul>
<p>默认 average,还有dense,random,first,last,max,min等方式。其中dense是紧凑排名，random是随机让相同的随机排列后排名</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x)  <span class="co">#大小相同 排名相同,下一位排名除以2</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">ties.method =</span> <span class="st">&#39;min&#39;</span>)  <span class="co">#大小相同 排名相同,取最小排名</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">ties.method =</span> <span class="st">&#39;max&#39;</span>)  <span class="co">#大小相同 排名相同,取最大排名</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">ties.method =</span> <span class="st">&#39;first&#39;</span>) <span class="co">#相同大小排名以后往后递增 根据实际情况决定</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">ties.method =</span> <span class="st">&#39;dense&#39;</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(x,<span class="at">ties.method =</span> <span class="st">&#39;random&#39;</span>)</span></code></pre></div>
<ul>
<li>NA处理</li>
</ul>
<p>默认是将NA排在最后,NAs是相同的，与base R 不一样。</p>
<p>na.last参数等于TRUE时，缺失值被排最后；如果等于FALSE,放在前面；如果等于NA，将被移除；如果等于“keep,”将会保留NA.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">na.last =</span> <span class="cn">TRUE</span>,<span class="at">ties.method =</span> <span class="st">&#39;first&#39;</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 4 5 1 2 3</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">na.last =</span> <span class="cn">FALSE</span>,<span class="at">ties.method =</span> <span class="st">&#39;first&#39;</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1 2 3 4 5</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">na.last =</span> <span class="cn">NA</span>,<span class="at">ties.method =</span> <span class="st">&#39;first&#39;</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1 2 3</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">frankv</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">na.last =</span> <span class="st">&#39;keep&#39;</span>,<span class="at">ties.method =</span> <span class="st">&#39;first&#39;</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] NA NA  1  2  3</span></span></code></pre></div>
</div>
<div id="判断函数" class="section level3" number="2.3.2">
<h3 number="2.3.2"><span class="header-section-number">2.3.2</span> 判断函数</h3>
<ul>
<li>fifelse</li>
</ul>
<p>fifelse()类似<code>dplyr::if_else()</code>函数,相比base::ifelse() 更快。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span>  <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">5</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fifelse</span>(x <span class="sc">&gt;</span> 2L, x, x <span class="sc">-</span> 1L)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 0 1 3 4 3 1 0 1 3 4 5</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fifelse</span>(x <span class="sc">&gt;</span> 2L,<span class="fu">fifelse</span>(x <span class="sc">&gt;=</span> 4L,x <span class="sc">+</span> 1L,x),x<span class="sc">-</span>1L)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 0 1 3 5 3 1 0 1 3 5 6</span></span></code></pre></div>
<ul>
<li>fcase</li>
</ul>
<p>与sql中的case when，与dplyr中的<code>case_when()</code>函数用法相似。相比fifelse相比，嵌套更加方便。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fcase</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">&lt;</span> 5L, 1L,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">&gt;</span> 5L, 3L</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1]  1  1  1  1 NA  3  3  3  3  3</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># not run 两种函数实现方式</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="fu">fifelse</span>(x <span class="sc">&gt;</span> <span class="dv">5</span>,<span class="fu">fifelse</span>(x <span class="sc">&gt;</span><span class="dv">8</span>,<span class="dv">2</span>,<span class="dv">1</span>),<span class="dv">0</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 0 0 0 0 0 1 1 1 2 2</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fcase</span>(</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">&gt;</span> <span class="dv">8</span>,<span class="dv">2</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">&gt;</span> <span class="dv">5</span>,<span class="dv">1</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="dv">0</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 0 0 0 0 0 1 1 1 2 2</span></span></code></pre></div>
</div>
<div id="交集-差集-合并" class="section level3" number="2.3.3">
<h3 number="2.3.3"><span class="header-section-number">2.3.3</span> 交集 差集 合并</h3>
<p>相当于base R 中 union(),intersect(),setdiff() 和setequal() 功能.all参数控制如何处理重复的行,和SQL中不同的是,data.table将保留行顺序.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fintersect</span>(x, y, <span class="at">all =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetdiff</span>(x, y, <span class="at">all =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">funion</span>(x, y, <span class="at">all =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetequal</span>(x, y, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) <span class="co"># same set of rows as x</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fintersect</span>(x, y)            <span class="co"># intersect</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">fintersect</span>(x, y, <span class="at">all=</span><span class="cn">TRUE</span>)  <span class="co"># intersect all</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetdiff</span>(x, y)              <span class="co"># except</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetdiff</span>(x, y, <span class="at">all=</span><span class="cn">TRUE</span>)    <span class="co"># except all</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="fu">funion</span>(x, y)                <span class="co"># union</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="fu">funion</span>(x, y, <span class="at">all=</span><span class="cn">TRUE</span>)      <span class="co"># union all</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetequal</span>(x, x2, <span class="at">all=</span><span class="cn">FALSE</span>) <span class="co"># setequal</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="fu">fsetequal</span>(x, x2)            <span class="co"># setequal all</span></span></code></pre></div>
</div>
<div id="连接" class="section level3" number="2.3.4">
<h3 number="2.3.4"><span class="header-section-number">2.3.4</span> 连接</h3>
<p>两个数据框之间左连,右连等操作,类似数据库中的left_join right_join,inner_join 等函数.</p>
<p>键入?merge()查看函数帮助,data.table 包中和base R 中都有merge 函数,当第一个数据框是data.table格式时启用data.table::merge().</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>?<span class="fu">merge</span>()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>(x, y, <span class="at">by =</span> <span class="cn">NULL</span>, <span class="at">by.x =</span> <span class="cn">NULL</span>, <span class="at">by.y =</span> <span class="cn">NULL</span>, <span class="at">all =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="at">all.x =</span> all, <span class="at">all.y =</span> all, <span class="at">sort =</span> <span class="cn">TRUE</span>, <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">&quot;.x&quot;</span>, <span class="st">&quot;.y&quot;</span>), <span class="at">no.dups =</span> <span class="cn">TRUE</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="at">allow.cartesian=</span><span class="fu">getOption</span>(<span class="st">&quot;datatable.allow.cartesian&quot;</span>),  <span class="co"># default FALSE</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>...)</span></code></pre></div>
<p>x.y为连个数据框,当两个数据框连接字段相同时,用by=c(’‘,’’)连接,不同时采用,by.x=,by.y= ,all,all.x,all.y等参数决定连接方式,sort 默认为排序,当不需要排序时更改参数,allow.cartesian=是否允许笛卡尔,默认不允许,当需要时设置为TURE.</p>
</div>
<div id="透视表功能" class="section level3" number="2.3.5">
<h3 number="2.3.5"><span class="header-section-number">2.3.5</span> 透视表功能</h3>
<p>主要是两个函数<code>dcast</code>以及<code>melt</code>实现长宽转换，实现Excel中部分透视表功能。具体的函数参数请自行查阅文档。</p>
<ul>
<li>dcast函数能实现长转宽</li>
</ul>
<p>参数如下：fun.aggregate函数指定聚合函数，value.var参数指定参与聚合的字段。formula指定聚合维度，格式用x+y~z，其中x,y在行的位置，z在列的位置。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dcast</span>(data, formula, <span class="at">fun.aggregate =</span> <span class="cn">NULL</span>, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    ..., <span class="at">margins =</span> <span class="cn">NULL</span>, <span class="at">subset =</span> <span class="cn">NULL</span>, <span class="at">fill =</span> <span class="cn">NULL</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">value.var =</span> <span class="fu">guess</span>(data),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">&quot;datatable.verbose&quot;</span>))</span></code></pre></div>
<p>示例如下：</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(分公司<span class="ot">=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;华东&#39;</span>,<span class="st">&#39;华南&#39;</span>,<span class="st">&#39;华西&#39;</span>,<span class="st">&#39;华北&#39;</span>),<span class="dv">1000</span>),</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>              季度<span class="ot">=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;一季度&#39;</span>,<span class="st">&#39;二季度&#39;</span>,<span class="st">&#39;三季度&#39;</span>,<span class="st">&#39;四季度&#39;</span>),<span class="dv">1000</span>),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>              销售额<span class="ot">=</span><span class="fu">sample</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">200</span>,<span class="dv">4000</span>,<span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dcast</span>(dt,分公司<span class="sc">~</span>季度,<span class="at">value.var =</span> <span class="st">&quot;销售额&quot;</span>,<span class="at">fun.aggregate =</span> sum)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    分公司 一季度 三季度 二季度 四季度</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:   华东 149135      0      0      0</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:   华北      0      0      0 150585</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:   华南      0      0 149451      0</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:   华西      0 150649      0      0</span></span></code></pre></div>
<p>从版本V1.9.6起可以同时对多个值实现不同聚合后的长转宽。</p>
<p>fun参数即 fun.aggregate的简写，可以是自定义的函数。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="at">x=</span><span class="fu">sample</span>(<span class="dv">5</span>,<span class="dv">20</span>,<span class="cn">TRUE</span>), <span class="at">y=</span><span class="fu">sample</span>(<span class="dv">2</span>,<span class="dv">20</span>,<span class="cn">TRUE</span>),</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">z=</span><span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">20</span>,<span class="cn">TRUE</span>), <span class="at">d1 =</span> <span class="fu">runif</span>(<span class="dv">20</span>), <span class="at">d2=</span>1L)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dcast</span>(dt, x <span class="sc">+</span> y <span class="sc">~</span> z, <span class="at">fun=</span><span class="fu">list</span>(sum,mean), <span class="at">value.var=</span><span class="fu">c</span>(<span class="st">&quot;d1&quot;</span>,<span class="st">&quot;d2&quot;</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x y d1_sum_a d1_sum_b d2_sum_a d2_sum_b d1_mean_a d1_mean_b d2_mean_a</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 1 1    0.000   0.3141        0        1       NaN    0.3141       NaN</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 1 2    0.675   0.7524        1        1     0.675    0.7524         1</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 2 1    0.722   1.9725        1        3     0.722    0.6575         1</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: 2 2    1.062   0.0657        2        1     0.531    0.0657         1</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: 3 2    0.329   0.0000        1        0     0.329       NaN         1</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: 4 1    1.934   0.3536        3        1     0.645    0.3536         1</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7: 4 2    1.968   0.0000        3        0     0.656       NaN         1</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8: 5 2    0.404   0.8995        1        1     0.404    0.8995         1</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    d2_mean_b</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:         1</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:         1</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:         1</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:         1</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:       NaN</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:         1</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7:       NaN</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8:         1</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="fu">dcast</span>(dt, x <span class="sc">+</span> y <span class="sc">~</span> z, <span class="at">fun=</span><span class="fu">list</span>(sum,mean), <span class="at">value.var=</span><span class="fu">list</span>(<span class="st">&quot;d1&quot;</span>,<span class="st">&quot;d2&quot;</span>)) <span class="co">#注意value.var是向量和列表时的区别</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x y d1_sum_a d1_sum_b d2_mean_a d2_mean_b</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: 1 1    0.000   0.3141       NaN         1</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: 1 2    0.675   0.7524         1         1</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: 2 1    0.722   1.9725         1         1</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: 2 2    1.062   0.0657         1         1</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: 3 2    0.329   0.0000         1       NaN</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: 4 1    1.934   0.3536         1         1</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7: 4 2    1.968   0.0000         1       NaN</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8: 5 2    0.404   0.8995         1         1</span></span></code></pre></div>
<ul>
<li>melt函数实现宽转长</li>
</ul>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">melt</span>(data, id.vars, measure.vars,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable.name =</span> <span class="st">&quot;variable&quot;</span>, <span class="at">value.name =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    ..., <span class="at">na.rm =</span> <span class="cn">FALSE</span>, <span class="at">variable.factor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value.factor =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">&quot;datatable.verbose&quot;</span>))</span></code></pre></div>
<p>示例如下:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ChickWeight <span class="ot">=</span> <span class="fu">as.data.table</span>(ChickWeight)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(ChickWeight, <span class="fu">tolower</span>(<span class="fu">names</span>(ChickWeight)))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(<span class="fu">as.data.table</span>(ChickWeight), <span class="at">id=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>) <span class="co"># calls melt.data.table</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>DT</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      time chick diet variable value</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   1:    0     1    1   weight    42</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   2:    2     1    1   weight    51</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   3:    4     1    1   weight    59</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   4:    6     1    1   weight    64</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   5:    8     1    1   weight    76</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  ---                               </span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 574:   14    50    4   weight   175</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 575:   16    50    4   weight   205</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 576:   18    50    4   weight   234</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 577:   20    50    4   weight   264</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 578:   21    50    4   weight   264</span></span></code></pre></div>
</div>
<div id="非重复计数" class="section level3" number="2.3.6">
<h3 number="2.3.6"><span class="header-section-number">2.3.6</span> 非重复计数</h3>
<p><code>uniqueN</code>相当于<code>length(unique(x))</code>,但是计算更快，内存效率更高。</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="dv">50</span>,<span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">uniqueN</span>(x)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">A =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each=</span><span class="dv">4</span>), <span class="at">B =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">each=</span><span class="dv">3</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">C =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">6</span>), <span class="at">key =</span> <span class="st">&quot;A,B&quot;</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">uniqueN</span>(DT, <span class="at">by =</span> <span class="fu">key</span>(DT))</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 6</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">uniqueN</span>(DT)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span></code></pre></div>
</div>
<div id="rleid" class="section level3" number="2.3.7">
<h3 number="2.3.7"><span class="header-section-number">2.3.7</span> rleid</h3>
<p>该函数根据分组生成长度列。</p>
<p>即将0011001110111101类似这种分组成1 1 2 2 3 3 4 4 4 5 6 6 6 6 7 8。在特定时候是很便捷的一个函数。如在计算股票连续上涨或下跌天数时。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rleid</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 1 1 2 2 3 3 4 4 4 5 6 6 6 6 7 8</span></span></code></pre></div>
<p>参数如下所示：</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rleid</span>(..., <span class="at">prefix=</span><span class="cn">NULL</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rleidv</span>(x, <span class="at">cols=</span><span class="fu">seq_along</span>(x), <span class="at">prefix=</span><span class="cn">NULL</span>)</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">grp=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>)), <span class="at">value=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rleid</span>(DT<span class="sc">$</span>grp) <span class="co"># get run-length ids</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 1 1 2 2 3 3 3 4 5 5</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rleidv</span>(DT, <span class="st">&quot;grp&quot;</span>) <span class="co"># same as above</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] 1 1 2 2 3 3 3 4 5 5</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rleid</span>(DT<span class="sc">$</span>grp, <span class="at">prefix=</span><span class="st">&quot;grp&quot;</span>) <span class="co"># prefix with &#39;grp&#39;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;grp1&quot; &quot;grp1&quot; &quot;grp2&quot; &quot;grp2&quot; &quot;grp3&quot; &quot;grp3&quot; &quot;grp3&quot; &quot;grp4&quot; &quot;grp5&quot; &quot;grp5&quot;</span></span></code></pre></div>
</div>
<div id="shift" class="section level3" number="2.3.8">
<h3 number="2.3.8"><span class="header-section-number">2.3.8</span> shift</h3>
<p>向前或向后功能,通俗来说就是像前或向后移动位置。示例如下：</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lag with n=1 and pad with NA (returns vector)</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">shift</span>(x, <span class="at">n=</span><span class="dv">1</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">type=</span><span class="st">&quot;lag&quot;</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] NA  1  2  3  4</span></span></code></pre></div>
<p>其中参数n控制偏移量，n正负数和type的参数相对应。, n=-1 and type=‘lead’ 与 n=1 and type=’lag’效果相同。</p>
<p>在data.table上使用：</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">year=</span><span class="dv">2010</span><span class="sc">:</span><span class="dv">2014</span>, <span class="at">v1=</span><span class="fu">runif</span>(<span class="dv">5</span>), <span class="at">v2=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">v3=</span>letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;v1&quot;</span>,<span class="st">&quot;v2&quot;</span>,<span class="st">&quot;v3&quot;</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>anscols <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;lead&quot;</span>, cols, <span class="at">sep=</span><span class="st">&quot;_&quot;</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>DT[, (anscols) <span class="sc">:</span><span class="er">=</span> <span class="fu">shift</span>(.SD, <span class="dv">1</span>, <span class="dv">0</span>, <span class="st">&quot;lead&quot;</span>), .SDcols<span class="ot">=</span>cols]</span></code></pre></div>
</div>
</div>
<div id="运用" class="section level2" number="2.4">
<h2 number="2.4"><span class="header-section-number">2.4</span> 运用</h2>
<div id="自定义函数计算" class="section level3" number="2.4.1">
<h3 number="2.4.1"><span class="header-section-number">2.4.1</span> 自定义函数计算</h3>
<p>1.自定义函数处理列</p>
<p>按照自定义函数计算修改单列或多列</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 测试函数</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>fun <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">&lt;-</span>  <span class="fu">data.table</span>(<span class="at">x=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;b&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;c&quot;</span>),<span class="at">each=</span><span class="dv">3</span>), <span class="at">v=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">y=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">6</span>), <span class="at">a=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">b=</span><span class="dv">9</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>DT[,.(<span class="at">newcol=</span><span class="fu">fun</span>(y)),by<span class="ot">=</span>.(x)]</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x newcol</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: b      2</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: b     10</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: b     37</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4: a      2</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5: a     10</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6: a     37</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7: c      2</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8: c     10</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9: c     37</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Not run</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="co">#DT[,lapply(.SD,fun),.SDcols=c(&#39;y&#39;,&#39;a&#39;),by=.(x)] #多列参与计算</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 批量修改列</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="co">#Not run</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="co"># myfun &lt;- function(x){</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(x)</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="co"># dt &lt;- dt[,colnames(dt):=lapply(.SD[,1:ncol(dt)],myfun)] #很重要的用法</span></span></code></pre></div>
</div>
<div id="带汇总的聚合运算" class="section level3" number="2.4.2">
<h3 number="2.4.2"><span class="header-section-number">2.4.2</span> 带汇总的聚合运算</h3>
<p>按照by的字段级别汇总.</p>
<ol style="list-style-type: decimal">
<li>rollup</li>
</ol>
<p>分组聚合后设置id=TRUE将各个级别的汇总显示清晰,当by字段只有一个是和正常聚合计算没有区别.以下是官方案例.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Usage</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#rollup(x, j, by, .SDcols, id = FALSE, ...)</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> 24L</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">25</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;green&quot;</span>,<span class="st">&quot;yellow&quot;</span>,<span class="st">&quot;red&quot;</span>), n, <span class="cn">TRUE</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">as.Date</span>(<span class="fu">sample</span>(<span class="fu">paste0</span>(<span class="dv">2011</span><span class="sc">:</span><span class="dv">2015</span>,<span class="st">&quot;-01-01&quot;</span>), n, <span class="cn">TRUE</span>)),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">as.factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;removed&quot;</span>,<span class="st">&quot;active&quot;</span>,<span class="st">&quot;inactive&quot;</span>,<span class="st">&quot;archived&quot;</span>), n, <span class="cn">TRUE</span>)),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">amount =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n, <span class="cn">TRUE</span>),</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="fl">3.5</span>, <span class="fl">2.5</span>, <span class="dv">2</span>), n, <span class="cn">TRUE</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rollup</span>(DT, <span class="at">j =</span> <span class="fu">sum</span>(value), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;color&quot;</span>,<span class="st">&quot;year&quot;</span>,<span class="st">&quot;status&quot;</span>)) <span class="co"># default id=FALSE</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      color       year   status   V1</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    red 2015-01-01   active  3.5</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:  green 2015-01-01 inactive  5.5</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:  green 2014-01-01 archived  3.5</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:  green 2015-01-01 archived  2.0</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5: yellow 2014-01-01   active  4.5</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    red 2013-01-01 inactive  2.0</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:  green 2011-01-01   active  6.0</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    red 2014-01-01 inactive  2.5</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:  green 2011-01-01 archived  2.5</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10: yellow 2015-01-01   active  2.0</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11:    red 2012-01-01 archived  2.0</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12:    red 2011-01-01  removed  3.5</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13:  green 2014-01-01 inactive  8.0</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 14:  green 2011-01-01  removed  2.0</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 15: yellow 2012-01-01 archived  2.5</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 16:    red 2013-01-01  removed  3.5</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 17:  green 2013-01-01   active  3.0</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 18:  green 2014-01-01  removed  2.5</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 19:    red 2011-01-01 archived  3.0</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 20:    red 2015-01-01     &lt;NA&gt;  3.5</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 21:  green 2015-01-01     &lt;NA&gt;  7.5</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 22:  green 2014-01-01     &lt;NA&gt; 14.0</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 23: yellow 2014-01-01     &lt;NA&gt;  4.5</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 24:    red 2013-01-01     &lt;NA&gt;  5.5</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 25:  green 2011-01-01     &lt;NA&gt; 10.5</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26:    red 2014-01-01     &lt;NA&gt;  2.5</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 27: yellow 2015-01-01     &lt;NA&gt;  2.0</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 28:    red 2012-01-01     &lt;NA&gt;  2.0</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 29:    red 2011-01-01     &lt;NA&gt;  6.5</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 30: yellow 2012-01-01     &lt;NA&gt;  2.5</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 31:  green 2013-01-01     &lt;NA&gt;  3.0</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 32:    red       &lt;NA&gt;     &lt;NA&gt; 20.0</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 33:  green       &lt;NA&gt;     &lt;NA&gt; 35.0</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 34: yellow       &lt;NA&gt;     &lt;NA&gt;  9.0</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 35:   &lt;NA&gt;       &lt;NA&gt;     &lt;NA&gt; 64.0</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      color       year   status   V1</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="co">#rollup(DT, j = sum(value), by = c(&quot;color&quot;,&quot;year&quot;,&quot;status&quot;), id=TRUE)</span></span></code></pre></div>
<p>个人运用,实际工作中常常需要汇总项,汇总项在Excel透视表中很简单,在R中我之前是构造重复的数据源聚合汇总出现汇总项,极大浪费内存,运算速度减慢.</p>
<ul>
<li>新方法 rollup</li>
</ul>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">25</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">col1=</span><span class="fu">sample</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],N,<span class="at">replace =</span> T),<span class="at">col2=</span><span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],N,<span class="at">replace =</span> T),<span class="at">num=</span><span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rollup</span>(dt,<span class="at">j=</span><span class="fu">c</span>(<span class="fu">list</span>(<span class="fu">sum</span>(num))),<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;col1&#39;</span>,<span class="st">&#39;col2&#39;</span>))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col1 col2     V1</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    E    a  19926</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    D    a  20966</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    A    d  12927</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    A    b  20862</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    A    c  15331</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    B    d  15414</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    C    e  20794</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    D    e  16110</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    C    d  22152</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    A    a  18378</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11:    C    c  19474</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12:    E    d  18831</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13:    B    b  19941</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 14:    C    a  19652</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 15:    E    c  16734</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 16:    E    e  24137</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 17:    E    b  21988</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 18:    D    b  16607</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 19:    B    c  25720</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 20:    B    a  22109</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 21:    A    e  18724</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 22:    C    b  24323</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 23:    D    d  20508</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 24:    D    c  19668</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 25:    B    e  29224</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 26:    E &lt;NA&gt; 101616</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 27:    D &lt;NA&gt;  93859</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 28:    A &lt;NA&gt;  86222</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 29:    B &lt;NA&gt; 112408</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 30:    C &lt;NA&gt; 106395</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 31: &lt;NA&gt; &lt;NA&gt; 500500</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     col1 col2     V1</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="co">#同上 添加汇总项名称 total</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="co">#rollup(dt,j=c(list(total=sum(num))),by=c(&#39;col1&#39;,&#39;col2&#39;))</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="co">#添加id=TRUE参数,多出的grouping 列显示聚合级别</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="co">#rollup(dt,j=c(list(total=sum(num))),by=c(&#39;col1&#39;,&#39;col2&#39;),id=TRUE)</span></span></code></pre></div>
<p>2.groupingsets</p>
<p>按照指定字段聚合.包作者说相同与SQL中的 GROUPING SETS 操作.详情参照<a href="http://www.postgresql.org/docs/9.5/static/queries-table-expressions.html#QUERIES-GROUPING-SETS">postgresql</a></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">groupingsets</span>(DT, <span class="at">j =</span> <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">count=</span>.N), <span class="fu">lapply</span>(.SD, sum)), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;color&quot;</span>,<span class="st">&quot;year&quot;</span>,<span class="st">&quot;status&quot;</span>),</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">sets =</span> <span class="fu">list</span>(<span class="st">&quot;color&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;status&quot;</span>), <span class="fu">character</span>()), <span class="at">id=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    grouping  color       year   status count amount value</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:        3    red       &lt;NA&gt;     &lt;NA&gt;     7     19  20.0</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:        3  green       &lt;NA&gt;     &lt;NA&gt;    13     43  35.0</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:        3 yellow       &lt;NA&gt;     &lt;NA&gt;     4     10   9.0</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:        4   &lt;NA&gt; 2015-01-01   active     2      8   5.5</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:        4   &lt;NA&gt; 2015-01-01 inactive     2      5   5.5</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:        4   &lt;NA&gt; 2014-01-01 archived     1      3   3.5</span></span></code></pre></div>
<p>注意groupingsets函数中sets参数,用list()包裹想要聚合的字段组合,最后还有一个character(),加上该部分相当于全部聚合.当by只有一个字段时,相当于汇总.用法类似sql中“().”</p>
<p>上述语句结果等同于下面sql.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> color ,<span class="dt">year</span>, status,<span class="fu">count</span>(<span class="op">*</span>) <span class="fu">count</span>,<span class="fu">sum</span>(amount) amount,<span class="fu">sum</span>(<span class="fu">value</span>) <span class="fu">value</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> dbo.DT</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="fu">GROUPING</span> SETS(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>(color),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>(<span class="dt">year</span>,status),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>() <span class="co">---- 类似 character()</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>最后还有cube()函数,可?cube查看用法</p>
</div>
<div id="行列转变" class="section level3" number="2.4.3">
<h3 number="2.4.3"><span class="header-section-number">2.4.3</span> 行列转变</h3>
<ul>
<li>一列变多行</li>
</ul>
<p>用tstrsplit()函数实现</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">name=</span>LETTERS[<span class="dv">1</span><span class="sc">:</span>n],<span class="at">char=</span><span class="fu">rep</span>(<span class="st">&#39;我-爱-R-语-言&#39;</span>),n)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> dt[,.(<span class="at">newcol=</span><span class="fu">tstrsplit</span>(char,<span class="st">&#39;-&#39;</span>)),by<span class="ot">=</span>.(name)]</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    name newcol</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1:    A     我</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2:    A     爱</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3:    A      R</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4:    A     语</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5:    A     言</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6:    B     我</span></span></code></pre></div>
<ul>
<li>多行变一列</li>
</ul>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>res[,.(<span class="at">char=</span><span class="fu">paste0</span>(newcol,<span class="at">collapse =</span> <span class="st">&#39;-&#39;</span>)),by<span class="ot">=</span>.(name)]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     name          char</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1:    A 我-爱-R-语-言</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2:    B 我-爱-R-语-言</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3:    C 我-爱-R-语-言</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4:    D 我-爱-R-语-言</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5:    E 我-爱-R-语-言</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6:    F 我-爱-R-语-言</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7:    G 我-爱-R-语-言</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8:    H 我-爱-R-语-言</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9:    I 我-爱-R-语-言</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10:    J 我-爱-R-语-言</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co">#同上</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co">#res[,.(char=stringr::str_c(newcol,collapse = &#39;-&#39;)),by=.(name)]</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># A 我-爱-R-语-言           </span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co"># B 我-爱-R-语-言           </span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># C 我-爱-R-语-言           </span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># D 我-爱-R-语-言           </span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co"># E 我-爱-R-语-言           </span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># F 我-爱-R-语-言           </span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co"># G 我-爱-R-语-言           </span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co"># H 我-爱-R-语-言           </span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co"># I 我-爱-R-语-言           </span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co"># J 我-爱-R-语-言</span></span></code></pre></div>
<!--chapter:end:01-intro.Rmd-->
</div>
</div>
</div>
<div id="database" class="section level1" number="3">
<h1 number="3"><span class="header-section-number">3</span> database</h1>
<p>实际工作中，需要从数据库获取数据并清洗，R与数据库有多种交互方式,目前工作中打交道数据库主要是MSSQL,Oracle,mysql等,本文主要从以上数据库介绍记录“R与数据库的连接”。</p>
<p>R中与数据库交互的包主要有DBI,RODBC,RMySQL,ROracle,odbc等包。DBI库在查询或上传工作中效率比RODBC高,特别数据量较大时,上传效率差异巨大,具体<a href="https://github.com/r-dbi/odbc">差异</a>请点击查看详情。</p>
<p>即使你暂时没有用数据库，也建议你未来用数据库存储数据，尤其是当有一定数据量时;在我最开始接触数据时，数据一般保存在Excel,那时候数据量大概在50万行左右，当公式较多，尤其时需要大批量vlookup时，Excel表格将会很卡顿。</p>
<div id="安装数据库" class="section level2" number="3.1">
<h2 number="3.1"><span class="header-section-number">3.1</span> 安装数据库</h2>
<p>如果暂时没有数据库使用经验，如果是使用Windows系统，直接去微软官网下载安装数据库即可。如果决定用R做数据分析相关工作，尤其时商业环境下，使用数据库有较强的必要性。安装数据库后，利用数据库做数据分析的练习测试也是不错的体验。另外也可以积累ETL相关经验。</p>
<p>仅简单介绍 MS SQL Server 安装</p>
<ul>
<li>Win环境下安装</li>
</ul>
<p>MS<a href="https://www.microsoft.com/zh-cn/sql-server/sql-server-downloads">下载</a>，选择开发版或精简版(Developer、Express)其中一个版本下载即可。</p>
<div class="figure">
<img src="picture/chap2/ms%20install.png" alt="" />
<p class="caption">数据库下载</p>
</div>
<p>成功下载后，按照提示一步步确认即可安装成功。另外使用<code>SSMS</code>工具，微软配套的MS SQL SERVER数据库链接工具连接数据库。至于详细的数据库配置尤其是远程连接、账户等信息请自行查阅相关资料。</p>
<ul>
<li>Linux环境下安装</li>
</ul>
<p><a href="https://docs.microsoft.com/zh-cn/sql/linux/sql-server-linux-setup?view=sql-server-ver15">官网安装指南</a></p>
<p>以下用于 SQL Server 2019 的命令指向 Ubuntu 20.04 存储库。 如果使用的是 Ubuntu 18.04 或 16.04，请将以下路径更改为 /ubuntu/18.04/ 或 /ubuntu/16.04/，而不是 /ubuntu/20.04/。</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 导入公共存储库的密钥</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-qO-</span> https://packages.microsoft.com/keys/microsoft.asc <span class="kw">|</span> <span class="fu">sudo</span> apt-key add <span class="at">-</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 为 SQL Server 2019 注册 Microsoft SQL Server Ubuntu 存储库</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> add-apt-repository <span class="st">&quot;</span><span class="va">$(</span><span class="fu">wget</span> <span class="at">-qO-</span> https://packages.microsoft.com/config/ubuntu/20.04/mssql-server-2019.list<span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sudo add-apt-repository &quot;$(wget -qO- https://packages.microsoft.com/config/ubuntu/18.04/mssql-server-2019.list)&quot;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装 SQL Server</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="at">-y</span> mssql-server</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 验证服务是否运行</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="ex">systemctl</span> status mssql-server <span class="at">--no-pager</span></span></code></pre></div>
<p>至于其他如安装sql server 命令行工具请<a href="https://docs.microsoft.com/zh-cn/sql/linux/quickstart-install-connect-ubuntu?view=sql-server-linux-ver15&amp;preserve-view=true">查阅官网安装</a>。</p>
<p>接下来我们就R语言与数据库的交互包展开介绍。</p>
</div>
<div id="dbi" class="section level2" number="3.2">
<h2 number="3.2"><span class="header-section-number">3.2</span> DBI</h2>
<div id="安装" class="section level3" number="3.2.1">
<h3 number="3.2.1"><span class="header-section-number">3.2.1</span> 安装</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;DBI&#39;</span>)</span></code></pre></div>
</div>
<div id="连接数据库" class="section level3" number="3.2.2">
<h3 number="3.2.2"><span class="header-section-number">3.2.2</span> 连接数据库</h3>
<ul>
<li>连接MS SQL SERVER</li>
</ul>
<p>通过以下代码即可连接到服务器172.16.88.2(即IP地址)的数据库，成功连接后即可与数据库交互。</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">drv =</span> odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">Driver =</span> <span class="st">&quot;SQL Server&quot;</span>, <span class="at">server =</span> <span class="st">&quot;172.16.88.2&quot;</span>,<span class="at">database =</span> <span class="st">&quot;spb&quot;</span>, <span class="at">uid =</span> <span class="st">&quot;zhongyf&quot;</span>, <span class="at">pwd =</span> <span class="st">&quot;Zyf123456&quot;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>如果你用windows系统，通过DBI包连接数据库发现乱码时，根据数据库编码指定encoding参数即可，常规在win下连接sqlserver设置encoding = “GBK”。</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">#根据数据库编码方式指定encoding</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">drv =</span> odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">Driver =</span> <span class="st">&quot;SQL Server&quot;</span>, <span class="at">server =</span> <span class="st">&quot;172.16.88.2&quot;</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">database =</span> <span class="st">&quot;spb&quot;</span>, <span class="at">uid =</span> <span class="st">&quot;zhongyf&quot;</span>, <span class="at">pwd =</span> <span class="st">&quot;Zyf123456&quot;</span>, <span class="at">encoding =</span> <span class="st">&quot;GBK&quot;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看本机可用驱动 如缺少相应驱动则安装，ODBC Driver 17 for SQL Server 就是个人安装的驱动</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>Drivers_tbl <span class="ot">&lt;-</span> odbc<span class="sc">::</span><span class="fu">odbcListDrivers</span>() </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Drivers_tbl)</span></code></pre></div>
<p>查询数据库编码方式,从而选择连接数据库时相应的编码方式。</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">drv =</span> odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">Driver =</span> <span class="st">&quot;ODBC Driver 17 for SQL Server&quot;</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">server =</span> <span class="st">&quot;172.16.88.2&quot;</span>, <span class="at">database =</span> <span class="st">&quot;spb&quot;</span>, <span class="at">uid =</span> <span class="st">&quot;zhongyf&quot;</span>, <span class="at">pwd =</span> <span class="st">&quot;Zyf123456&quot;</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">#查看编码是否是936 代表中文简体</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">&quot;SELECT COLLATIONPROPERTY( &#39;chinese_prc_ci_as&#39;, &#39;codepage&#39; )&quot;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con,sql)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># dbExecute(con,sql)</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 用完后记得关闭数据库连接</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span></code></pre></div>
<ul>
<li>连接mysql</li>
</ul>
<p><code>MySQL()</code>函数来源<code>RMySQL</code>包，用来创建<code>&lt;MySQLDriver&gt;</code>驱动，以下代码可连接到阿里云的MySQL数据库。</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RMySQL)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">MySQL</span>(),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">&quot;test&quot;</span>, <span class="at">user =</span> <span class="st">&quot;test_admin&quot;</span>, <span class="at">password =</span> <span class="st">&quot;30HL1234M7#￥lD6gxjB&quot;</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">&quot;prd-public-mypersonal.mysql.test.zhangjiabei.rds.aliyuncs.com&quot;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>或者通过本地已安装驱动连接数据库</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Driver =</span> <span class="st">&quot;MySQL ODBC 8.0 Unicode Driver&quot;</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Server =</span> <span class="st">&quot;localhost&quot;</span>, <span class="at">UID =</span> <span class="st">&quot;root&quot;</span>, <span class="at">PWD =</span> <span class="st">&quot;123456&quot;</span>, <span class="at">Database =</span> <span class="st">&quot;mysql&quot;</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Port =</span> <span class="dv">3306</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>mysql数据库默认端口是3306,访问不通时记得检查3306端口是否开放。</p>
</div>
<div id="执行sql任务" class="section level3" number="3.2.3">
<h3 number="3.2.3"><span class="header-section-number">3.2.3</span> 执行sql任务</h3>
<p>dbGetQuery()函数处理由DBI包创建的con连接查询任务,dbExecute()执行一些数据库任务</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dbGetQuery 直接查询</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>res_table <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,<span class="st">&#39;select * from table&#39;</span>) <span class="co">#直接获取sql查询结果</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#dbReadTable直接读取</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbReadTable</span>(con,<span class="st">&#39;tbl_name&#39;</span>) <span class="co">#直接读取数据库中某表</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dbSendQuery 执行一个查询任务 </span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(<span class="at">conn =</span> con,<span class="at">statement =</span> <span class="st">&#39;select * FROM tab&#39;</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dbFetch</span>(res)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dbClearResult</span>(res)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co"># dbExecute</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con,<span class="st">&#39;delete from table where num &lt;=1000&#39;</span>) <span class="co">#类似任务</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="co"># dbWriteTable()</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 上传数据,指定表名,需上传的数据框df,overwrite是否覆盖,append是否可追加</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con,<span class="at">name =</span> <span class="st">&#39;表名&#39;</span>,<span class="at">value =</span> df,<span class="at">overwrite=</span>TURE,<span class="at">append=</span><span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="函数介绍" class="section level3" number="3.2.4">
<h3 number="3.2.4"><span class="header-section-number">3.2.4</span> 函数介绍</h3>
<p>查看数据库信息,查看表名,删除表，关闭连接等常用操作.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">drv =</span> odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Driver =</span> <span class="st">&quot;ODBC Driver 17 for SQL Server&quot;</span>, <span class="at">server =</span> <span class="st">&quot;172.16.88.2&quot;</span>, </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">database =</span> <span class="st">&quot;spb&quot;</span>, <span class="at">uid =</span> <span class="st">&quot;zhongyf&quot;</span>, <span class="at">pwd =</span> <span class="st">&quot;Zyf123456&quot;</span>, <span class="at">encoding =</span> <span class="st">&quot;GBK&quot;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">#查看数据版本连接信息</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetInfo</span>(con)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 数据库中的全部表名</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(con) <span class="co">#win下中文表名还是会乱码</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 删除表</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="fu">dbRemoveTable</span>(con,<span class="st">&#39;tbl_name&#39;</span>)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 关闭连接</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span></code></pre></div>
</div>
</div>
<div id="odbc包" class="section level2" number="3.3">
<h2 number="3.3"><span class="header-section-number">3.3</span> odbc包</h2>
<p>官方介绍：Connect to ODBC databases (using the DBI interface)</p>
<p>记录到此时，并不时特别清晰<code>odbc</code>与<code>DBI</code>之间的关系。</p>
<p>odbc可以运用于包括(SQL Server, Oracle, MySQL,PostgreSQL,SQLite)等odbc驱动程序于<code>DBI</code>兼容的接口，相比起来<code>DBI</code>包适用范围更广。</p>
<p>1.安装包</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#安装包</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;odbc&#39;</span>)</span></code></pre></div>
<p>2.连接数据库</p>
<p>连接数据库需要注意时区、编码，尤其是涉及到时间时时区如果设置有误，可能导致上传数据错误。</p>
<p>当你在Win系统上连接Sql Server时，如果你使用的数据库是中文环境时，最好设置<code>encoding</code>参数。</p>
<p>如果是linux上通过odbc连接SqlServer,一般情况下可以不用设置编码。如果还是乱码，在连接字符中设置字符编码charset=zh_CN.GBK，设置为gbk会报错。</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(odbc)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> odbc<span class="sc">::</span><span class="fu">dbConnect</span>(<span class="fu">odbc</span>(),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Driver =</span> <span class="st">&quot;SQL Server&quot;</span>, <span class="at">Server =</span> <span class="st">&quot;Vega&quot;</span>, <span class="at">Database =</span> <span class="st">&quot;ghzy&quot;</span>,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Trusted_Connection =</span> <span class="st">&quot;True&quot;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>) <span class="co"># windows身份认证连接</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co"># con &lt;- dbConnect(odbc::odbc(), .connection_string = &quot;Driver={SQL Server};</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                                 server=Vega;database=ghzy;uid=zhongyf;pwd=Zyf123456;&quot;, timeout = 10)</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>con</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Not run</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Win</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>con_spb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">odbc</span>(), <span class="at">.connection_string =</span> <span class="st">&quot;driver={ODBC Driver 17 for SQL Server};server=172.16.88.2;database=spb;uid=zhongyf;pwd=Zyf123456&quot;</span>, </span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">timeout =</span> <span class="dv">10</span>, <span class="at">timezone =</span> <span class="st">&quot;Asia/Shanghai&quot;</span>,<span class="at">encoding =</span> <span class="st">&#39;gbk&#39;</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Linux</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>con_dd <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">.connection_string =</span> <span class="st">&quot;driver={ODBC Driver 17 for SQL Server};server=172.16.88.2;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="st">                 database=aojo_dd;uid=wj;pwd=12qw#$ER;charset=zh_CN.GBK&quot;</span>, <span class="at">timeout =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>3.查询</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> odbc<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,<span class="st">&#39;select * from DT&#39;</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span></code></pre></div>
<p>4.写入数据库</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>odbc<span class="sc">::</span><span class="fu">dbWriteTable</span>(con,<span class="at">name =</span> <span class="st">&#39;表名&#39;</span>,<span class="at">value =</span> dt,<span class="at">overwrite =</span> T ) <span class="co"># 是否覆盖</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>odbc<span class="sc">::</span><span class="fu">dbWriteTable</span>(con,<span class="at">name =</span> <span class="st">&#39;表名&#39;</span>,<span class="at">value =</span> dt,<span class="at">append =</span> T ) <span class="co"># 是否追加</span></span></code></pre></div>
</div>
<div id="rodbc包" class="section level2" number="3.4">
<h2 number="3.4"><span class="header-section-number">3.4</span> RODBC包</h2>
<p>RODBC包是R语言对ODBC数据库接口,可以连接所有的ODBC数据库.</p>
<p>1.安装包</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;RODBC&#39;</span>)</span></code></pre></div>
<p>2.SQL SERVER 数据库举例</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RODBC)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">odbcDriverConnect</span>(<span class="st">&quot;driver={SQL Server};server=192.168.2.62;database=dbname;uid=zhongyf;pwd=Zyf123456&quot;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>con</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>RODBC<span class="sc">::</span><span class="fu">sqlQuery</span>(con,<span class="st">&#39;select * from test&#39;</span>)</span></code></pre></div>
<p>在WINDOWS机器上,需要知道本机是否有相应数据库的驱动程序.</p>
<ul>
<li>查看本机上可用驱动</li>
</ul>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>odbc<span class="sc">::</span><span class="fu">odbcListDrivers</span>()</span></code></pre></div>
<ul>
<li>怎样安装驱动</li>
</ul>
<p>请参照<a href="https://github.com/r-dbi/odbc#installation">驱动安装</a></p>
<p>ODBC for sql server driver 下载地址<a href="https://docs.microsoft.com/zh-cn/sql/connect/odbc/download-odbc-driver-for-sql-server?view=sql-server-ver15">地址</a></p>
<p>3.数据库字符串</p>
<p>请参照<a href="https://www.connectionstrings.com/">数据库连接字符串</a></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ODBC Driver 17 for SQL Server</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>cn <span class="ot">&lt;-</span> <span class="fu">odbcDriverConnect</span>(<span class="st">&quot;Driver={ODBC Driver 17 for SQL Server};Server=localhost;Database=name;UID=username;PWD=123456;&quot;</span>) <span class="co">#server 数据库 UID 数据库账户 PWD 数据库账户密码</span></span></code></pre></div>
<p>sql server 请参照<a href="https://www.connectionstrings.com/microsoft-odbc-driver-17-for-sql-server/">sql server连接字符串</a></p>
</div>
<div id="roracle包" class="section level2" number="3.5">
<h2 number="3.5"><span class="header-section-number">3.5</span> ROracle包</h2>
<p>在第一次安装这个包时遇到了很多困难，首先需要安装oracle客户端，其次配置好环境变量，最后安装包。R与Oracle的连接需要安装<a href="https://www.oracle.com/database/technologies/instant-client.html">Oracle Instant Client</a>，</p>
<ol style="list-style-type: decimal">
<li>安装客户端</li>
</ol>
<p>安装oracle客户端，根据电脑的位数选择相应的32位或64位，根据要连接数据库版本，可以去官网自行下载，本机需要下载的<a href="https://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html">客户端地址</a></p>
<ol start="2" style="list-style-type: decimal">
<li>配置环境变量</li>
</ol>
<p>根据自己所使用的系统，配置环境变量</p>
<pre><code>OCI_INC=&#39;D:\app\zhongyf\product\11.2.0\client_1\oci\include&#39;
OCI_LIB64=&#39;D:\app\zhongyf\product\11.2.0\client_1\BIN&#39;</code></pre>
<p>linxu上安装<code>Roracle</code>包，可以参考我的</p>
<p>微信公众号：宇飞的世界</p>
<p><a href="https://mp.weixin.qq.com/s/QLwedZ5mTybqSXdHMTGRIw">公众号文章连接</a></p>
<ol start="3" style="list-style-type: decimal">
<li>安装包</li>
</ol>
<p>安装Roracle包需要配置相应版本的Rtools并添加到环境变量，另外配置两个oracle的环境变量。代码中有注释,按照自己安装版本路径修改。</p>
<p>由于ROracle依赖于Oracle Instant Client,安装之前一定要先安装好客户端。</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;ROracle&#39;</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>连接数据库</li>
</ol>
<p><code>Roracle</code>可以通过<code>DBI</code>包链接，除了驱动和连接字符串有差异，其他部分一样。</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROracle)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>drv <span class="ot">&lt;-</span><span class="fu">dbDriver</span>(<span class="st">&quot;Oracle&quot;</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>connect.string <span class="ot">&lt;-</span> <span class="st">&#39;(DESCRIPTION =</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="st">                    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.16.88.129)(PORT = 1521))</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="st">                  (CONNECT_DATA =</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="st">                      (SERVER = DEDICATED)</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="st">                    (SERVICE_NAME = bidev)</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="st">                  ))&#39;</span> <span class="co">#连接字符串</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(drv,<span class="at">username =</span> <span class="st">&quot;query&quot;</span>, <span class="at">password =</span> <span class="st">&quot;query&quot;</span>,<span class="at">dbname =</span> connect.string)</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>乱码问题</li>
</ol>
<p>如果连接oracle数据库，中文乱码设置以下环境变量即可，或者在启动文件配置该环境变量。</p>
<p>linux下可以在文件Renviron中添加，记得引号，路径为[/opt/R/4.0.2/lib/R/etc/Renviron]</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 查询数据库编码</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>select <span class="fu">userenv</span>(<span class="st">&#39;language&#39;</span>) from dual</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">NLS_LANG=</span><span class="st">&quot;SIMPLIFIED CHINESE_CHINA.AL32UTF8&quot;</span>)</span></code></pre></div>
</div>
<div id="rmysql包" class="section level2" number="3.6">
<h2 number="3.6"><span class="header-section-number">3.6</span> RMySQL包</h2>
<p>RMySQL包的主要作用可以提供驱动与mysql数据库进行连接，在本机未安装mysql的驱动的情况下.该包正在逐渐被淘汰，可以使用RMariaDB包替换。</p>
<div id="安装-1" class="section level3" number="3.6.1">
<h3 number="3.6.1"><span class="header-section-number">3.6.1</span> 安装</h3>
<p>Win系统下直接安装即可，其它平台下需提前安装依赖环境。</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#On recent Debian or Ubuntu install libmariadbclient-dev</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="at">-y</span> libmariadbclient-dev</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">#On Fedora, CentOS or RHEL we need mariadb-devel:</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install mariadb-devel</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">#On OS-X use mariadb-connector-c from Homebrew:</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install mariadb-connector-c</span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;RMySQL&#39;</span>)</span></code></pre></div>
</div>
<div id="连接使用" class="section level3" number="3.6.2">
<h3 number="3.6.2"><span class="header-section-number">3.6.2</span> 连接使用</h3>
<p>连接数据库，与上述连接方式基本一致。</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RMySQL)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> RMySQL<span class="sc">::</span><span class="fu">dbConnect</span>(<span class="at">drv =</span> RMySQL<span class="sc">::</span><span class="fu">MySQL</span>(),<span class="at">host=</span><span class="st">&#39;localhost&#39;</span>,<span class="at">dbname=</span><span class="st">&quot;mysql&quot;</span>,<span class="at">username=</span><span class="st">&quot;root&quot;</span>,<span class="at">password=</span><span class="st">&#39;123456&#39;</span>)</span></code></pre></div>
<p><code>RMariaDB</code>包与<code>RMySQL</code>包用法基本一致，在连接时注意驱动的选择即可。</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;RMariaDB&#39;</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RMariaDB)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> RMySQL<span class="sc">::</span><span class="fu">dbConnect</span>(<span class="at">drv =</span> RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>() ,<span class="at">host=</span><span class="st">&#39;localhost&#39;</span>,<span class="at">dbname=</span><span class="st">&quot;dbtest&quot;</span>,<span class="at">username=</span><span class="st">&quot;root&quot;</span>,<span class="at">password=</span><span class="st">&#39;123456&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="常见问题" class="section level2" number="3.7">
<h2 number="3.7"><span class="header-section-number">3.7</span> 常见问题</h2>
<p>在使用R包连接数据库时有些常见的问题，整理如下：</p>
<div id="乱码问题" class="section level3" number="3.7.1">
<h3 number="3.7.1"><span class="header-section-number">3.7.1</span> 乱码问题</h3>
<p>R中中文乱码问题一直都很麻烦，并且常常遇见，尤其是使用win系统时。</p>
<ul>
<li>MS SQL SERVER 乱码</li>
</ul>
<p>修改encoding参数，在win系统下，可以考虑使用RODBC包连接查询数据库，因为该包将自动转换编码，不会存在乱码问题。但是上传效率奇慢，为了减少包依赖保持代码一致性使用odbc连接数据库时遇到乱码，在连接数据库时设定encoding即可。</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># win</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>con_spb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">odbc</span>(),</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.connection_string =</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;driver={ SQLServer};server=172.16.88.2;database=spb;uid=zhongyf;pwd=Zyf123456&quot;</span>, </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeout =</span> <span class="dv">10</span>, <span class="at">timezone =</span> <span class="st">&quot;Asia/Shanghai&quot;</span>, <span class="at">encoding =</span> <span class="st">&quot;gbk&quot;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="co"># linux </span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>con_spb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">odbc</span>(),</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.connection_string =</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;driver={ODBC Driver 17 for SQL Server};server=172.16.88.2;database=spb;uid=zhongyf;pwd=Zyf123456&quot;</span>, </span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">timeout =</span> <span class="dv">10</span>, <span class="at">timezone =</span> <span class="st">&quot;Asia/Shanghai&quot;</span>, <span class="at">encoding =</span> <span class="st">&quot;utf8&quot;</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<ul>
<li>MySQL乱码</li>
</ul>
<p>1.代码修改</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#执行查询语句前执行</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendQuery</span>(con,<span class="st">&#39;SET NAMES gbk&#39;</span>)</span></code></pre></div>
<p>2.ODBC配置</p>
<p>如果是通过ODBC数据源连接,可通过配置需改,如下所示：</p>
<div class="figure">
<img src="picture/chap2/pic1.png" alt="" />
<p class="caption">ODBC配置截图</p>
</div>
</div>
<div id="无法连接问题" class="section level3" number="3.7.2">
<h3 number="3.7.2"><span class="header-section-number">3.7.2</span> 无法连接问题</h3>
<p>首先需要装mysql的驱动,确保<code>RMySQL</code>成功安装 如果是测试自己安装的mysql,可以先用Navicat连接,如果出现Authentication plugin ‘caching_sha2_password’ cannot be loaded的错误。</p>
<p>可能是由于 mysql8 之前的版本中加密规则是mysql_native_password,而在mysql8之后,加密规则是caching_sha2_password,通过修改加密规则可解决无法连接问题。</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">--cmd 登录本地数据</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>mysql <span class="op">-</span>u root <span class="op">-</span>p</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">--输入密码</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">password</span>: </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">--执行命令</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="fu">USER</span> <span class="st">&#39;root&#39;</span>@<span class="st">&#39;localhost&#39;</span> <span class="kw">IDENTIFIED</span> <span class="kw">BY</span> <span class="st">&#39;password&#39;</span> <span class="kw">PASSWORD</span> <span class="kw">EXPIRE</span> <span class="kw">NEVER</span>;   #修改加密规则 </span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">---ALTER USER &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;password&#39; PASSWORD EXPIRE NEVER; 看账号权限注意与上面的区别</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="fu">USER</span> <span class="st">&#39;root&#39;</span>@<span class="st">&#39;localhost&#39;</span> <span class="kw">IDENTIFIED</span> <span class="kw">WITH</span> mysql_native_password <span class="kw">BY</span> <span class="st">&#39;password&#39;</span>; #更新一下用户的密码 </span></code></pre></div>
</div>
<div id="远程连接" class="section level3" number="3.7.3">
<h3 number="3.7.3"><span class="header-section-number">3.7.3</span> 远程连接</h3>
<p>当你需要远程连接时，需要确保数据库的远程连接已经开启。在数据库中开启某账户远程连接权限,在公司的话，数据库连接问题咨询公司的IT人员。自己个人电脑上安装的MS SQL SERVER数据库需要自行开启远程连接。</p>
<p>另外如果是云服务器上搭建的数据库,需要开启数据库端口，如Mysql默认端口3306;如果是阿里云的Rds数据库,找DBA管理员要数据库地址以及端口信息。</p>
</div>
</div>
<div id="dbplyr" class="section level2" number="3.8">
<h2 number="3.8"><span class="header-section-number">3.8</span> dbplyr</h2>
<p><code>dbplyr</code>将<code>dplyr</code>包的函数转化为<code>SQL</code>语句去服务器获取数据；在数据量较大、计算较多时，可以将远程连接数据库中的表当作内存中的数据框使用，当本机内存不够大时，这样做的好处不言而喻。</p>
<p>至于为什么使用<code>dbplyr</code>而不是直接编写<code>SQL</code>,因为：</p>
<ul>
<li><p><code>dbplyr</code>写起来简洁高效，基本跟用<code>dplyr</code>没有差别</p></li>
<li><p>能利用数据库所在服务器的算力，配合上并行计算，在处理大量数据时，大大加快速度。</p></li>
<li><p>不同数据库的语法存在差异，当源数据存在不同数据库时，用R的<code>dbplyr</code>包清洗数据时能加快效率</p></li>
<li><p>通过<code>dplyr</code>动词方便实现复杂的逻辑，当过程越多越复杂时<code>dbplyr</code>的优势越明显，不用一层层嵌套语句。</p></li>
</ul>
<div id="基础用法" class="section level3" number="3.8.1">
<h3 number="3.8.1"><span class="header-section-number">3.8.1</span> 基础用法</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>mf <span class="ot">&lt;-</span> <span class="fu">memdb_frame</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">2</span>)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>mf <span class="sc">%&gt;%</span> </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">a =</span> y <span class="sc">*</span> x, </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">b =</span> a <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co">#connect database</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">path =</span> <span class="st">&quot;:memory:&quot;</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 上传数据</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">copy_to</span>(con, nycflights13<span class="sc">::</span>flights, <span class="st">&quot;flights&quot;</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporary =</span> <span class="cn">FALSE</span>, </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">indexes =</span> <span class="fu">list</span>(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;month&quot;</span>, <span class="st">&quot;day&quot;</span>), </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;carrier&quot;</span>, </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tailnum&quot;</span>,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dest&quot;</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看库中全部表名</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="co">#dbListTables(con)</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="co">#tbl()引用表flights</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>flights_db <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">&quot;flights&quot;</span>)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>flights_db</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 开始查询</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> <span class="fu">select</span>(year<span class="sc">:</span>day, dep_delay, arr_delay)</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dep_delay <span class="sc">&gt;</span> <span class="dv">240</span>)</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> </span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dest) <span class="sc">%&gt;%</span></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">delay =</span> <span class="fu">mean</span>(dep_time))</span></code></pre></div>
<p>部分简单不复杂的sql语句可以用dplyr的语法代替.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db <span class="ot">&lt;-</span> flights_db <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tailnum) <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay =</span> <span class="fu">mean</span>(arr_delay,<span class="at">na.rm =</span> T),</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(delay)) <span class="sc">%&gt;%</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">100</span>)</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db <span class="sc">%&gt;%</span> <span class="fu">show_query</span>()</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>tailnum_delay <span class="ot">&lt;-</span> tailnum_delay_db <span class="sc">%&gt;%</span> <span class="fu">collect</span>() <span class="co">#把数据从数据库加载到R内存中</span></span></code></pre></div>
</div>
<div id="无法正确转化" class="section level3" number="3.8.2">
<h3 number="3.8.2"><span class="header-section-number">3.8.2</span> 无法正确转化</h3>
<p>在使用过程中发现无法识别<code>lubridate</code>包的函数，但是<code>dbplyr</code>对于不认识的函数都将保留。</p>
<p>利用这个特性，可以使用数据库中原生的相关函数：如下所示，在Oracle中<code>to_date</code>函数</p>
<p>以下的自定义函数可以实现按照想要<code>group_by</code>的字段汇总金额、数量、吊牌额、折扣率等,其中关于时间周期的筛选就利用了该特性。</p>
<ul>
<li>date</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">#个人写的争对目前公司数仓写的包中获取销售数据的一段代码</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>get_sales_data <span class="ot">&lt;-</span> <span class="cf">function</span>(con,...,start_date,end_date,brand_name,<span class="at">channel_type =</span> <span class="cn">NULL</span> ,<span class="at">area_name =</span> <span class="cn">NULL</span>,<span class="at">boss_name =</span> <span class="cn">NULL</span>,<span class="at">category_name =</span> <span class="cn">NULL</span>,<span class="at">shop_no =</span> <span class="cn">NULL</span>){</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  store_table <span class="ot">&lt;-</span> <span class="fu">store</span>(con,<span class="at">brand_name =</span> brand_name,<span class="at">channel_type =</span> channel_type ,<span class="at">area_name =</span> area_name,<span class="at">boss_name =</span> boss_name,<span class="at">shop_no =</span> shop_no) <span class="co">#门店信息</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  sku_table <span class="ot">&lt;-</span> <span class="fu">sku</span>(con,<span class="at">category_name =</span>  category_name ) <span class="co">#商品信息</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(con, <span class="fu">in_schema</span>(<span class="st">&quot;DW&quot;</span>, <span class="st">&quot;DW_SALE_SHOP_F&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co">#DW层</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(BILL_DATE1, SKU_NO, SHOP_NO, BILL_QTY, BILL_MONEY2, PRICE) <span class="sc">%&gt;%</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">between</span>(</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>      BILL_DATE1, <span class="fu">to_date</span>(start_date, <span class="st">&quot;yyyy-mm-dd&quot;</span>),</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">to_date</span>(end_date, <span class="st">&quot;yyyy-mm-dd&quot;</span>)</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(年 <span class="ot">=</span> <span class="fu">year</span>(BILL_DATE1), 月 <span class="ot">=</span> <span class="fu">month</span>(BILL_DATE1)) <span class="sc">%&gt;%</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(store_table) <span class="sc">%&gt;%</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(sku_table) <span class="sc">%&gt;%</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(...) <span class="sc">%&gt;%</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>      金额 <span class="ot">=</span> <span class="fu">sum</span>(BILL_MONEY2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>      数量 <span class="ot">=</span> <span class="fu">sum</span>(BILL_QTY, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>      吊牌金额 <span class="ot">=</span> <span class="fu">sum</span>(BILL_QTY <span class="sc">*</span> PRICE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(折扣率<span class="sc">:</span><span class="er">=</span> 金额 <span class="sc">/</span> 吊牌金额) <span class="sc">%&gt;%</span> </span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(...)</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return(res)</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>like</li>
</ul>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>mf <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x <span class="sc">%LIKE%</span> <span class="st">&quot;%foo%&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code></pre></div>
<ul>
<li>特殊用法</li>
</ul>
<p>特殊情况可以使用<code>sql()</code>函数</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>mf <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">factorial =</span> <span class="fu">sql</span>(<span class="st">&quot;x!&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code></pre></div>
</div>
</div>
<div id="参考资料" class="section level2" number="3.9">
<h2 number="3.9"><span class="header-section-number">3.9</span> 参考资料</h2>
<p><code>DBI</code>包资料<a href="https://dbi.r-dbi.org/reference/" class="uri">https://dbi.r-dbi.org/reference/</a></p>
<p><code>dbplyr</code>包资料<a href="https://dbplyr.tidyverse.org/" class="uri">https://dbplyr.tidyverse.org/</a></p>
<p>rstudio关于数据库介绍 <a href="https://db.rstudio.com/databases" class="uri">https://db.rstudio.com/databases</a></p>
<p>数据库连接字符串介绍 <a href="https://www.connectionstrings.com/" class="uri">https://www.connectionstrings.com/</a></p>
<p>个人博客关于Roracle的安装介绍 <a href="http://www.zhongyufei.com/2020/07/25/roracle-install/" class="uri">http://www.zhongyufei.com/2020/07/25/roracle-install/</a></p>
<p><a href="https://www.r-consortium.org/blog/2017/05/15/improving-dbi-a-retrospect" class="uri">https://www.r-consortium.org/blog/2017/05/15/improving-dbi-a-retrospect</a></p>
<!--chapter:end:02-database.Rmd-->
</div>
</div>
<div id="stringr" class="section level1" number="4">
<h1 number="4"><span class="header-section-number">4</span> stringr</h1>
<p>实际工作中,经常需要处理字符串.R包stringr处理字符相对简单,本章记录工作中常用的字符处理方式方法。</p>
<p>本文部分案例照搬<a href="https://r4ds.had.co.nz/strings.html">R for Data Science</a>的字符部分。</p>
<p>Excle中自带的字符函数如: <code>left</code>,<code>len</code>,<code>mid</code>,<code>find</code>,<code>Proper</code>,<code>rept</code>,<code>trim</code>,<code>upper</code>,<code>substitute</code>,<code>concatenate</code>,以及<code>Excle</code>2019新出的<code>concat</code>,<code>TEXTJOIN</code>等函数，新出的<code>textjoin</code>函数我个人比较喜欢用。</p>
<p>学习的时候可以先用<code>stringr</code>包实现以上相对应功能。</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html" class="uri">https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html</a></li>
</ul>
<div id="基础" class="section level2" number="4.1">
<h2 number="4.1"><span class="header-section-number">4.1</span> 基础</h2>
<p>字符串处理的难点，个人觉得在于【正则表达式】的掌握程度，但是需要用到正则表达式时都是比较复杂的字符处理工作，在实际商业文本数据中</p>
<p>运用较多。对大部分常规商业数据分析工作者的面对的表格数据而言，字符处理可能仅仅只是合并、剔除、删除空格、倒叙等基础操作。</p>
<div id="单双引号" class="section level3" number="4.1.1">
<h3 number="4.1.1"><span class="header-section-number">4.1.1</span> 单双引号</h3>
<p><code>R</code>语言中字符串输入时，可以使用单引号，也可以使用双引号。</p>
<ul>
<li><p>单双引号用法和意义没有差别</p></li>
<li><p>R中推荐使用双引号分隔符，打印、显示时都是用双引号</p></li>
<li><p>单引号字符串通常用在字符串内包含双引号时，如用R执行sql字符串代码时</p></li>
</ul>
</div>
<div id="转义" class="section level3" number="4.1.2">
<h3 number="4.1.2"><span class="header-section-number">4.1.2</span> 转义</h3>
<p>要在字符串中包含单引号或双引号，可以使用 转义它，即遇到特殊符号时需要转义。</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&#39;stringr&#39;)</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>char <span class="ot">&lt;-</span> <span class="st">&quot;我是一名</span><span class="sc">\&#39;</span><span class="st">小学生</span><span class="sc">\&#39;</span><span class="st">&quot;</span>   <span class="co">#字符串建议用双引号包裹,单引号也可以</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>char</span></code></pre></div>
<p>打印会显示转义符。要查看字符串的原始内容,可使用writeLines()或cat()</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;\&quot;&quot; &quot;\\&quot;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(x)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(char)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &quot;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; \</span></span></code></pre></div>
<p>在正则表达式中 有特殊含义,有时需要两个 ，多体会下面这段，代码实现移除“||”的功能。</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove</span>(<span class="at">string =</span> <span class="st">&#39;a||b&#39;</span>,<span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">|</span><span class="sc">\\</span><span class="st">|&quot;</span>)</span></code></pre></div>
<p>另外常见的\n, \t需要被转义处理,在字符清洗,如小说语义分析,网页爬虫后整理等数据清洗过程中经常用到.</p>
</div>
<div id="字符串长度" class="section level3" number="4.1.3">
<h3 number="4.1.3"><span class="header-section-number">4.1.3</span> 字符串长度</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>char <span class="ot">&lt;-</span> <span class="st">&quot;我是R语言学习者&quot;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(char)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 向量化</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(<span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;R for data science&quot;</span>, <span class="cn">NA</span>))</span></code></pre></div>
</div>
<div id="连接字符串" class="section level3" number="4.1.4">
<h3 number="4.1.4"><span class="header-section-number">4.1.4</span> 连接字符串</h3>
<p>R中字符串不像python中可以用加号连接字符串,如下所示:</p>
<p>R 版本</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#base R</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co">#stringr</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;, &quot;</span>) <span class="co">#sep 参数控制分隔符</span></span></code></pre></div>
<p>Python 版本</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;a&#39;</span> <span class="op">+</span> <span class="st">&#39;b&#39;</span></span></code></pre></div>
<p>多个字符串合并为一个字符,<code>stringr</code>中的函数都是向量化的，合并一个和多个字符都是同样道理。</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">#base R</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;e&#39;</span>),<span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co">#stringr</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;e&#39;</span>),<span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)  <span class="co">#collapse 参数控制</span></span></code></pre></div>
<p>实际运用案例</p>
<ul>
<li>合并</li>
</ul>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">col=</span><span class="fu">rep</span>(<span class="st">&#39;a&#39;</span>,<span class="dv">10</span>),<span class="at">letters=</span>letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>dt[,newcol<span class="sc">:</span><span class="er">=</span><span class="fu">str_c</span>(letters,<span class="at">collapse =</span> <span class="st">&#39;|&#39;</span>),by<span class="ot">=</span>.(col)][]</span></code></pre></div>
<ul>
<li>拆解</li>
</ul>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#工作中路径需要拆解 类似商品品类路径 进口水果-热带水果-生鲜,用户行为路径等</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">col=</span><span class="st">&#39;a&#39;</span>,<span class="at">letters=</span><span class="fu">str_c</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],<span class="at">collapse =</span> <span class="st">&#39;|&#39;</span>))</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>my_str_split <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_split</span>(x,<span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">|&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()  <span class="co">#str_split 拆解出来是列表 需要向量化</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>dt[,<span class="fu">list</span>(<span class="at">newcol=</span><span class="fu">my_str_split</span>(letters)),by<span class="ot">=</span>.(col)]</span></code></pre></div>
</div>
<div id="r4.0后新特性" class="section level3" number="4.1.5">
<h3 number="4.1.5"><span class="header-section-number">4.1.5</span> R4.0后新特性</h3>
<p><a href="https://www.r-bloggers.com/4-for-4-0-0-four-useful-new-features-in-r-4-0-0/">新特性</a></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>char <span class="ot">&lt;-</span> r<span class="st">&quot;(</span><span class="sc">\\</span><span class="st">a</span><span class="sc">\a</span><span class="st">b\d</span><span class="sc">\e\f</span><span class="st">)&quot;</span> <span class="co">#windows下路径好用,不用转义路径复制和直接可用</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>char</span></code></pre></div>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>char <span class="ot">&lt;-</span> <span class="st">&quot;我是一名</span><span class="sc">\&#39;</span><span class="st">小学生</span><span class="sc">\&#39;</span><span class="st">&quot;</span> </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(char)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>char <span class="ot">&lt;-</span> r<span class="st">&quot;(我是一名&#39;R语言&#39;学习者)&quot;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(char)</span></code></pre></div>
</div>
</div>
<div id="常用函数-1" class="section level2" number="4.2">
<h2 number="4.2"><span class="header-section-number">4.2</span> 常用函数</h2>
<div id="截取" class="section level3" number="4.2.1">
<h3 number="4.2.1"><span class="header-section-number">4.2.1</span> 截取</h3>
<p>与<code>Excle</code>中<code>left</code>,<code>mid</code>,<code>right</code>函数功能类似</p>
<p>str_sub() 函数 三个参数:</p>
<p>string:需要被截取的字符串</p>
<p>start: 默认1L,即从最开始截取</p>
<p>end:默认-1L,即截取到最后</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#注意end 3 和 -3的区别</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sub</span>(<span class="at">string =</span> <span class="st">&#39;我是R语言学习者&#39;</span>,<span class="at">start =</span> <span class="dv">2</span>,<span class="at">end =</span> <span class="dv">3</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sub</span>(<span class="at">string =</span> <span class="st">&#39;我是R语言学习者&#39;</span>,<span class="at">start =</span> <span class="dv">2</span>,<span class="at">end =</span> <span class="sc">-</span><span class="dv">3</span>)</span></code></pre></div>
</div>
<div id="匹配" class="section level3" number="4.2.2">
<h3 number="4.2.2"><span class="header-section-number">4.2.2</span> 匹配</h3>
<p>查看函数帮助文档,str_match()按照指定pattern(正则表达式)查找字符.重点困难点正则表达式的编写.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>?<span class="fu">str_match</span>()</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>?<span class="fu">str_match_all</span>()</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>?<span class="fu">str_extract</span>()</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>?<span class="fu">str_extract_all</span>()</span></code></pre></div>
<p>str_extract()函数返回向量,str_match()函数返回矩阵.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">#原文来源烽火戏诸侯的&lt;剑来&gt;</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>strings <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;陈平安放下新折的那根桃枝,吹灭蜡烛,走出屋子后,坐在台阶上,仰头望去,星空璀璨.&#39;</span>) </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(strings,<span class="st">&#39;陈平安&#39;</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_match</span>(strings,<span class="st">&#39;陈平安&#39;</span>)</span></code></pre></div>
<ul>
<li>匹配中文</li>
</ul>
<p>匹配中文的正则表达式<span class="math display">\[\u4e00-\u9fa5\]</span></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract_all</span>(strings,<span class="st">&#39;[\u4e00-\u9fa5]&#39;</span>) <span class="co">#返回list</span></span></code></pre></div>
<ul>
<li>匹配数字或英文</li>
</ul>
<p>查找数字的正则表达式[0-9];查找英文的正则表达式:[a-zA-Z]</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>strings <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;00123545&#39;</span>,<span class="st">&#39;LOL league of legends&#39;</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract_all</span>(strings,<span class="st">&#39;[0-9]&#39;</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract_all</span>(strings,<span class="st">&#39;[a-zA-Z]&#39;</span>) </span></code></pre></div>
</div>
<div id="添加字符" class="section level3" number="4.2.3">
<h3 number="4.2.3"><span class="header-section-number">4.2.3</span> 添加字符</h3>
<p>str_pad() 函数向字符串添加字符</p>
<p>像工作中处理月份的时候,1,2,3,4,5,6,7,8,9,10,11,12变成01,02,03,04,05,06,07,08,09,10,11,12.按照日期时间输出文件名称,如下所示:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_pad</span>(<span class="at">string =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>,<span class="at">width =</span> <span class="dv">2</span>,<span class="at">side =</span> <span class="st">&#39;left&#39;</span>,<span class="at">pad =</span> <span class="st">&#39;0&#39;</span>)</span></code></pre></div>
</div>
<div id="去除空格" class="section level3" number="4.2.4">
<h3 number="4.2.4"><span class="header-section-number">4.2.4</span> 去除空格</h3>
<p>与<code>excel</code>中<code>trim</code>函数功能类似，剔除字符中的空格，但是不可以剔除字符中的空格</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># side 可选 both  left right</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trim</span>(<span class="st">&#39; ab af &#39;</span>,<span class="at">side =</span> <span class="st">&#39;both&#39;</span>)</span></code></pre></div>
</div>
<div id="分割字符" class="section level3" number="4.2.5">
<h3 number="4.2.5"><span class="header-section-number">4.2.5</span> 分割字符</h3>
<p><code>str_split()</code>处理后的结果是列表</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 得到列表,需要向量化</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(<span class="st">&quot;a,b,d,e&quot;</span>,<span class="at">pattern =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(<span class="st">&#39;ab||cd&#39;</span>,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">|</span><span class="sc">\\</span><span class="st">|&#39;</span>) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co">#str_split(&#39;ab||cd&#39;,&#39;\\|\\|&#39;) %&gt;% purrr::as_vector()</span></span></code></pre></div>
<p>当待处理的字符串是字符串向量时，得到的列表长度与向量长度一致</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fruits <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;apples and oranges and pears and bananas&quot;</span>,</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;pineapples and mangos and guavas&quot;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(fruits, <span class="st">&quot; and &quot;</span>)</span></code></pre></div>
</div>
<div id="替换字符" class="section level3" number="4.2.6">
<h3 number="4.2.6"><span class="header-section-number">4.2.6</span> 替换字符</h3>
<p><code>str_replace()</code>，<code>str_replace_all()</code>函数用来替换字符</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>fruits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;one apple&quot;</span>, <span class="st">&quot;two pears&quot;</span>, <span class="st">&quot;three bananas&quot;</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace</span>(fruits, <span class="st">&quot;[aeiou]&quot;</span>, <span class="st">&quot;-&quot;</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace_all</span>(fruits, <span class="st">&quot;[aeiou]&quot;</span>, <span class="st">&quot;-&quot;</span>)</span></code></pre></div>
</div>
<div id="移除字符" class="section level3" number="4.2.7">
<h3 number="4.2.7"><span class="header-section-number">4.2.7</span> 移除字符</h3>
<p><code>str_remove()</code>,<code>str_remove_all()</code>移除字符。本人常用该函数剔除文本中的空格。</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>fruits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;one apple&quot;</span>, <span class="st">&quot;two pears&quot;</span>, <span class="st">&quot;three bananas&quot;</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove</span>(fruits, <span class="st">&quot;[aeiou]&quot;</span>)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove_all</span>(fruits, <span class="st">&quot;[aeiou]&quot;</span>)</span></code></pre></div>
<p>移除文本中空格</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace_all</span>(<span class="at">string =</span> <span class="st">&#39; d a  b &#39;</span>,<span class="at">pattern =</span> <span class="st">&#39; &#39;</span>,<span class="at">replacement =</span> <span class="st">&#39;&#39;</span>)</span></code></pre></div>
</div>
<div id="字符排序" class="section level3" number="4.2.8">
<h3 number="4.2.8"><span class="header-section-number">4.2.8</span> 字符排序</h3>
<p>numeric参数决定是否按照数字排序。</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_order</span>(x, <span class="at">decreasing =</span> <span class="cn">FALSE</span>, <span class="at">na_last =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">&quot;en&quot;</span>,</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">numeric =</span> <span class="cn">FALSE</span>, ...)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(x, <span class="at">decreasing =</span> <span class="cn">FALSE</span>, <span class="at">na_last =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">&quot;en&quot;</span>,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">numeric =</span> <span class="cn">FALSE</span>, ...)</span></code></pre></div>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_order</span>(letters)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(letters)</span></code></pre></div>
<p>numeric参数</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;100a10&quot;</span>, <span class="st">&quot;100a5&quot;</span>, <span class="st">&quot;2b&quot;</span>, <span class="st">&quot;2a&quot;</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(x)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(x, <span class="at">numeric =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="提取单词" class="section level3" number="4.2.9">
<h3 number="4.2.9"><span class="header-section-number">4.2.9</span> 提取单词</h3>
<p>从句子中提取单词。</p>
<ul>
<li>参数</li>
</ul>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">word</span>(string, <span class="at">start =</span> 1L, <span class="at">end =</span> start, <span class="at">sep =</span> <span class="fu">fixed</span>(<span class="st">&quot; &quot;</span>))</span></code></pre></div>
<ul>
<li>案例</li>
</ul>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>sentences <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Jane saw a cat&quot;</span>, <span class="st">&quot;Jane sat down&quot;</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">word</span>(sentences, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">word</span>(sentences[<span class="dv">1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>)</span></code></pre></div>
<p>指定分隔符</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Can define words by other separators</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>str <span class="ot">&lt;-</span> <span class="st">&#39;abc.def..123.4568.999&#39;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">word</span>(str, <span class="dv">1</span>, <span class="at">sep =</span> <span class="fu">fixed</span>(<span class="st">&#39;..&#39;</span>))</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">word</span>(str, <span class="dv">2</span>, <span class="at">sep =</span> <span class="fu">fixed</span>(<span class="st">&#39;..&#39;</span>))</span></code></pre></div>
</div>
<div id="其他函数" class="section level3" number="4.2.10">
<h3 number="4.2.10"><span class="header-section-number">4.2.10</span> 其他函数</h3>
<ul>
<li>str_subset() str_which()</li>
</ul>
<p>匹配字符串本身行筛选时候能用</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>fruit <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;apple&quot;</span>, <span class="st">&quot;banana&quot;</span>, <span class="st">&quot;pear&quot;</span>, <span class="st">&quot;pinapple&quot;</span>)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_subset</span>(fruit, <span class="st">&quot;a&quot;</span>)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_which</span>(fruit, <span class="st">&quot;a&quot;</span>) <span class="co"># 匹配字符首次出现的位置</span></span></code></pre></div>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#str_which 是which(str_detect(x,pattern))的包装</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="co">#str_which()</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co">#str_subset是对x[str_detect(x,pattern)]的包装</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co">#str_subset()</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co">#筛选出字母行</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">24</span>)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">col=</span><span class="fu">sample</span>(<span class="fu">c</span>(letters,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),<span class="dv">100</span>,<span class="at">replace =</span> T))</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt[<span class="fu">str_which</span>(col,<span class="at">pattern =</span> <span class="st">&#39;[a-z]&#39;</span>)])</span></code></pre></div>
<ul>
<li>str_dup()</li>
</ul>
<p>复制字符串</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>fruit <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;apple&quot;</span>, <span class="st">&quot;pear&quot;</span>, <span class="st">&quot;banana&quot;</span>)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_dup</span>(fruit, <span class="dv">2</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_dup</span>(fruit, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">&quot;ba&quot;</span>, <span class="fu">str_dup</span>(<span class="st">&quot;na&quot;</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>))</span></code></pre></div>
<ul>
<li>str_starts() str_ends()</li>
</ul>
<p>从str_detect()包装得到.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_starts</span>(<span class="st">&#39;abd&#39;</span>,<span class="st">&#39;a&#39;</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="st">&#39;abd&#39;</span>,<span class="st">&#39;^a&#39;</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_ends</span>(<span class="st">&#39;abd&#39;</span>,<span class="st">&#39;d&#39;</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="st">&#39;abd&#39;</span>,<span class="st">&#39;a$&#39;</span>)</span></code></pre></div>
<ul>
<li>大小写转换</li>
</ul>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dog <span class="ot">&lt;-</span> <span class="st">&quot;The quick brown dog&quot;</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_to_upper</span>(dog)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_to_lower</span>(dog)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_to_title</span>(dog)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_to_sentence</span>(<span class="st">&quot;the quick brown dog&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="r实现excel字符函数" class="section level2" number="4.3">
<h2 number="4.3"><span class="header-section-number">4.3</span> R实现Excel字符函数</h2>
<p>以下函数实现，仅仅只是从<code>stringr</code>包的函数上修改，并且没有完善，没有报错提示等的简陋版本，如果感兴趣的可以尝试利用<code>Rcpp</code>写出高性能版本的同功能函数。</p>
<ul>
<li>left</li>
</ul>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>r_left <span class="ot">&lt;-</span> <span class="cf">function</span>(str,num){</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_sub</span>(<span class="at">string =</span> str,<span class="at">start =</span> <span class="dv">1</span>,<span class="at">end =</span> num)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="fu">r_left</span>(<span class="st">&#39;我是R语言学习者&#39;</span>,<span class="dv">3</span>)</span></code></pre></div>
<ul>
<li>right</li>
</ul>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>r_right <span class="ot">&lt;-</span> <span class="cf">function</span>(str,num){</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_sub</span>(<span class="at">string =</span> str,<span class="at">start =</span> <span class="fu">str_length</span>(str) <span class="sc">-</span> num <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="fu">r_right</span>(<span class="st">&#39;我是R语言学习者&#39;</span>,<span class="dv">3</span>)</span></code></pre></div>
<ul>
<li>mid</li>
</ul>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>r_mid <span class="ot">&lt;-</span> <span class="cf">function</span>(str,start,num){</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_sub</span>(<span class="at">string =</span> str,<span class="at">start =</span> start,<span class="at">end =</span> start <span class="sc">+</span> num <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="fu">r_mid</span>(<span class="st">&#39;我是R语言学习者&#39;</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span></code></pre></div>
<p>其余函数可以自行实现</p>
<!--chapter:end:03-strings.Rmd-->
</div>
</div>
<div id="lubridate" class="section level1" number="5">
<h1 number="5"><span class="header-section-number">5</span> lubridate</h1>
<p>数据清洗中,经常涉及到时间处理。个人R中用来处理时间的包是<code>lubridate</code>，本文将介绍该包中部分函数用法。</p>
<p>该包能灵活处理日期和时间数据，但是日期处理是比较复杂的，就拿简单的同环比来说，如果是想利用基础函数自定义函数来处理同环比，你遇到的第一个问题就是每个月的天数不一样，第二个问题就是闰年问题导致年天数不一致。</p>
<p>经过一番折腾，完全放弃了自己处理时间日期数据的想法，投入了<code>lubridate</code>包的怀抱。由于能力有限以及处理过的日期数据有限，并不能面面俱到，更加深入的问题，可自行去了解该包的文档，甚至去通读源码。</p>
<p>在<code>Excel</code>的<code>Power Pivot</code>中有一组DAX智能函数，如：</p>
<ul>
<li>基础函数</li>
</ul>
<p><code>date</code>,<code>datediff</code>,<code>datevalue</code>,<code>edate</code>,<code>eomonth</code>,<code>quarter</code>,<code>TIMEVALUE</code>等等</p>
<ul>
<li>智能函数</li>
</ul>
<p><code>dateadd</code>,<code>DATESBETWEEN</code>,<code>DATESMTD</code>,<code>TOTALMTD</code>,<code>TOTALQTD</code>,<code>TOTALYTD</code>等等</p>
<p><code>Excel</code>中因为有了以上时间智能函数，用度量值在透视表中计算同环比变得简单</p>
<p>熟悉DAX时间智能函数，在<code>R</code>中设计相关功能或实现时可以借鉴参考DAX函数的思路。比如在R中写自动化报表时，涉及到同环比计算时就可以按照这个模式设计。</p>
<hr />
<p>注意事项：</p>
<p><code>R</code>中日期起始时间是<code>1970-01-01</code>,Excel中是<code>1900-01-01</code>,转化成数字两者相差25568。在用R读取Excel文件时，设计到日期数字转化成日期时需要注意其中差异。</p>
<p>R中日期 : 2021-05-10 转化成数字: 18757,
Excel 中 2021-05-10转化成数字:44325,两者相差25568.</p>
<div id="基础用法-1" class="section level2" number="5.1">
<h2 number="5.1"><span class="header-section-number">5.1</span> 基础用法</h2>
<p>获取当前日期、时间；拆解时间日期中的年、月、日、星期、计算年月天数，记录时刻等常用的时间日期功能，<code>lubridate</code>包中都有相对应的功能函数。</p>
<div id="安装包" class="section level3" number="5.1.1">
<h3 number="5.1.1"><span class="header-section-number">5.1.1</span> 安装包</h3>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 仅仅只安装lubridate</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;lubridate&#39;</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 开发版</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;tidyverse/lubridate&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载包</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate,<span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="获取当前时间日期" class="section level3" number="5.1.2">
<h3 number="5.1.2"><span class="header-section-number">5.1.2</span> 获取当前时间日期</h3>
<ul>
<li><code>now</code>函数</li>
</ul>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">now</span>(<span class="at">tzone =</span> <span class="st">&#39;Asia/Shanghai&#39;</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co">#base R</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">Sys.time</span>()</span></code></pre></div>
<p>输出结果中，<code>CST</code>是指中国标准时间，即时区概念。</p>
<p>查看时区，时区和所用系统设置相关</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.timezone</span>()</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="co"># windows 系统默认的时区 中国台北</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co"># linux 上是&quot;Asia/Shanghai&quot;</span></span></code></pre></div>
<ul>
<li><code>today</code>函数</li>
</ul>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>(<span class="at">tzone =</span> <span class="st">&#39;Asia/Shanghai&#39;</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co">#base R</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">Sys.Date</span>()</span></code></pre></div>
</div>
<div id="获取日期时间中的组成部分" class="section level3" number="5.1.3">
<h3 number="5.1.3"><span class="header-section-number">5.1.3</span> 获取日期时间中的组成部分</h3>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">#获取年</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(<span class="fu">now</span>())  </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co">#获取月</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="fu">month</span>(<span class="fu">now</span>())</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 当前时间所在年份天数</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="fu">yday</span>(<span class="fu">now</span>())</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 当前时间所在月天数</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mday</span>(<span class="fu">now</span>())</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 周几</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="fu">wday</span>(<span class="fu">now</span>(),<span class="at">label =</span> <span class="cn">TRUE</span>,<span class="at">week_start =</span> <span class="dv">1</span>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 所在时刻</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="fu">hour</span>(<span class="fu">now</span>())</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 所在时刻</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a><span class="fu">minute</span>(<span class="fu">now</span>())</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 所在时刻</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="fu">second</span>(<span class="fu">now</span>())</span></code></pre></div>
</div>
</div>
<div id="处理时区" class="section level2" number="5.2">
<h2 number="5.2"><span class="header-section-number">5.2</span> 处理时区</h2>
<p>如果生成数据时区与本地一致时，没必要处理，但是当数据是跨时区的或者不同生产系统的时区不一致，我们将要处理统一。</p>
<p>用<code>with_tz()</code>，<code>force_tz()</code>处理时区问题</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(<span class="st">&quot;2020-12-13 15:30:30&quot;</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>time</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Changes printing</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="fu">with_tz</span>(time, <span class="st">&quot;Asia/Shanghai&quot;</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Changes time</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="fu">force_tz</span>(time, <span class="st">&quot;Asia/Shanghai&quot;</span>)</span></code></pre></div>
</div>
<div id="解析日期和时间" class="section level2" number="5.3">
<h2 number="5.3"><span class="header-section-number">5.3</span> 解析日期和时间</h2>
<p>从时间表达式中提取想要时间。存储的数据源中日期列可能是各种的字符形式，需要转换为时间格式方便进行日期计算。商业环境中的数据是混乱的，生成库可能是不同的系统，导致时间日期格式混乱，如果没有BI，我们就需要自己清洗数据，将不同形式的日期格式转化为标准格式。</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 整数和字符都可以</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="dv">20200604</span>) </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">&#39;20200604&#39;</span>)</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mdy</span>(<span class="dv">06042020</span>)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dmy</span>(<span class="dv">04062020</span>)</span></code></pre></div>
<p>遇到unix 时间戳 可以用 .POSIXct()函数转化.</p>
<p><a href="https://unixtime.51240.com/">unix在线转换</a></p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.POSIXct</span>(<span class="dv">1591709615</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd_hms</span>(<span class="fu">.POSIXct</span>(<span class="dv">1591709615</span>))</span></code></pre></div>
<p>unix时间戳里面有时区的概念，在用mysql，RDS数据库时需要注意时区，特别是需要提取时间点时。lubridate包里面tz参数指定时区</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd_hms</span>(<span class="fu">.POSIXct</span>(<span class="dv">1591709615</span>),<span class="at">tz =</span> <span class="st">&#39;asia/shanghai&#39;</span>)</span></code></pre></div>
<p>从下面三个时间观察时区，CST时间:中央标准时间;UTC时间:世界协调时间(UTC)是世界上不同国家用来调节时钟和时间的主要时间标准。</p>
<p>如:当UTC时间为0点时，中国CST时间为8点，因为零时区和中国北京时区相差8个时区.</p>
<ul>
<li><a href="https://home.kpn.nl/vanadovv/time/TZworld.html#asi" class="uri">https://home.kpn.nl/vanadovv/time/TZworld.html#asi</a></li>
</ul>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as_datetime</span>(<span class="fu">now</span>()) <span class="co">#默认是UTC</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_datetime</span>(<span class="fu">now</span>(),<span class="at">tz =</span> <span class="st">&#39;asia/shanghai&#39;</span>)</span></code></pre></div>
</div>
<div id="构造日期或时间" class="section level2" number="5.4">
<h2 number="5.4"><span class="header-section-number">5.4</span> 构造日期或时间</h2>
<p>使用数值直接创建日期时间<code>make_date</code>和<code>make_datetime</code>函数默认时区为“UTC”</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_date</span>(<span class="at">year =</span> <span class="fu">year</span>(<span class="fu">today</span>()), <span class="at">month =</span> <span class="fu">month</span>(<span class="fu">today</span>()), <span class="at">day =</span> <span class="fu">day</span>(<span class="fu">today</span>()), <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make_datetime</span>(</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">year</span>(<span class="fu">today</span>()),</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> <span class="fu">month</span>(<span class="fu">today</span>()),</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">day =</span> <span class="fu">day</span>(<span class="fu">today</span>()),</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">hour =</span> <span class="fu">hour</span>(<span class="fu">now</span>()),</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">min =</span> <span class="fu">minute</span>(<span class="fu">now</span>()),</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sec =</span> <span class="fu">second</span>(<span class="fu">now</span>()),</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>使用数值或字符直接创建日期时间</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_datetime</span>(<span class="st">&#39;2020-01-09 09:15:40&#39;</span>,<span class="at">tz=</span><span class="st">&#39;asia/shanghai&#39;</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as_date</span>(<span class="st">&#39;2020-01-09&#39;</span>) <span class="co">#ymd格式</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="co">#as_date(&#39;2020/01/09&#39;)</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co">#as_date(&#39;20200109&#39;)</span></span></code></pre></div>
</div>
<div id="时间间隔" class="section level2" number="5.5">
<h2 number="5.5"><span class="header-section-number">5.5</span> 时间间隔</h2>
<p>我们可以用<code>lubridate</code>将时间间隔保存为<code>interveal</code>类对象</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>arrive <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(<span class="st">&quot;2020-12-04 12:00:00&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>arrive</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>leave <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(<span class="st">&quot;2020-12-10 14:00:00&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>leave</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">interval</span>(arrive, leave) </span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> arrive <span class="sc">%--%</span> leave</span></code></pre></div>
<p>两个时间间隔是否重复</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>jsm <span class="ot">&lt;-</span> <span class="fu">interval</span>(<span class="fu">ymd</span>(<span class="dv">20201020</span>, <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>), <span class="fu">ymd</span>(<span class="dv">20201231</span>, <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>))</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>jsm</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="fu">int_overlaps</span>(jsm, res)</span></code></pre></div>
<p>更多详细用法<code>?interveal</code></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interval</span>(<span class="at">start =</span> <span class="cn">NULL</span>, <span class="at">end =</span> <span class="cn">NULL</span>, <span class="at">tzone =</span> <span class="fu">tz</span>(start))</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>start <span class="sc">%--%</span> end</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="fu">is.interval</span>(x)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="fu">int_start</span>(int)</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a><span class="fu">int_start</span>(int) <span class="ot">&lt;-</span> value</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="fu">int_end</span>(int)</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a><span class="fu">int_end</span>(int) <span class="ot">&lt;-</span> value</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a><span class="fu">int_length</span>(int)</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a><span class="fu">int_flip</span>(int)</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a><span class="fu">int_shift</span>(int, by)</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a><span class="fu">int_overlaps</span>(int1, int2)</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a><span class="fu">int_standardize</span>(int)</span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a><span class="fu">int_aligns</span>(int1, int2)</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a><span class="fu">int_diff</span>(times)</span></code></pre></div>
</div>
<div id="时间日期计算" class="section level2" number="5.6">
<h2 number="5.6"><span class="header-section-number">5.6</span> 时间日期计算</h2>
<p>时间日期计算以<code>number line</code>为依据计算。原文是<code>Because the timeline is not as reliable as the number line</code>。</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">minutes</span>(<span class="dv">2</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dminutes</span>(<span class="dv">2</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dhours</span>(<span class="dv">2</span>)</span></code></pre></div>
<p>注意闰年时计算年份的差异</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leap_year</span>(<span class="dv">2019</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="dv">20190101</span>) <span class="sc">+</span> <span class="fu">dyears</span>(<span class="dv">1</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="dv">20190101</span>) <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="fu">leap_year</span>(<span class="dv">2020</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="dv">20200101</span>) <span class="sc">+</span> <span class="fu">dyears</span>(<span class="dv">1</span>)  <span class="co"># 注意查看闰年时的差异</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="dv">20200101</span>) <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span>)</span></code></pre></div>
<p><code>lubridate</code>中的函数都已向量化</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>meeting <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(<span class="st">&quot;2020-12-01 09:00:00&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;asia/shanghai&quot;</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>meeting <span class="ot">&lt;-</span> meeting <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>meeting <span class="sc">%within%</span> jsm</span></code></pre></div>
<p>除法计算</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>res <span class="sc">/</span> <span class="fu">ddays</span>(<span class="dv">1</span>)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>res <span class="sc">/</span> <span class="fu">dminutes</span>(<span class="dv">1</span>)</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%/%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span></code></pre></div>
<p><code>as.period</code>用法</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.period</span>(res <span class="sc">%%</span> <span class="fu">months</span>(<span class="dv">1</span>))</span></code></pre></div>
<p>对于日期而言，因为月天数、年天数不一致，导致不能直接加减天数，如下：</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>jan31 <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">&quot;2020-01-31&quot;</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>jan31 <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span></code></pre></div>
<p><code>lubridate</code>中不存在的日期返回<code>NA</code></p>
<p>解决方案是：<code>%m+%</code>或<code>%m-%</code></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>jan31 <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>jan31 <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span></code></pre></div>
</div>
<div id="案例" class="section level2" number="5.7">
<h2 number="5.7"><span class="header-section-number">5.7</span> 案例</h2>
<div id="年同环比" class="section level3" number="5.7.1">
<h3 number="5.7.1"><span class="header-section-number">5.7.1</span> 年同环比</h3>
<p><code>floor_date()</code>函数根据要求周期回滚日期，</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">floor_date</span>(<span class="fu">today</span>(),<span class="at">unit =</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">floor_date</span>(<span class="fu">today</span>(),<span class="at">unit =</span> <span class="st">&#39;month&#39;</span>) <span class="co">#可与rollback函数达到同样效果</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="fu">floor_date</span>(<span class="fu">today</span>(),<span class="at">unit =</span> <span class="st">&#39;week&#39;</span>)</span></code></pre></div>
<ul>
<li>计算年同比</li>
</ul>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">today</span>()</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># current </span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>current_start_date <span class="ot">&lt;-</span>  <span class="fu">floor_date</span>(date,<span class="at">unit =</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>current_start_date</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>date </span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co"># last year</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>last_start_date <span class="ot">&lt;-</span> <span class="fu">floor_date</span>(date,<span class="at">unit =</span> <span class="st">&#39;year&#39;</span>) <span class="sc">%m-%</span> <span class="fu">years</span>(n)</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>last_start_date</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>last_end_date <span class="ot">&lt;-</span> date <span class="sc">%m-%</span> <span class="fu">years</span>(n)</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>last_end_date</span></code></pre></div>
<p>月同比类似，回滚时间周期调整为“month”即可</p>
<ul>
<li>计算月环比</li>
</ul>
<p><code>%m+%</code>或<code>%m-%</code>可以很好解决月份天数不一的问题</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_date</span>(<span class="st">&#39;2020-03-30&#39;</span>) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>()</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>() <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span></code></pre></div>
<p>得到了两对时间周期，然后在订单数据或者其他中筛选即可获得同比维度数据</p>
<p>模拟计算</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造数据</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>bill_date <span class="ot">&lt;-</span> <span class="fu">as_date</span>((<span class="fu">as_date</span>(<span class="st">&#39;2019-01-01&#39;</span>)<span class="sc">:</span><span class="fu">as_date</span>(<span class="st">&#39;2020-12-01&#39;</span>)))</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>area <span class="ot">&lt;-</span>  <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&#39;华东&#39;</span>,<span class="st">&#39;华西&#39;</span>,<span class="st">&#39;华南&#39;</span>,<span class="st">&#39;华北&#39;</span>),<span class="at">size =</span> <span class="fu">length</span>(bill_date),<span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">bill_date =</span> bill_date ,<span class="at">money =</span> <span class="fu">sample</span>(<span class="dv">80</span><span class="sc">:</span><span class="dv">150</span>,<span class="at">size =</span> <span class="fu">length</span>(bill_date),<span class="at">replace =</span> <span class="cn">TRUE</span>),<span class="at">area =</span> area)</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt)</span></code></pre></div>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr,<span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>y_to_y <span class="ot">&lt;-</span> <span class="cf">function</span>(.dt,date,<span class="at">n =</span> <span class="dv">1</span>,...){</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  date <span class="ot">&lt;-</span> <span class="fu">ymd</span>(date)</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(date)){</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&#39;请输入正确日期格式，如20200101&#39;</span>)</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current </span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a> current_start_date <span class="ot">&lt;-</span>  <span class="fu">floor_date</span>(date,<span class="at">unit =</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a> <span class="co"># last year</span></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a> last_start_date <span class="ot">&lt;-</span> <span class="fu">floor_date</span>(date,<span class="at">unit =</span> <span class="st">&#39;year&#39;</span>) <span class="sc">%m-%</span> <span class="fu">years</span>(n)</span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a> last_end_date <span class="ot">&lt;-</span> date <span class="sc">%m-%</span> <span class="fu">years</span>(n)</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a> .dt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>( 类型 <span class="ot">=</span> <span class="fu">case_when</span>(<span class="fu">between</span>(bill_date,current_start_date,date) <span class="sc">~</span> <span class="st">&quot;当前&quot;</span>,</span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>               <span class="fu">between</span>(bill_date,last_start_date,last_end_date) <span class="sc">~</span> <span class="st">&quot;同期&quot;</span>,</span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>               <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;其他&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(类型 <span class="sc">!=</span> <span class="st">&quot;其他&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(...) <span class="sc">%&gt;%</span> </span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(金额 <span class="ot">=</span> <span class="fu">sum</span>(money,<span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ungroup</span>() </span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a> <span class="co">#%&gt;% pivot_wider(names_from = &#39;类型&#39;,values_from = &#39;金额&#39;)</span></span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">y_to_y</span>(dt,<span class="at">date =</span> <span class="st">&#39;20200101&#39;</span>,<span class="at">n =</span> <span class="dv">1</span>,area,类型)</span></code></pre></div>
</div>
<div id="清洗不同类型日期格式" class="section level3" number="5.7.2">
<h3 number="5.7.2"><span class="header-section-number">5.7.2</span> 清洗不同类型日期格式</h3>
<p>如将<code>c('2001/2/13 10:33','1/24/13 11:16')</code>转换为相同格式的日期格式;</p>
<p>通过一个简单自定义函数解决，本质是区分不同类型日期后采用不同函数去解析日期格式</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>date1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;2001/2/13 10:33&#39;</span>,<span class="st">&#39;1/24/13 11:16&#39;</span>)</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  n_length <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> n_length)</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_length){</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(x[i],<span class="st">&#39;/&#39;</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[[</span><span class="st">`</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[[</span><span class="st">`</span>(<span class="dv">1</span>)</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">str_length</span>(n)<span class="sc">==</span><span class="dv">4</span>){</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>      res[i] <span class="ot">&lt;-</span> <span class="fu">ymd_hm</span>(x[i],<span class="at">tz =</span> <span class="st">&#39;Asia/Shanghai&#39;</span>)</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>      res[i] <span class="ot">&lt;-</span> <span class="fu">mdy_hm</span>(x[i],<span class="at">tz =</span> <span class="st">&#39;Asia/Shanghai&#39;</span>)</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_datetime</span>(res,<span class="at">tz =</span> <span class="st">&#39;Asia/Shanghai&#39;</span>)</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a><span class="fu">myfun</span>(date1)</span></code></pre></div>
</div>
<div id="扫码后中奖时间匹配" class="section level3" number="5.7.3">
<h3 number="5.7.3"><span class="header-section-number">5.7.3</span> 扫码后中奖时间匹配</h3>
<p>假定有两张表，一张是用户扫码表，一张是用户中奖表，如下所示：</p>
<div class="figure">
<img src="picture/datetime/p1.png" alt="" />
<p class="caption">数据源视图</p>
</div>
<p>由于中奖时间和扫码时间不完全一致，导致没办法直接通过<code>客户ID</code>以及<code>时间</code>关联匹配找到客户每次中奖时的积分码,现在要求找到客户每次中奖时对应的积分码？</p>
<p>思路：通过观察数据，发现扫码后如果中奖，一般几秒钟内会有中奖记录，那我们就可以通过“每次中奖时间最近的一次扫码时间的积分码”就是该次中奖对应的积分码解决问题。这样我们通过简单编写自定义函数即可获取答案，即一个时间点从一串时间中找到离自己最近时间点。</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>testfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y){</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>() <span class="co">#应采用列表存储结果向量化</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  n  <span class="ot">&lt;-</span>  <span class="fu">length</span>(x)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> x[i]<span class="sc">-</span>y</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">abs</span>(res) <span class="sc">%&gt;%</span> <span class="fu">which.min</span>() <span class="co">#本处不对，应该判断res大于0的部分中谁最小</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>    kong <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(中奖时间 <span class="ot">=</span> x[i],扫的时间 <span class="ot">=</span> y[res])</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">rbind</span>(kong,result)</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">testfun</span>(dt<span class="sc">$</span>时间,scan_dt<span class="sc">$</span>时间)</span></code></pre></div>
<p>改进代码</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>testfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y){</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  n  <span class="ot">&lt;-</span>  <span class="fu">length</span>(x)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> y[x<span class="sc">&gt;</span>y]</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> x[i]<span class="sc">-</span>y</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">which.min</span>() </span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    kong <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(中奖时间 <span class="ot">=</span> x[i],扫的时间 <span class="ot">=</span> y[res])</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    result[[i]] <span class="ot">&lt;-</span> kong</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">testfun</span>(dt<span class="sc">$</span>时间,scan_dt<span class="sc">$</span>时间)</span></code></pre></div>
<p>理论上不同用户可以在同一时间扫码且同时中奖，那上面的代码即不可以获取正确答案。但是我们只要通过按照用户ID切割数据框后稍微改造上面的自定义函数即可。</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>testfun <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> dt<span class="sc">$</span>中奖时间</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> dt<span class="sc">$</span>扫的时间</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  n  <span class="ot">&lt;-</span>  <span class="fu">length</span>(x)</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> y[x<span class="sc">&gt;</span>y]</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> x[i]<span class="sc">-</span>y</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">which.min</span>() </span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    kong <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(中奖时间 <span class="ot">=</span> x[i],扫的时间 <span class="ot">=</span> y[res])</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>    result[[i]] <span class="ot">&lt;-</span> kong</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(result)</span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>dtlist <span class="ot">&lt;-</span> <span class="fu">split</span>(alldt,<span class="st">&#39;客户ID&#39;</span>)</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map_dfr</span>(dtlist,testfun)</span></code></pre></div>
<p>虽然可以通过寻找最近一次的扫码记录判断积分码，但是因为网络延迟或中途接电话等各种原因导致扫码时间和中奖时间相差并不是几秒，导致情景复杂，那我们就应该在设计系统时就设计好锁定对应关系，从根本上解决问题。</p>
</div>
</div>
<div id="资料" class="section level2" number="5.8">
<h2 number="5.8"><span class="header-section-number">5.8</span> 资料</h2>
<ul>
<li><p><a href="https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html" class="uri">https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html</a></p></li>
<li><p><a href="https://www.rdocumentation.org/packages/lubridate/versions/1.7.8" class="uri">https://www.rdocumentation.org/packages/lubridate/versions/1.7.8</a></p></li>
<li><p>pdf 下载 <a href="https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf" class="uri">https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf</a></p></li>
<li><p>Excle中dax时间智能函数 <a href="https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax" class="uri">https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax</a></p></li>
</ul>
<!--chapter:end:04-lubridate.Rmd-->
</div>
</div>
<div id="forcats" class="section level1" number="6">
<h1 number="6"><span class="header-section-number">6</span> forcats</h1>
<p>我在实际工作中因子数据类型使用较少,forcats软件包用来处理因子,该软件包是tidyverse的一部分.</p>
<p>因子是用于对数据进行分类的R的一种数据类型. 它们可以存储字符串和整数.它们在具有有限数量的唯一值的列中很有用. 像“男性”，“女性”和True，False等。它们在统计建模的数据分析中很有用.</p>
<p>因子变量会占用更小空间,R4.0改变了字符默认为因子的方式.想了解更多请参考 <a href="https://r4ds.had.co.nz/factors.html" class="uri">https://r4ds.had.co.nz/factors.html</a></p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(<span class="fu">rep</span>(letters,<span class="dv">100000</span>))</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(<span class="fu">rep</span>(forcats<span class="sc">::</span><span class="fu">as_factor</span>(letters),<span class="dv">100000</span>))</span></code></pre></div>
<div id="创建因子" class="section level2" number="6.1">
<h2 number="6.1"><span class="header-section-number">6.1</span> 创建因子</h2>
<p>实际工作中,可能各个事业部或部门之间没有实际顺序,但是在数据处理过程中需要指定顺序可以用因子.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;部门a&#39;</span>,<span class="st">&#39;部门b&#39;</span>,<span class="st">&#39;部门d&#39;</span>,<span class="st">&#39;部门f&#39;</span>)</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(vec1)</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>vec2 <span class="ot">&lt;-</span> <span class="fu">as_factor</span>(<span class="fu">c</span>(<span class="st">&#39;部门f&#39;</span>,<span class="st">&#39;部门d&#39;</span>,<span class="st">&#39;部门a&#39;</span>,<span class="st">&#39;部门b&#39;</span>))</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(vec2)</span></code></pre></div>
<p>如上所示:实际工作中可以通过指定因子水平从而达到排序效果,在可视化中也可以运用,像指定X轴的顺序.</p>
<!--chapter:end:05-forcats.Rmd-->
</div>
</div>
<div id="tidyr" class="section level1" number="7">
<h1 number="7"><span class="header-section-number">7</span> tidyr</h1>
<p><code>tidyr</code>包是<code>tidyverse</code>系列中的核心包,<code>tidyr</code>包的核心目的是整洁数据，有以下特征：</p>
<ul>
<li>每列都是一个变量</li>
<li>每行都是一个记录</li>
<li>每个单元格都是一个值</li>
</ul>
<p>在日常使用数据过程中，这种数据存储方式是一种标准的数据存储方式，像关系型数据中数据的存储。</p>
<div id="安装-2" class="section level2" number="7.1">
<h2 number="7.1"><span class="header-section-number">7.1</span> 安装</h2>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 最简单是的方式就是安装tidyverse</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;tidyverse&#39;</span>)</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 或者仅仅安装 tidyr:</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;tidyr&#39;</span>)</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 或者从github 安装开发版本</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="do">## install.packages(&quot;devtools&quot;)</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;tidyverse/tidyr&quot;</span>)</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a><span class="co"># CTEST CODE</span></span></code></pre></div>
</div>
<div id="主要功能" class="section level2" number="7.2">
<h2 number="7.2"><span class="header-section-number">7.2</span> 主要功能</h2>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span></code></pre></div>
<p><code>tidyr</code>包中的函数可以分为5个主要大类</p>
<ul>
<li><p><code>pivot_longer()</code> 和 <code>pivot_wider()</code> 宽转长以及长转宽</p></li>
<li><p><code>unnest_longer()</code> 和 <code>unnest_wider()</code>,<code>hoist()</code> 将列表嵌套转化为整洁数据</p></li>
<li><p><code>nest()</code> 数据嵌套</p></li>
<li><p><code>separate()</code>,<code>extract()</code>拆分列,提取新列</p></li>
<li><p><code>replace_na()</code> 缺失值处理</p></li>
</ul>
<div id="宽转长" class="section level3" number="7.2.1">
<h3 number="7.2.1"><span class="header-section-number">7.2.1</span> 宽转长</h3>
<p>详情查看<code>vignette("pivot")</code>,以下是照搬该图册中的内容</p>
<div id="基础-1" class="section level4" number="7.2.1.1">
<h4 number="7.2.1.1"><span class="header-section-number">7.2.1.1</span> 基础</h4>
<p>长数据与宽数据之间的转换，类似我们常用的EXcel中的透视表功能。接下来用<code>tidyr</code>包自带的插图案例记录相关函数用法</p>
<p>在Excel中有时候方便我们肉眼观察，可能一个数据集会有很多列,如下所示：</p>
<table>
<thead>
<tr class="header">
<th>col1</th>
<th>col2</th>
<th>col3</th>
<th>col4</th>
<th>col5</th>
<th>col6</th>
<th>col7</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>v1</td>
<td>v2</td>
<td>v3</td>
<td>v4</td>
<td>v5</td>
<td>v6</td>
<td>v7</td>
</tr>
<tr class="even">
<td>vb1</td>
<td>vb2</td>
<td>vb3</td>
<td>vb4</td>
<td>vb5</td>
<td>vb6</td>
<td>vb7</td>
</tr>
</tbody>
</table>
<p>方便观察，但是不方便统计分析，这是我们需要把数据做处理，从“宽数据变成长数据”即宽转长。</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span></code></pre></div>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>relig_income <span class="sc">%&gt;%</span> </span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">!</span>religion,<span class="at">names_to =</span> <span class="st">&#39;income&#39;</span>,<span class="at">values_to =</span> <span class="st">&quot;count&quot;</span>)</span></code></pre></div>
<ul>
<li>第一个参数是数据集</li>
<li>第二个参数是那些列需要重塑，在该例中除了<code>religion</code>的其他全部列</li>
<li><code>names_to</code>这个参数是新增的列名</li>
<li><code>values_to</code>是新增的存储之前数据集中数据的列名</li>
</ul>
</div>
<div id="列名带数字" class="section level4" number="7.2.1.2">
<h4 number="7.2.1.2"><span class="header-section-number">7.2.1.2</span> 列名带数字</h4>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>billboard <span class="sc">%&gt;%</span> </span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;wk&quot;</span>), </span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;week&quot;</span>, </span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><code>names_prefix</code> 调整内容前缀，配合<code>names_transform</code>参数使用</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>billboard <span class="sc">%&gt;%</span> </span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;wk&quot;</span>), </span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;week&quot;</span>, </span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">&quot;wk&quot;</span>,</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_transform =</span> <span class="fu">list</span>(<span class="at">week =</span> as.integer),</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>经过以上转换<code>week</code>列属性变成了整数，当然达到以上效果有其他的途径，如下：</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse,<span class="at">warn.conflicts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="co"># method 1</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>billboard <span class="sc">%&gt;%</span> </span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;wk&quot;</span>), </span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;week&quot;</span>, </span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_transform =</span> <span class="fu">list</span>(<span class="at">week =</span> readr<span class="sc">::</span>parse_number),</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a><span class="co"># method 2</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>billboard <span class="sc">%&gt;%</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;wk&quot;</span>),</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;week&quot;</span>,</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>,</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">week =</span> <span class="fu">str_remove</span>(week, <span class="st">&quot;wk&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>())</span></code></pre></div>
</div>
<div id="多变量列名" class="section level4" number="7.2.1.3">
<h4 number="7.2.1.3"><span class="header-section-number">7.2.1.3</span> 多变量列名</h4>
<p>该案列设计比较复杂的正则表达式,<code>new_?(.*)_(.)(.*)</code>需要一定正则表达式基础。
<code>new_?</code>表示匹配<code>new</code>或<code>new_</code>，<code>(.*)</code>匹配任意0次或多次任意字符。</p>
<p><a href="https://www.runoob.com/regexp/regexp-syntax.html">正则表达式介绍</a></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>who <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cols =</span> new_sp_m014<span class="sc">:</span>newrel_f65,</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;diagnosis&quot;</span>, <span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age&quot;</span>), </span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_pattern =</span> <span class="st">&quot;new_?(.*)_(.)(.*)&quot;</span>,</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_to =</span> <span class="st">&quot;count&quot;</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>进一步处理列<code>gender</code>，<code>age</code> 。</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>who <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cols =</span> new_sp_m014<span class="sc">:</span>newrel_f65,</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;diagnosis&quot;</span>, <span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age&quot;</span>), </span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_pattern =</span> <span class="st">&quot;new_?(.*)_(.)(.*)&quot;</span>,</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_transform =</span> <span class="fu">list</span>(</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="sc">~</span> readr<span class="sc">::</span><span class="fu">parse_factor</span>(.x, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;f&quot;</span>, <span class="st">&quot;m&quot;</span>)),</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="sc">~</span> readr<span class="sc">::</span><span class="fu">parse_factor</span>(</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>      .x,</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;014&quot;</span>, <span class="st">&quot;1524&quot;</span>, <span class="st">&quot;2534&quot;</span>, <span class="st">&quot;3544&quot;</span>, <span class="st">&quot;4554&quot;</span>, <span class="st">&quot;5564&quot;</span>, <span class="st">&quot;65&quot;</span>), </span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">ordered =</span> <span class="cn">TRUE</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_to =</span> <span class="st">&quot;count&quot;</span>,</span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="一行多观测值" class="section level4" number="7.2.1.4">
<h4 number="7.2.1.4"><span class="header-section-number">7.2.1.4</span> 一行多观测值</h4>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>family, <span class="sc">~</span>dob_child1, <span class="sc">~</span>dob_child2, <span class="sc">~</span>gender_child1, <span class="sc">~</span>gender_child2,</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  1L, <span class="st">&quot;1998-11-26&quot;</span>, <span class="st">&quot;2000-01-29&quot;</span>, 1L, 2L,</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>  2L, <span class="st">&quot;1996-06-22&quot;</span>, <span class="cn">NA</span>, 2L, <span class="cn">NA</span>,</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>  3L, <span class="st">&quot;2002-07-11&quot;</span>, <span class="st">&quot;2004-04-05&quot;</span>, 2L, 2L,</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>  4L, <span class="st">&quot;2004-10-10&quot;</span>, <span class="st">&quot;2009-08-27&quot;</span>, 1L, 1L,</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  5L, <span class="st">&quot;2000-12-05&quot;</span>, <span class="st">&quot;2005-02-28&quot;</span>, 2L, 1L,</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> family <span class="sc">%&gt;%</span> <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;dob&quot;</span>)), parse_date)</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>family</span></code></pre></div>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>family <span class="sc">%&gt;%</span> </span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>family, </span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;child&quot;</span>), </span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>, </span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>anscombe <span class="sc">%&gt;%</span> </span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;set&quot;</span>), </span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">&quot;(.)(.)&quot;</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(set)</span></code></pre></div>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>pnl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> <span class="fu">rnorm</span>(<span class="dv">4</span>),</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y2 =</span> <span class="fu">rnorm</span>(<span class="dv">4</span>),</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">z1 =</span> <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">z2 =</span> <span class="fu">rep</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>pnl <span class="sc">%&gt;%</span> </span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">c</span>(x, a, b), </span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;time&quot;</span>), </span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">&quot;(.)(.)&quot;</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="重复列名" class="section level4" number="7.2.1.5">
<h4 number="7.2.1.5"><span class="header-section-number">7.2.1.5</span> 重复列名</h4>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">y =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">y =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">.name_repair =</span> <span class="st">&quot;minimal&quot;</span>)</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">!</span>id, <span class="at">names_to =</span> <span class="st">&quot;name&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="长转宽" class="section level3" number="7.2.2">
<h3 number="7.2.2"><span class="header-section-number">7.2.2</span> 长转宽</h3>
<p><code>pivot_wider()</code>功能与<code>pivot_longer()</code>相反。通过增加列数减少行数使数据集变得更宽，通常我们在汇总时候使用，达到类似Excel透视表结果。</p>
<div id="基础-2" class="section level4" number="7.2.2.1">
<h4 number="7.2.2.1"><span class="header-section-number">7.2.2.1</span> 基础</h4>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>fish_encounters <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> station, <span class="at">values_from =</span> seen)</span></code></pre></div>
<p>缺失值填充</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>fish_encounters <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_from =</span> station, </span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_from =</span> seen,</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="聚合" class="section level4" number="7.2.2.2">
<h4 number="7.2.2.2"><span class="header-section-number">7.2.2.2</span> 聚合</h4>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>warpbreaks <span class="ot">&lt;-</span> warpbreaks <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() </span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>warpbreaks <span class="sc">%&gt;%</span> <span class="fu">count</span>(wool, tension)</span></code></pre></div>
<p>需要通过<code>values_fn</code>指定聚合方式</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>warpbreaks <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> wool, <span class="at">values_from =</span> breaks,<span class="at">values_fn=</span> <span class="fu">list</span>(<span class="at">breaks =</span> sum))</span></code></pre></div>
</div>
<div id="从多个变量生成新列名" class="section level4" number="7.2.2.3">
<h4 number="7.2.2.3"><span class="header-section-number">7.2.2.3</span> 从多个变量生成新列名</h4>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>production <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">product =</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), </span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">c</span>(<span class="st">&quot;AI&quot;</span>, <span class="st">&quot;EI&quot;</span>), </span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2014</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((product <span class="sc">==</span> <span class="st">&quot;A&quot;</span> <span class="sc">&amp;</span> country <span class="sc">==</span> <span class="st">&quot;AI&quot;</span>) <span class="sc">|</span> product <span class="sc">==</span> <span class="st">&quot;B&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">production =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(.)))</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>production</span></code></pre></div>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>production <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_from =</span> <span class="fu">c</span>(product, country), </span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_from =</span> production</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>通过<code>names_sep</code>和<code>names_prefix</code>参数控制新的列名，或通过<code>names_glue</code></p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>production <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_from =</span> <span class="fu">c</span>(product, country), </span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_from =</span> production,</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_sep =</span> <span class="st">&quot;.&quot;</span>,</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_prefix =</span> <span class="st">&quot;prod.&quot;</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>production <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_from =</span> <span class="fu">c</span>(product, country), </span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values_from =</span> production,</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">names_glue =</span> <span class="st">&quot;prod_{product}_{country}&quot;</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="多值变宽" class="section level4" number="7.2.2.4">
<h4 number="7.2.2.4"><span class="header-section-number">7.2.2.4</span> 多值变宽</h4>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>us_rent_income <span class="sc">%&gt;%</span> </span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> variable, <span class="at">values_from =</span> <span class="fu">c</span>(estimate, moe))</span></code></pre></div>
</div>
</div>
<div id="处理jsonhtml的数据" class="section level3" number="7.2.3">
<h3 number="7.2.3"><span class="header-section-number">7.2.3</span> 处理json,html的数据</h3>
<p>实际工作中不是经常使用，需要使用的时候往往会用相关的包处理：<code>jsonlite</code></p>
<p>可通过<code>vignette("rectangle")</code>自行学习</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(repurrrsive)</span></code></pre></div>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>users <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">user =</span> gh_users)</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>users</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>users <span class="sc">%&gt;%</span> <span class="fu">unnest_wider</span>(user)</span></code></pre></div>
</div>
<div id="嵌套数据" class="section level3" number="7.2.4">
<h3 number="7.2.4"><span class="header-section-number">7.2.4</span> 嵌套数据</h3>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span></code></pre></div>
<div id="基础-3" class="section level4" number="7.2.4.1">
<h4 number="7.2.4.1"><span class="header-section-number">7.2.4.1</span> 基础</h4>
<p>嵌套数据即：数据框中嵌套数据框，如下所示：</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">g =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">2</span>),</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">y =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">10</span>)</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>df1</span></code></pre></div>
<p>因为<code>data.frame()</code>的列特性【每列都是列表】【不确定理解对不对】：可以做如下操作：</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>g, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>   <span class="dv">1</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>   <span class="dv">2</span>,  <span class="dv">4</span>,  <span class="dv">6</span>,</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>   <span class="dv">2</span>,  <span class="dv">5</span>,  <span class="dv">7</span>,</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>   <span class="dv">3</span>, <span class="dv">10</span>,  <span class="cn">NA</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>df2 <span class="sc">%&gt;%</span> <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">c</span>(x, y))</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="co">#sample above</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a><span class="co">#df2 %&gt;% group_by(g) %&gt;% nest()</span></span></code></pre></div>
<p>nest的反面 unnest</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="sc">%&gt;%</span> <span class="fu">unnest</span>(data)</span></code></pre></div>
</div>
</div>
<div id="嵌套数据和模型" class="section level3" number="7.2.5">
<h3 number="7.2.5"><span class="header-section-number">7.2.5</span> 嵌套数据和模型</h3>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>mtcars_nested <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">%&gt;%</span> </span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>mtcars_nested</span></code></pre></div>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>mtcars_nested <span class="ot">&lt;-</span> mtcars_nested <span class="sc">%&gt;%</span> </span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="cf">function</span>(df) <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> df)))</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>mtcars_nested</span></code></pre></div>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>mtcars_nested <span class="ot">&lt;-</span> mtcars_nested <span class="sc">%&gt;%</span> </span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(model, predict))</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>mtcars_nested  </span></code></pre></div>
</div>
<div id="拆分和合并" class="section level3" number="7.2.6">
<h3 number="7.2.6"><span class="header-section-number">7.2.6</span> 拆分和合并</h3>
<div id="拆分" class="section level4" number="7.2.6.1">
<h4 number="7.2.6.1"><span class="header-section-number">7.2.6.1</span> 拆分</h4>
<p>有时我们需要将一列拆分为多列：</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">&quot;a.b&quot;</span>, <span class="st">&quot;a.d&quot;</span>, <span class="st">&quot;b.c&quot;</span>))</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span></code></pre></div>
<p>拆分数多列或少列时用<code>NA</code>补齐：</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;a b&quot;</span>, <span class="st">&quot;a b c&quot;</span>, <span class="cn">NA</span>))</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</span></code></pre></div>
<p>多余的部分舍弃，缺失填充在左边还是右边：</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The same behaviour as previous, but drops the c without warnings:</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="at">extra =</span> <span class="st">&quot;drop&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;right&quot;</span>)</span></code></pre></div>
<p>多余部分合并，缺失填充在左边</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="at">extra =</span> <span class="st">&quot;merge&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;left&quot;</span>)</span></code></pre></div>
<p>或者全部保留</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))</span></code></pre></div>
<p>指定分隔符</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;key&quot;</span>, <span class="st">&quot;value&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>, <span class="at">extra =</span> <span class="st">&quot;merge&quot;</span>)</span></code></pre></div>
<p>使用正则表达式</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use regular expressions to separate on multiple characters:</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">&quot;a?b&quot;</span>, <span class="st">&quot;a.d&quot;</span>, <span class="st">&quot;b:c&quot;</span>))</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">separate</span>(x, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;([.?:])&quot;</span>)</span></code></pre></div>
</div>
<div id="新列提取" class="section level4" number="7.2.6.2">
<h4 number="7.2.6.2"><span class="header-section-number">7.2.6.2</span> 新列提取</h4>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">&quot;a-b&quot;</span>, <span class="st">&quot;a-d&quot;</span>, <span class="st">&quot;b-c&quot;</span>, <span class="st">&quot;d-e&quot;</span>))</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">extract</span>(x, <span class="st">&quot;A&quot;</span>)</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">extract</span>(x, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="st">&quot;([[:alnum:]]+)-([[:alnum:]]+)&quot;</span>)</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [:alnum:] 匹配字母和数字</span></span></code></pre></div>
<p>以上本质是字符处理，<a href="http://baiy.cn/utils/_regex_doc/index.htm">正则表达式</a></p>
</div>
<div id="合并" class="section level4" number="7.2.6.3">
<h4 number="7.2.6.3"><span class="header-section-number">7.2.6.3</span> 合并</h4>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="cn">NA</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>, <span class="cn">NA</span>))</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;z&quot;</span>, x<span class="sc">:</span>y, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expand_grid 类似笛卡尔积功能</span></span></code></pre></div>
<p>移除缺失值</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;z&quot;</span>, x<span class="sc">:</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>合并后再拆分</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(<span class="st">&quot;xy&quot;</span>, x<span class="sc">:</span>y) <span class="sc">%&gt;%</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(xy, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</span></code></pre></div>
</div>
</div>
<div id="缺失值处理" class="section level3" number="7.2.7">
<h3 number="7.2.7"><span class="header-section-number">7.2.7</span> 缺失值处理</h3>
<p><code>replace_na()</code>用特定值替换缺失值。</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="cn">NA</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="cn">NA</span>, <span class="st">&quot;b&quot;</span>))</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="st">&quot;unknown&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">replace_na</span>(x, <span class="dv">0</span>))</span></code></pre></div>
<!--chapter:end:06-tidyr-package.Rmd-->
</div>
</div>
</div>
<div id="dplyr" class="section level1" number="8">
<h1 number="8"><span class="header-section-number">8</span> dplyr</h1>
<p>利用<code>R</code>语言完成与<code>Excel透视表</code>或<code>sql</code>语句的功能，将从条件筛选、排序、分组聚合等几个方面记录<code>R</code>的实现方式。</p>
<p>与<code>sql</code>相比，用R实现相同功能的好处：</p>
<ul>
<li><p>代码量极大减少</p></li>
<li><p>当逻辑复杂时，<code>R</code>可以按照顺序一步步实现，无需嵌套，实现过程简单</p></li>
<li><p>该包就是从数据库相关操作中抽象而来，迁移成本低</p></li>
<li><p>配合<code>dbplyr</code>包使用，大部分情况下可以扔掉<code>sql</code>语法，从而实现不同数据库间语法并不完全一致时，代码的重复使用性</p></li>
</ul>
<div id="前言" class="section level2" number="8.1">
<h2 number="8.1"><span class="header-section-number">8.1</span> 前言</h2>
<p><code>dplyr</code>包是<code>tidyverse</code>系列中的核心包之一,<code>dplyr</code>包提供了一组一致的动词来解决最常见的数据处理难题：</p>
<ul>
<li><p><code>mutate()</code> 添加新变量,现有变量的函数</p></li>
<li><p><code>select()</code> 筛选列,根据现有变量名称选择变量</p></li>
<li><p><code>filter()</code> 筛选行，根据条件筛选</p></li>
<li><p><code>summarise()</code> 按照一定条件汇总聚合</p></li>
<li><p><code>arrange()</code> 行排序</p></li>
</ul>
</div>
<div id="安装-3" class="section level2" number="8.2">
<h2 number="8.2"><span class="header-section-number">8.2</span> 安装</h2>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 最简单是的方式就是安装tidyverse</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;tidyverse&#39;</span>)</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 或者仅仅安装 tidyr:</span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;dplyr&#39;</span>)</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 或者从github 安装开发版本</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="do">## install.packages(&quot;devtools&quot;)</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;tidyverse/dplyr&quot;</span>)</span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="co"># CTEST CODE</span></span></code></pre></div>
</div>
<div id="基础用法-2" class="section level2" number="8.3">
<h2 number="8.3"><span class="header-section-number">8.3</span> 基础用法</h2>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
<div id="filter" class="section level3" number="8.3.1">
<h3 number="8.3.1"><span class="header-section-number">8.3.1</span> filter</h3>
<ul>
<li>单条件筛选</li>
</ul>
<p>类似Excel表格中筛选功能，筛选条件为<code>species == "Droid"</code></p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;Droid&quot;</span>)</span></code></pre></div>
<ul>
<li>多条件</li>
</ul>
<p>多条件筛选时，用逗号隔开条件</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;Droid&quot;</span>,skin_color <span class="sc">==</span> <span class="st">&quot;gold&quot;</span>)</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="co"># starwars %&gt;% </span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(species == &quot;Droid&quot; &amp; skin_color == &quot;white&quot;)</span></span></code></pre></div>
<ul>
<li>多情况筛选</li>
</ul>
<p>类似<code>SQL</code>中 <code>in</code> 的用法，或Excel中筛选条件时“或”条件</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(species <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">&quot;Droid&quot;</span>,<span class="st">&#39;Clawdite&#39;</span>))</span></code></pre></div>
<ul>
<li>逻辑值筛选</li>
</ul>
<p>注意<code>|</code> ,<code>&amp;</code>,<code>!</code>等逻辑判断符号 , <code>|</code>为 或, <code>&amp;</code> 为并、且条件，<code>!</code>为非,灵活运用可以方便做条件筛选</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(flights, <span class="sc">!</span>(arr_delay <span class="sc">&gt;</span> <span class="dv">120</span> <span class="sc">|</span> dep_delay <span class="sc">&gt;</span> <span class="dv">120</span>))</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(flights, arr_delay <span class="sc">&lt;=</span> <span class="dv">120</span>, dep_delay <span class="sc">&lt;=</span> <span class="dv">120</span>)</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(flights, arr_delay <span class="sc">&lt;=</span> <span class="dv">120</span> <span class="sc">&amp;</span> dep_delay <span class="sc">&lt;=</span> <span class="dv">120</span>)</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a><span class="co"># %in% 的反面</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>species <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">&quot;Droid&quot;</span>,<span class="st">&#39;Clawdite&#39;</span>))</span></code></pre></div>
</div>
<div id="select" class="section level3" number="8.3.2">
<h3 number="8.3.2"><span class="header-section-number">8.3.2</span> select</h3>
<p>当数据集较大列数较多时，我们可能并不需要那么多列，可以通过<code>select()</code>筛选：</p>
<ul>
<li>基础用法</li>
</ul>
<p>通过指定列名称筛选，顺便指定列之间顺序</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name,height,mass,hair_color,skin_color,eye_color)</span></code></pre></div>
<ul>
<li>列索引</li>
</ul>
<p>通过列名或数字向量索引，但是不建议用列索引，避免原始数据列顺序变化后导致报错。</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name <span class="sc">:</span> eye_color)</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="co">#same above</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="co"># starwars %&gt;% </span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(c(1,2,4,5,7))</span></span></code></pre></div>
</div>
<div id="rename" class="section level3" number="8.3.3">
<h3 number="8.3.3"><span class="header-section-number">8.3.3</span> rename</h3>
<p>列重命名使用<code>rename()</code>函数，新名称写前面，如下所示：</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">home_world =</span> homeworld)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 多列同换</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">home_world =</span> homeworld,<span class="at">skincolor =</span> skin_color)</span></code></pre></div>
</div>
<div id="relocate" class="section level3" number="8.3.4">
<h3 number="8.3.4"><span class="header-section-number">8.3.4</span> relocate</h3>
<p>更改列顺序，与使用<code>select()</code>指定列顺序相似</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sex:homeworld列在height列前面</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">relocate</span>(sex<span class="sc">:</span>homeworld, <span class="at">.before =</span> height)</span></code></pre></div>
</div>
<div id="mutate" class="section level3" number="8.3.5">
<h3 number="8.3.5"><span class="header-section-number">8.3.5</span> mutate</h3>
<ul>
<li>新增计算列</li>
</ul>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bmi =</span> mass <span class="sc">/</span> ((height <span class="sc">/</span> <span class="dv">100</span>)  <span class="sc">^</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name<span class="sc">:</span>mass,bmi)</span></code></pre></div>
<ul>
<li>新增计算列基础上新增列，</li>
</ul>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bmi =</span> mass <span class="sc">/</span> ((height <span class="sc">/</span> <span class="dv">100</span>)  <span class="sc">^</span> <span class="dv">2</span>),<span class="at">newbmi =</span> bmi <span class="sc">*</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name<span class="sc">:</span>mass,bmi,newbmi)</span></code></pre></div>
<ul>
<li>删除列</li>
</ul>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">height =</span> <span class="cn">NULL</span>)</span></code></pre></div>
</div>
<div id="arrange" class="section level3" number="8.3.6">
<h3 number="8.3.6"><span class="header-section-number">8.3.6</span> arrange</h3>
<ul>
<li>单列排序，默认升序，通过<code>desc()</code>降序排列</li>
</ul>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mass))</span></code></pre></div>
<ul>
<li>多列排序</li>
</ul>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(height,<span class="fu">desc</span>(mass))</span></code></pre></div>
</div>
<div id="group_by" class="section level3" number="8.3.7">
<h3 number="8.3.7"><span class="header-section-number">8.3.7</span> group_by</h3>
<p>在汇总前一般都需要分组聚合，<code>group_by()</code>函数实现该功能，与<code>SQL</code>中<code>group by ···</code>类似</p>
</div>
<div id="summarise" class="section level3" number="8.3.8">
<h3 number="8.3.8"><span class="header-section-number">8.3.8</span> summarise</h3>
<p>按照分组聚合汇总</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">%&gt;%</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mass =</span> <span class="fu">mean</span>(mass, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="表操作" class="section level2" number="8.4">
<h2 number="8.4"><span class="header-section-number">8.4</span> 表操作</h2>
<ol style="list-style-type: decimal">
<li><p>指像<code>sql</code>中的<code>left join</code>,<code>inner join</code>等表格之间的操作，或者是Excel中<code>Power Piovt</code>建模的建立关系，从而实现不同表格间的关联</p></li>
<li><p>表格中的列操作，如列求和，均值等</p></li>
<li><p>行操作指不同字段间的计算，如<code>Excle</code>的列与列之间计算,<code>Excle</code>中的函数对行列不敏感，没有明显区别，但是<code>R</code>中<code>tidyverse</code>里列计算简单，行间计算依赖<code>rowwise()</code>函数实现</p></li>
</ol>
<div id="基础-4" class="section level3" number="8.4.1">
<h3 number="8.4.1"><span class="header-section-number">8.4.1</span> 基础</h3>
<p><code>left_join()</code>,<code>full_join</code>,<code>inner_join()</code>等动词关联两个表。详情请查看：<code>vignette("two-table")</code></p>
<p><code>left_join()</code>实现类似Excel中<code>VLOOKUP</code>函数功能或数据库中<code>left join</code>功能，将“右表”的字段依据“主键”关联到“左表”上。</p>
<ul>
<li>基础用法</li>
</ul>
<p><code>left_join()</code>,<code>right_join()</code>,<code>full_join()</code>,<code>inner_join</code>()，第一个以左表为主，第二个右表为主，第三个全连接，第四个内连接(只返回两表中都有的记录)，和数据库中连接方式一致。</p>
<p>默认会自动寻找两表中相同的字段名作为关联的条件</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;nycflights13&quot;</span>)</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop unimportant variables so it&#39;s easier to understand the join results.</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>flights2 <span class="ot">&lt;-</span> flights <span class="sc">%&gt;%</span> <span class="fu">select</span>(year<span class="sc">:</span>day, hour, origin, dest, tailnum, carrier)</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>flights2 <span class="sc">%&gt;%</span> </span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(airlines)</span></code></pre></div>
<p>指定关联条件列，类似数据库中<code>on a.column = b.column</code></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>flights2 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(planes, <span class="at">by =</span> <span class="st">&quot;tailnum&quot;</span>)</span></code></pre></div>
<ul>
<li>不同名称列关联</li>
</ul>
<p><code>left_join(x,y,by = c("a" = "b", "c" = "d"))</code> 将会匹配 x<span class="math inline">\(a to y\)</span>b 和 x<span class="math inline">\(c to y\)</span>d 作为关联条件</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co">#出发机场和目的机场信息</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>flights2 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;dest&quot;</span> <span class="ot">=</span> <span class="st">&quot;faa&quot;</span>))</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="co">#flights2 %&gt;% left_join(airports, c(&quot;origin&quot; = &quot;faa&quot;))</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 组合条件 多条件时用向量包裹即可c(&quot;dest&quot; = &quot;faa&quot;,&quot;cola&quot; = &quot;colb&quot;))</span></span></code></pre></div>
<ul>
<li>筛选连接</li>
</ul>
<p><code>anti_join()</code> 删除所有左表中在右表中匹配到的行</p>
<p><code>semi_join()</code>保留所有左表在右表中匹配到的行</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">a=</span>letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>],<span class="at">b=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">a=</span>letters,<span class="at">b=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>)</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>df1 <span class="sc">%&gt;%</span> <span class="fu">semi_join</span>(df2)</span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>df2 <span class="sc">%&gt;%</span> <span class="fu">anti_join</span>(df1)</span></code></pre></div>
<ul>
<li>集合操作</li>
</ul>
<ol style="list-style-type: decimal">
<li><p><code>intersect(x,y)</code>返回x,y交集</p></li>
<li><p><code>union(x,y)</code>返回x,y中唯一的值</p></li>
<li><p><code>setdiff(x,y)</code>返回存在x中但是不存在y中的记录</p></li>
</ol>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>(df1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="fu">c</span>(1L, 1L)))</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>(df2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>))</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a><span class="fu">intersect</span>(df1, df2)</span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a><span class="fu">union</span>(df1, df2)</span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setdiff</span>(df1, df2)</span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setdiff</span>(df2, df1)</span></code></pre></div>
</div>
<div id="多表操作" class="section level3" number="8.4.2">
<h3 number="8.4.2"><span class="header-section-number">8.4.2</span> 多表操作</h3>
<p>多表操作请使用<code>purrr::reduce()</code>,当需要合并多个表格时，可用以下方式减少合并代码量。</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>dt1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> letters)</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>dt2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> letters,<span class="at">cola =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>dt3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> letters,<span class="at">colb =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>)</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>dt4 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> letters,<span class="at">cold =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>)</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>dt5 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> letters,<span class="at">cole =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>)</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>dtlist <span class="ot">&lt;-</span> <span class="fu">list</span>(dt1,dt2,dt3,dt4,dt5)</span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">reduce</span>(dtlist,left_join,<span class="at">by=</span><span class="st">&#39;x&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="列操作" class="section level2" number="8.5">
<h2 number="8.5"><span class="header-section-number">8.5</span> 列操作</h2>
<p>在多列上执行相同的操作是常用的操作，但是通过复制和粘贴代码，麻烦不说还容易错：</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(g1, g2) <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">a =</span> <span class="fu">mean</span>(a), <span class="at">b =</span> <span class="fu">mean</span>(b), <span class="at">c =</span> <span class="fu">mean</span>(c), <span class="at">d =</span> <span class="fu">mean</span>(d))</span></code></pre></div>
<p>通过<code>across()</code>函数可以更简洁地重写上面代码：</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(g1, g2) <span class="sc">%&gt;%</span> </span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(a<span class="sc">:</span>d, mean))</span></code></pre></div>
<div id="基本操作" class="section level3" number="8.5.1">
<h3 number="8.5.1"><span class="header-section-number">8.5.1</span> 基本操作</h3>
<p>across() 有两个主要参数：</p>
<ul>
<li><p>第一个参数，.cols选择要操作的列。它使用<code>tidyr</code>的方式选择（例如select()），因此您可以按位置，名称和类型选择变量。</p></li>
<li><p>第二个参数，.fns是要应用于每一列的一个函数或函数列表。这也可以是purrr样式的公式（或公式列表），例如~ .x / 2。</p></li>
</ul>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span> <span class="fu">length</span>(<span class="fu">unique</span>(.x))))</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 列属性是字符的列求唯一值数</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a><span class="co"># starwars %&gt;% </span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(length(unique(name)))</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a><span class="co"># starwars %&gt;% </span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(length(unique(hair_color)))</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">%&gt;%</span> </span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(sex, gender, homeworld), <span class="sc">~</span> <span class="fu">length</span>(<span class="fu">unique</span>(.x))))</span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> </span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(homeworld) <span class="sc">%&gt;%</span> </span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code></pre></div>
<p><code>across()</code> 不会选择分组变量：</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">g =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="dv">9</span>))</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(g) <span class="sc">%&gt;%</span> </span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum))</span></code></pre></div>
</div>
<div id="多种函数功能" class="section level3" number="8.5.2">
<h3 number="8.5.2"><span class="header-section-number">8.5.2</span> 多种函数功能</h3>
<p>通过在第二个参数提供函数或lambda函数的命名列表，可是使用多个函数转换每个变量：</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>min_max <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">min =</span> <span class="sc">~</span><span class="fu">min</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max =</span> <span class="sc">~</span><span class="fu">max</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), min_max))</span></code></pre></div>
<p>通过<code>.names</code>参数控制名称：</p>
<p>NB:该参数的机制没有特别理解，需多练习体会。主要是运用到匿名函数时</p>
<p>以下是官方图册中的案例，但是报错：</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), min_max, <span class="at">.names =</span> <span class="st">&quot;{.fn}.{.col}&quot;</span>))</span></code></pre></div>
<p>修改后正常运行：</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), min_max, <span class="at">.names =</span> <span class="st">&quot;{fn}.{col}&quot;</span>))</span></code></pre></div>
<p>区别主要是<code>.names</code>参数的使用方式问题，<code>.</code>加不加的问题。</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), min_max, <span class="at">.names =</span> <span class="st">&quot;{fn}——{col}&quot;</span>))</span></code></pre></div>
</div>
<div id="当前列" class="section level3" number="8.5.3">
<h3 number="8.5.3"><span class="header-section-number">8.5.3</span> 当前列</h3>
<p>如果需要，可以通过调用访问内部的“当前”列的名称<code>cur_column()</code>。</p>
<p>该函数不是特别容易理解，需要多尝试使用加深认识。</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">z =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>)</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>mult <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">10</span>, <span class="at">z =</span> <span class="dv">100</span>)</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(<span class="fu">names</span>(mult)), <span class="sc">~</span> .x <span class="sc">*</span> mult[[<span class="fu">cur_column</span>()]]))</span></code></pre></div>
</div>
</div>
<div id="行操作" class="section level2" number="8.6">
<h2 number="8.6"><span class="header-section-number">8.6</span> 行操作</h2>
<p>在操纵数据框中，<code>dplyr</code>等工具让我们对列操作相对简单，但是对行操作则困难些。</p>
<div id="构造数据集" class="section level3" number="8.6.1">
<h3 number="8.6.1"><span class="header-section-number">8.6.1</span> 构造数据集</h3>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">z =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>()</span></code></pre></div>
<p>像<code>group_by()</code>,<code>rowwise()</code>并没有做任何事情，它的作用是改变其他动词的工作方式：
比较以下代码中不的不同</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">m =</span> <span class="fu">mean</span>(<span class="fu">c</span>(x, y, z)))</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">m =</span> <span class="fu">mean</span>(<span class="fu">c</span>(x, y, z)))</span></code></pre></div>
<p><code>data.table</code>中的操作:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">z =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>dt[,m<span class="sc">:</span><span class="er">=</span><span class="fu">mean</span>(<span class="fu">c</span>(x,y,z))][]</span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>dt[,m<span class="sc">:</span><span class="er">=</span><span class="fu">mean</span>(<span class="fu">c</span>(x,y,z)),by<span class="ot">=</span>.(x)][]</span></code></pre></div>
<p>您可以选择在调用中提供“标识符”变量<code>rowwise()</code>。这些变量在您调用时被保留<code>summarise()</code>，因此它们的行为与传递给的分组变量有些相似<code>group_by()</code>：</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">&quot;Mara&quot;</span>, <span class="st">&quot;Hadley&quot;</span>), <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">z =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">m =</span> <span class="fu">mean</span>(<span class="fu">c</span>(x, y, z)))</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">m =</span> <span class="fu">mean</span>(<span class="fu">c</span>(x, y, z)))</span></code></pre></div>
</div>
<div id="行汇总统计" class="section level3" number="8.6.2">
<h3 number="8.6.2"><span class="header-section-number">8.6.2</span> 行汇总统计</h3>
<p><code>dplyr::summarise()</code>使得汇总一列中各行的值非常容易。当与之结合使用时<code>rowwise()</code>，还可以轻松汇总一行中各列的值：</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">w =</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">x =</span> <span class="dv">20</span><span class="sc">:</span><span class="dv">25</span>, <span class="at">y =</span> <span class="dv">30</span><span class="sc">:</span><span class="dv">35</span>, <span class="at">z =</span> <span class="dv">40</span><span class="sc">:</span><span class="dv">45</span>)</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>(id)</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>rf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">c</span>(w, x, y, z)))</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>rf <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">c</span>(w, x, y, z)))</span></code></pre></div>
<p>键入每个变量名称很繁琐，通过<code>c_across()</code>使更简单</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>rf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(w<span class="sc">:</span>z)))</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>rf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(<span class="fu">where</span>(is.numeric))))</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>rf <span class="sc">%&gt;%</span> </span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(w<span class="sc">:</span>z))) <span class="sc">%&gt;%</span> </span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(w<span class="sc">:</span>z, <span class="sc">~</span> . <span class="sc">/</span> total))</span></code></pre></div>
</div>
</div>
<div id="分组操作" class="section level2" number="8.7">
<h2 number="8.7"><span class="header-section-number">8.7</span> 分组操作</h2>
<p>详情: <a href="https://cloud.r-project.org/web/packages/dplyr/vignettes/grouping.html" class="uri">https://cloud.r-project.org/web/packages/dplyr/vignettes/grouping.html</a></p>
<p><code>group_by()</code>最重要的分组动词,需要一个数据框和一个或多个变量进行分组：</p>
<div id="添加分组" class="section level3" number="8.7.1">
<h3 number="8.7.1"><span class="header-section-number">8.7.1</span> 添加分组</h3>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>by_species <span class="ot">&lt;-</span> starwars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(species)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>by_sex_gender <span class="ot">&lt;-</span> starwars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sex, gender)</span></code></pre></div>
<p>除了按照现有变量分组外，还可以按照函数处理后的变量分组，等效在<code>mutate()</code>之后执行<code>group_by</code>:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>bmi_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">18.5</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="cn">Inf</span>)</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">bmi_cat =</span> <span class="fu">cut</span>(mass<span class="sc">/</span>(height<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>, <span class="at">breaks=</span>bmi_breaks)) <span class="sc">%&gt;%</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
</div>
<div id="删除分组变量" class="section level3" number="8.7.2">
<h3 number="8.7.2"><span class="header-section-number">8.7.2</span> 删除分组变量</h3>
<p>要删除所有分组变量，使用<code>ungroup()</code>:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>by_species <span class="sc">%&gt;%</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
</div>
<div id="动词" class="section level3" number="8.7.3">
<h3 number="8.7.3"><span class="header-section-number">8.7.3</span> 动词</h3>
<p><code>summarise()</code> 计算每个组的汇总，表示从<code>group_keys</code>开始右侧添加汇总变量</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>by_species <span class="sc">%&gt;%</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>该<code>.groups=</code>参数控制输出的分组结构。删除右侧分组变量的历史行为对应于<code>.groups =</code> “drop_last”没有消息或.groups = NULL有消息（默认值）。</p>
<p>从1.0.0版开始，分组信息可以保留<code>(.groups = "keep")</code>或删除 <code>(.groups = 'drop)</code></p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> by_species <span class="sc">%&gt;%</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),<span class="at">.groups=</span><span class="st">&#39;drop&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_vars</span>()</span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> by_species <span class="sc">%&gt;%</span></span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),<span class="at">.groups=</span><span class="st">&#39;keep&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_vars</span>()</span>
<span id="cb245-12"><a href="#cb245-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-13"><a href="#cb245-13" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(a)</span>
<span id="cb245-14"><a href="#cb245-14" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(b)</span></code></pre></div>
<p>在实际使用中，当数据较大时需要删掉分组信息。以上可以看到保留分组信息的比没保留的大了两倍多。</p>
</div>
</div>
<div id="常用函数-2" class="section level2" number="8.8">
<h2 number="8.8"><span class="header-section-number">8.8</span> 常用函数</h2>
<div id="条件判断" class="section level3" number="8.8.1">
<h3 number="8.8.1"><span class="header-section-number">8.8.1</span> 条件判断</h3>
<p>相比于<code>base::ifelse</code>,<code>if_else</code>更为严格，无论<code>TRUE</code>或<code>FALSE</code>输出类型一致，这样速度更快。与<code>data.table::fifelse()</code>功能相似。</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">if_else</span>(condition, true, false, <span class="at">missing =</span> <span class="cn">NULL</span>)</span></code></pre></div>
<p>与<code>ifelse</code>不同的是，<code>if_else</code>保留类型</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), x, <span class="fu">factor</span>(<span class="cn">NA</span>))</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a><span class="fu">if_else</span>(x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), x, <span class="fu">factor</span>(<span class="cn">NA</span>))</span></code></pre></div>
</div>
<div id="case_when" class="section level3" number="8.8.2">
<h3 number="8.8.2"><span class="header-section-number">8.8.2</span> case_when</h3>
<p>当条件嵌套条件较多时，使用<code>case_when</code>,使代码可读并且不易出错。与sql 中的case when 等价。</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>Dates <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">&#39;2018-10-01&#39;</span>, <span class="st">&#39;2018-10-02&#39;</span>, <span class="st">&#39;2018-10-03&#39;</span>))</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="fu">case_when</span>(</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>  Dates <span class="sc">==</span> <span class="st">&#39;2018-10-01&#39;</span> <span class="sc">~</span> Dates <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>  Dates <span class="sc">==</span> <span class="st">&#39;2018-10-02&#39;</span> <span class="sc">~</span> Dates <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>  Dates <span class="sc">==</span> <span class="st">&#39;2018-10-03&#39;</span> <span class="sc">~</span> Dates <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> Dates</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="计数函数" class="section level3" number="8.8.3">
<h3 number="8.8.3"><span class="header-section-number">8.8.3</span> 计数函数</h3>
<ul>
<li>计数</li>
</ul>
<p><code>count()</code>函数用来计数。下面两种表达方式等价。</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">count</span>(a, b)</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(a, b) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">count</span>(species)</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="co"># same above 等价</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(species) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span></code></pre></div>
<ul>
<li>非重复计数</li>
</ul>
<p><code>n_distinct()</code>与<code>length(unique(x))</code>等价，但是更快更简洁。当我们需要给门店或订单之类数据需要去重计算时采用该函数。</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="fl">1e5</span>, <span class="at">rep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(x))</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(x)</span></code></pre></div>
</div>
<div id="排序函数" class="section level3" number="8.8.4">
<h3 number="8.8.4"><span class="header-section-number">8.8.4</span> 排序函数</h3>
<p><code>dplyr</code>共六种排序函数，模仿SQL2003中的排名函数。</p>
<ul>
<li>row_number():等于 rank(ties.method = “first”)</li>
<li>min_rank(): 等于 rank(ties.method = “min”)</li>
<li>dense_rank(): 与min_rank()相似,但是没有间隔</li>
<li>percent_rank():返回0，1之间，通过min_rank()返回值缩放至[0,1]</li>
</ul>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="cn">NA</span>)</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="fu">row_number</span>(x)</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a><span class="fu">min_rank</span>(x)</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dense_rank</span>(x)</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a><span class="fu">percent_rank</span>(x)</span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cume_dist</span>(x)</span></code></pre></div>
</div>
<div id="提取向量" class="section level3" number="8.8.5">
<h3 number="8.8.5"><span class="header-section-number">8.8.5</span> 提取向量</h3>
<p>该系列函数是对<code>[[</code>的包装。</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nth</span>(x, n, <span class="at">order_by =</span> <span class="cn">NULL</span>, <span class="at">default =</span> <span class="fu">default_missing</span>(x))</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a><span class="fu">first</span>(x, <span class="at">order_by =</span> <span class="cn">NULL</span>, <span class="at">default =</span> <span class="fu">default_missing</span>(x))</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="fu">last</span>(x, <span class="at">order_by =</span> <span class="cn">NULL</span>, <span class="at">default =</span> <span class="fu">default_missing</span>(x))</span></code></pre></div>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">1</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="fu">first</span>(x)</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="fu">last</span>(y)</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nth</span>(x, <span class="dv">1</span>)</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a><span class="fu">nth</span>(x, <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="group-系列" class="section level3" number="8.8.6">
<h3 number="8.8.6"><span class="header-section-number">8.8.6</span> group 系列</h3>
<p>group_by(),group_map(), group_nest(), group_split(), group_trim()等一系列函数。</p>
<p>其中我常用group_by(),group_split()两个函数。group_by()是大部分数据操作中的分组操作，按照group_by()的指定分组条件。</p>
<ul>
<li>group_by()</li>
</ul>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co">#group_by()不会改变数据框</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>by_cyl <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cyl)</span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>by_cyl</span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="co"># It changes how it acts with the other dplyr verbs:</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>by_cyl <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">disp =</span> <span class="fu">mean</span>(disp),</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">hp =</span> <span class="fu">mean</span>(hp)</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a><span class="co"># group_by中可以添加计算字段 即mutate操作</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(<span class="at">vsam =</span> vs <span class="sc">+</span> am) <span class="sc">%&gt;%</span></span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_vars</span>()</span></code></pre></div>
<ul>
<li>group_map()</li>
</ul>
<p>group_map，group_modify,group_walk等三个函数是purrr类具有迭代风格的函数。简单关系数据库的数据清洗一般不涉及，常用在建模等方面。</p>
<p>但是目前三个函数是实验性的，未来可能会发生变化。</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># return a list</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 返回列表</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">%&gt;%</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_map</span>(<span class="sc">~</span> <span class="fu">head</span>(.x, 2L))</span></code></pre></div>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>iris <span class="sc">%&gt;%</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Species) <span class="sc">%&gt;%</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> {</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>    .x <span class="sc">%&gt;%</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map_dfc</span>(fivenum) <span class="sc">%&gt;%</span></span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">nms =</span> <span class="fu">c</span>(<span class="st">&quot;min&quot;</span>, <span class="st">&quot;Q1&quot;</span>, <span class="st">&quot;median&quot;</span>, <span class="st">&quot;Q3&quot;</span>, <span class="st">&quot;max&quot;</span>))</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co"># group_walk</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>())</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>iris <span class="sc">%&gt;%</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Species) <span class="sc">%&gt;%</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_walk</span>(<span class="sc">~</span> <span class="fu">write.csv</span>(.x, <span class="at">file =</span> <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(.y<span class="sc">$</span>Species, <span class="st">&quot;.csv&quot;</span>))))</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(temp, <span class="at">pattern =</span> <span class="st">&quot;csv$&quot;</span>)</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a><span class="fu">unlink</span>(temp, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<ul>
<li>group_cols()</li>
</ul>
<p>选择分组变量</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>gdf <span class="ot">&lt;-</span> iris <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Species)</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>gdf <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">group_cols</span>())</span></code></pre></div>
</div>
<div id="其它函数" class="section level3" number="8.8.7">
<h3 number="8.8.7"><span class="header-section-number">8.8.7</span> 其它函数</h3>
<ul>
<li><p>between</p></li>
<li><p>cummean cumsum cumall cumany</p></li>
</ul>
<p>累计系列函数</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cummean</span>(x)</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cumsum</span>(x) <span class="sc">/</span> <span class="fu">seq_along</span>(x)</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cumall</span>(x <span class="sc">&lt;</span> <span class="dv">5</span>)</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cumany</span>(x <span class="sc">==</span> <span class="dv">3</span>)</span></code></pre></div>
<ul>
<li>distinct</li>
</ul>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">sample</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="at">rep =</span> <span class="cn">TRUE</span>),</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">sample</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="at">rep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(df, x)</span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(df, x, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(df, <span class="at">diff =</span> <span class="fu">abs</span>(x <span class="sc">-</span> y))</span></code></pre></div>
</div>
</div>
<div id="用dplyr编程" class="section level2" number="8.9">
<h2 number="8.9"><span class="header-section-number">8.9</span> 用<code>dplyr</code>编程</h2>
<p>Programming with dplyr:</p>
<p><a href="https://cloud.r-project.org/web/packages/dplyr/vignettes/programming.html" class="uri">https://cloud.r-project.org/web/packages/dplyr/vignettes/programming.html</a></p>
<p>本节概念性东西较多且复杂不易理解，先尝试会使用，概念再慢慢消化理解。</p>
<p>虽然复杂但是比较实用，尤其是当我们需要定义一些通用功能函数时</p>
<p>以下是对原文引用</p>
<p>两种情况：</p>
<ul>
<li>When you have the data-variable in a function argument (i.e. an env-variable that holds a promise2), you need to ** embrace ** the argument by surrounding it in doubled braces, like <code>filter(df, {{ var }})</code>.</li>
</ul>
<p>The following function uses embracing to create a wrapper around <code>summarise()</code> that computes the minimum and maximum values of a variable, as well as the number of observations that were summarised:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>var_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var) {</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">min =</span> <span class="fu">min</span>({{ var }}), <span class="at">max =</span> <span class="fu">max</span>({{ var }}))</span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">%&gt;%</span> </span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">var_summary</span>(mpg)</span></code></pre></div>
<ul>
<li>When you have an env-variable that is a character vector, you need to index into the .data pronoun with [[, like summarise(df, mean = mean(.data[[var]])).</li>
</ul>
<p>The following example uses .data to count the number of unique values in each variable of mtcars:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> <span class="fu">names</span>(mtcars)) {</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>  mtcars <span class="sc">%&gt;%</span> <span class="fu">count</span>(.data[[var]]) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that .data is not a data frame; it’s a special construct, a pronoun, that allows you to access the current variables either directly, with <code>.data$x</code> or indirectly with <code>.data[[var]]</code>. Don’t expect other functions to work with it.</p>
<div id="案例-1" class="section level3" number="8.9.1">
<h3 number="8.9.1"><span class="header-section-number">8.9.1</span> 案例</h3>
<p>当我们不知道接下来会用哪个变量汇总时：</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>my_summarise <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var) {</span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>({{ group_var }}) <span class="sc">%&gt;%</span></span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(mass))</span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>如果在多个位置使用：</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>my_summarise2 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, expr) {</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>({{ expr }}),</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum =</span> <span class="fu">sum</span>({{ expr }}),</span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>当多个表达式时：</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>my_summarise3 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mean_var, sd_var) {</span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>({{ mean_var }}), <span class="at">sd =</span> <span class="fu">mean</span>({{ sd_var }}))</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>如果要输出变量名时：</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>my_summarise4 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, expr) {</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mean_{{expr}}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>({{ expr }}),</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;sum_{{expr}}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">sum</span>({{ expr }}),</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;n_{{expr}}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">n</span>()</span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>my_summarise5 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mean_var, sd_var) {</span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;mean_{{mean_var}}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>({{ mean_var }}), </span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;sd_{{sd_var}}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>({{ sd_var }})</span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>任意个表达式：</p>
<p>这种使用场景更多</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>my_summarise <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, ...) {</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>  .data <span class="sc">%&gt;%</span></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(...) <span class="sc">%&gt;%</span></span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mass =</span> <span class="fu">mean</span>(mass, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">my_summarise</span>(homeworld)</span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>starwars <span class="sc">%&gt;%</span> <span class="fu">my_summarise</span>(sex, gender)</span></code></pre></div>
<!--chapter:end:07-Data-manipulation.Rmd-->
</div>
</div>
</div>
<div id="loop-structure" class="section level1" number="9">
<h1 number="9"><span class="header-section-number">9</span> Loop structure</h1>
<p>实际场景中,当需要重复做某动作时,可运用循环结构。</p>
<div id="简单示例" class="section level2" number="9.1">
<h2 number="9.1"><span class="header-section-number">9.1</span> 简单示例</h2>
<p>利用循环实现1到100连续相加求和</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> total<span class="sc">+</span>i</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&#39;1到100连续相加求和等于:&#39;</span>,total))</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a><span class="co"># loop structure</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a><span class="co"># for (var in seq) {expr}</span></span></code></pre></div>
</div>
<div id="循环基础" class="section level2" number="9.2">
<h2 number="9.2"><span class="header-section-number">9.2</span> 循环基础</h2>
<div id="循环结构" class="section level3" number="9.2.1">
<h3 number="9.2.1"><span class="header-section-number">9.2.1</span> 循环结构</h3>
<p>R中有三种循环结构：</p>
<ul>
<li>Repeat</li>
</ul>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="cf">repeat</span>{</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> total<span class="sc">+</span>i</span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">&gt;</span> <span class="dv">100</span>){</span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&#39;连续相加求和等于:&#39;</span>,total))</span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>while</li>
</ul>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(i <span class="sc">&lt;=</span> <span class="dv">1000</span>){</span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> total<span class="sc">+</span>i</span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&#39;1到1000连续相加求和等于:&#39;</span>,total))</span>
<span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a><span class="co"># sum(1:1000)</span></span></code></pre></div>
<ul>
<li>for</li>
</ul>
<p>代码如示例所示</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;double&quot;</span>, <span class="fu">ncol</span>(df))  <span class="co"># 1. output</span></span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(df)) {            <span class="co"># 2. sequence</span></span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>  output[[i]] <span class="ot">&lt;-</span> <span class="fu">median</span>(df[[i]])      <span class="co"># 3. body</span></span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>output</span></code></pre></div>
<p>循环中尽可能利用R中的向量化,比如指定output的长度,当数据量大的时候效率提升将比较明显,养成向量化的意识对提高代码效率有显著效果.</p>
<p>上面代码中 <code>vector</code>函数创建一个空向量带指定长度，有两个参数，第一个时向量类型(‘逻辑,’‘整数,’‘双精度,’’字符’等)，第二个是向量长度 <code>vector(length=5)</code>,类型默认是逻辑型.</p>
<p><code>seq_along</code>可以<code>?seq</code>查看用法.</p>
<p>hadely 解释如下:</p>
<p>You might not have seen seq_along() before. It’s a safe version of the familiar 1:length(l), with an important difference: if you have a zero-length vector, seq_along() does the right thing:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co">#wrong</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="fu">seq_along</span>(<span class="fu">c</span>())</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">c</span>())</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a><span class="co"># generates the integer sequence 1, 2, ..., length(along.with). (along.with is usually abbreviated to along, and  seq_along is much faster.)</span></span></code></pre></div>
</div>
<div id="next-break-用法" class="section level3" number="9.2.2">
<h3 number="9.2.2"><span class="header-section-number">9.2.2</span> next break 用法</h3>
<ul>
<li>next 用法</li>
</ul>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>] ){</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="st">&quot;d&quot;</span>){</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">next</span></span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>break 用法</li>
</ul>
<p>可以当条件满足时跳出循环常常与repeat循环结构配合使用。</p>
</div>
<div id="嵌套循环" class="section level3" number="9.2.3">
<h3 number="9.2.3"><span class="header-section-number">9.2.3</span> 嵌套循环</h3>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>    v[i<span class="sc">*</span>j] <span class="ot">=</span> i <span class="sc">*</span> j </span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="循环变化" class="section level2" number="9.3">
<h2 number="9.3"><span class="header-section-number">9.3</span> 循环变化</h2>
<div id="修改已有对象" class="section level3" number="9.3.1">
<h3 number="9.3.1"><span class="header-section-number">9.3.1</span> 修改已有对象</h3>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(res)){</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>  res[i] <span class="ot">&lt;-</span> res[i] <span class="sc">*</span> i</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(res)</span></code></pre></div>
</div>
<div id="循环模式" class="section level3" number="9.3.2">
<h3 number="9.3.2"><span class="header-section-number">9.3.2</span> 循环模式</h3>
<p>共有三种遍历向量的方法,之前展示的都是遍历数字索引<code>for (i in seq_along(xs))</code>,并使用提取值<code>x[[i]]</code>.还有两种方式:</p>
<ul>
<li>循环遍历元素</li>
</ul>
<p><code>for(i in xs)</code>,例如我们需要保存文件时,可以利用这种循环模式</p>
<ul>
<li>遍历名称</li>
</ul>
<p><code>for (nm in names(xs))</code>,我们可以使用<code>x[[nm]]</code> 该名称访问.当我们要在文件名中使用名称时会比较方便.</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(x))</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">names</span>(x)</span></code></pre></div>
<p>数字索引的循环模式最常用,因为可以根据位置提取名称和值.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> <span class="fu">names</span>(x)[[i]]</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  value <span class="ot">&lt;-</span> x[[i]]</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="未知长度输出" class="section level3" number="9.3.3">
<h3 number="9.3.3"><span class="header-section-number">9.3.3</span> 未知长度输出</h3>
<p>有时候我们的循环我们不确定输出的长度是多少.这样会逐步增加向量的长度,如下所示：</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">double</span>()</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(means)) {</span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">c</span>(output, <span class="fu">rnorm</span>(n, means[[i]]))</span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(output)</span></code></pre></div>
<p>但是这种方式浪费时间，当数据量大时候效率会很低下.因为时间复杂度为(<span class="math inline">\(O(n^2)\)</span>).解决方案是将结果保存在列表中,然后在完成循环后合并为单个向量:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(means))</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(means)) {</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>  out[[i]] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, means[[i]])</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(out)</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(<span class="fu">unlist</span>(out)) <span class="co">#unlist将列表向量化</span></span></code></pre></div>
<!--chapter:end:08-loop.Rmd-->
</div>
</div>
</div>
<div id="iteration" class="section level1" number="10">
<h1 number="10"><span class="header-section-number">10</span> Iteration</h1>
<p>常常需要重复操作同样的功能函数，这时可以用迭代来实现。purrr包提供了一套完整的函数来处理循环迭代,可以有效减少重复性工作和代码。</p>
<p><a href="https://purrr.tidyverse.org/" class="uri">https://purrr.tidyverse.org/</a></p>
<div id="简单用法" class="section level2" number="10.1">
<h2 number="10.1"><span class="header-section-number">10.1</span> 简单用法</h2>
<ul>
<li>map</li>
</ul>
<p>用map循环迭代,map函数始终返回list对象。</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define function</span></span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a>addTen <span class="ot">&lt;-</span> <span class="cf">function</span>(.x) {</span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(.x <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb281-7"><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-8"><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="at">.x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), <span class="at">.f =</span> addTen)</span>
<span id="cb281-9"><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb281-10"><a href="#cb281-10" aria-hidden="true" tabindex="-1"></a><span class="co"># map(c(1, 4, 7), addTen) # same above</span></span></code></pre></div>
<ul>
<li>map_dbl</li>
</ul>
<p>用map_dbl循环迭代，map_dbl函数返回vector。</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(purrr)</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>add1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  (x<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span>x</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>result1 <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,add1) <span class="co"># maP_dbl 输出结果为向量</span></span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-7"><a href="#cb282-7" aria-hidden="true" tabindex="-1"></a><span class="co">#for版本</span></span>
<span id="cb282-8"><a href="#cb282-8" aria-hidden="true" tabindex="-1"></a>result2 <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> <span class="dv">1000</span>)</span>
<span id="cb282-9"><a href="#cb282-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb282-10"><a href="#cb282-10" aria-hidden="true" tabindex="-1"></a>  result2[i] <span class="ot">&lt;-</span> (i<span class="sc">+</span><span class="dv">1</span>) <span class="sc">*</span> i</span>
<span id="cb282-11"><a href="#cb282-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb282-12"><a href="#cb282-12" aria-hidden="true" tabindex="-1"></a><span class="co"># test </span></span>
<span id="cb282-13"><a href="#cb282-13" aria-hidden="true" tabindex="-1"></a><span class="co">#not run</span></span>
<span id="cb282-14"><a href="#cb282-14" aria-hidden="true" tabindex="-1"></a><span class="co">#table(result1 == result2)</span></span>
<span id="cb282-15"><a href="#cb282-15" aria-hidden="true" tabindex="-1"></a><span class="co"># all equal</span></span>
<span id="cb282-16"><a href="#cb282-16" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(result1,result2)</span></code></pre></div>
</div>
<div id="map系列常用函数" class="section level2" number="10.2">
<h2 number="10.2"><span class="header-section-number">10.2</span> map系列常用函数</h2>
<ul>
<li>map_chr</li>
</ul>
<p><code>map_chr(.x, .f)</code> ,map_chr 返回对象为字符串</p>
<ul>
<li>map_dbl</li>
</ul>
<p><code>map_dbl(.x, .f)</code> ,map_dbl 返回数字向量(双精度)</p>
<ul>
<li>map_df</li>
</ul>
<p><code>map_df(.x, .f)</code>,map_df 返回对象为数据框,类似函数 <code>map_dfr(.x,.f)</code>,<code>map_dfc(.x,.f)</code></p>
<ul>
<li>map_gl</li>
</ul>
<p><code>map_lgl(.x, .f)</code> 返回逻辑向量</p>
<ul>
<li>map_int</li>
</ul>
<p><code>map_int(.x, .f, ...)</code> 返回整数</p>
<p>map_df()函数示例</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 采用匿名函数</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), <span class="cf">function</span>(.x) {</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">old_number =</span> .x, </span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">new_number =</span> <span class="fu">addTen</span>(.x)))</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a><span class="co">#同上</span></span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a><span class="co">#step1 定义函数</span></span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a>make_dataframe <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">old_number =</span> x,<span class="at">new_number =</span> <span class="fu">addTen</span>(x))</span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb283-12"><a href="#cb283-12" aria-hidden="true" tabindex="-1"></a><span class="co">#step2 计算</span></span>
<span id="cb283-13"><a href="#cb283-13" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">7</span>),make_dataframe)</span></code></pre></div>
</div>
<div id="归约累计函数" class="section level2" number="10.3">
<h2 number="10.3"><span class="header-section-number">10.3</span> 归约累计函数</h2>
<p>reduce、accumulate()函数用法介绍.</p>
<ul>
<li>reduce</li>
</ul>
<p>在实际工作中,我长用reduce函数实现merge()功能。示例如下：</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">1</span>,<span class="st">`</span><span class="at">-</span><span class="st">`</span>)</span></code></pre></div>
<p>将函数功能不断运用到list上得到最后结果。</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>dt1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a=</span>letters[n],<span class="at">b1=</span><span class="fu">rnorm</span>(n))</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>dt2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a=</span>letters[n],<span class="at">b2=</span><span class="fu">rnorm</span>(n))</span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>dt3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a=</span>letters[n],<span class="at">b3=</span><span class="fu">rnorm</span>(n))</span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a>dt4 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a=</span>letters[n],<span class="at">b4=</span><span class="fu">rnorm</span>(n))</span>
<span id="cb285-6"><a href="#cb285-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-7"><a href="#cb285-7" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="fu">list</span>(dt1,dt2,dt3,dt4),merge)</span>
<span id="cb285-8"><a href="#cb285-8" aria-hidden="true" tabindex="-1"></a><span class="co"># not run</span></span>
<span id="cb285-9"><a href="#cb285-9" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce(list(dt1,dt2,dt3,dt4),merge,by=&#39;a&#39;) same above</span></span></code></pre></div>
<ul>
<li>accumulate</li>
</ul>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">%&gt;%</span> <span class="fu">accumulate</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="fu">accumulate</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], paste, <span class="at">sep =</span> <span class="st">&quot;.&quot;</span>)</span></code></pre></div>
</div>
<div id="安全函数" class="section level2" number="10.4">
<h2 number="10.4"><span class="header-section-number">10.4</span> 安全函数</h2>
<p>possibly() 和 safely(),当循环时候遇到错误报错导致整个程序停止,这不是我们想要的。</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="st">&#39;5&#39;</span>)</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(l,<span class="cf">function</span>(.x) .x<span class="sc">+</span><span class="dv">1</span>)</span></code></pre></div>
<p>以上程序将会报错,不能正确得到结果。</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="st">&#39;5&#39;</span>)</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>test_fun <span class="ot">&lt;-</span> <span class="fu">safely</span>(<span class="cf">function</span>(.x) .x<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(l,test_fun)</span></code></pre></div>
<p>用safely()函数将原始function包裹起来,即使执行过程中遇到错误也可以完成整个任务,不会因为中途报错停止,在大型循环过程中,如爬虫过程中比较实用。</p>
</div>
<div id="映射多个参数" class="section level2" number="10.5">
<h2 number="10.5"><span class="header-section-number">10.5</span> 映射多个参数</h2>
<p>map2 和 pmap 函数可以映射两个及以上参数。</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>li1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>li2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>)</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(li1,li2,<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code></pre></div>
<p>类似函数 map2_dbl,map2_chr,map2_dfr等等。</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>li1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>li2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>)</span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>li3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>)</span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>li1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a>li2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>)</span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a>li3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)</span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a>li <span class="ot">&lt;-</span> <span class="fu">list</span>(li1,li2,li3)</span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a><span class="fu">pmap</span>(li,sum)</span></code></pre></div>
<p>同上有pmap_int,pmap_dbl,pmap_dfr等函数。</p>
</div>
<div id="其他函数介绍" class="section level2" number="10.6">
<h2 number="10.6"><span class="header-section-number">10.6</span> 其他函数介绍</h2>
<ul>
<li>flatten</li>
</ul>
<p>flatten()系列函数可以将列表输出为稳定类型。purrr package 自带Examples。</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rerun</span>(<span class="dv">2</span>, <span class="fu">sample</span>(<span class="dv">4</span>))</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">flatten</span>()</span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">flatten_int</span>()</span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a><span class="co"># You can use flatten in conjunction with map</span></span>
<span id="cb291-6"><a href="#cb291-6" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">map</span>(1L) <span class="sc">%&gt;%</span> <span class="fu">flatten_int</span>()</span>
<span id="cb291-7"><a href="#cb291-7" aria-hidden="true" tabindex="-1"></a><span class="co"># But it&#39;s more efficient to use the typed map instead.</span></span>
<span id="cb291-8"><a href="#cb291-8" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">map_int</span>(1L)</span></code></pre></div>
<ul>
<li>imap</li>
</ul>
<p>imap()系列函数官方描述：</p>
<p>imap_xxx(x, …), an indexed map, is short hand for map2(x, names(x), …) if x has names, or map2(x, seq_along(x), …) if it does not. This is useful if you need to compute on both the value and the position of an element.</p>
<p>imap,当x有names(x)或者seq_along(x)属性,imap是map2的另一种表达方式。</p>
<p>使用公式快捷方式时,第一个参数是值(.x),第二个参数是位置/名称(.y)。</p>
<p>详情请查看:?imap</p>
<p>示例1：</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="fu">imap_chr</span>(<span class="fu">sample</span>(<span class="dv">10</span>), <span class="sc">~</span> <span class="fu">paste0</span>(.y, <span class="st">&quot;: &quot;</span>, .x))</span></code></pre></div>
<p>sample(10),没有names(),只有长度信息。转化成map2表达如下:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="co">#same above</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map2_chr</span>(<span class="fu">sample</span>(<span class="dv">10</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="sc">~</span><span class="fu">paste0</span>(.y,<span class="st">&quot;: &quot;</span>,.x)) <span class="co"># 第二个list 为位置信息.</span></span></code></pre></div>
<!--chapter:end:09-iteration.Rmd-->
</div>
</div>
<div id="define-function" class="section level1" number="11">
<h1 number="11"><span class="header-section-number">11</span> define function</h1>
<p>函数功能使我们尽可能避免复制粘贴代码,而且需要更改的时候不需要大面积修改代码仅需要调整函数参数,使代码整体更加模块化.</p>
<p>假设有工作任务需要给商品SKU排名,在代码中需要重复以下代码5次,当区间需要修改的时候就是灾难.</p>
<p>原始代码示例如下:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,<span class="dv">1000</span>)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>res1 <span class="ot">&lt;-</span> <span class="fu">if_else</span>(num <span class="sc">&lt;=</span> <span class="dv">50</span>,<span class="st">&quot;1-50&quot;</span>,</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">if_else</span>(num <span class="sc">&lt;=</span> <span class="dv">100</span>,<span class="st">&quot;51-100&quot;</span>,</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">if_else</span>(num <span class="sc">&lt;=</span> <span class="dv">150</span>,<span class="st">&quot;101-150&quot;</span>,</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">if_else</span>(num <span class="sc">&lt;=</span> <span class="dv">200</span> ,<span class="st">&quot;151-200&quot;</span>,</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">if_else</span>(num <span class="sc">&gt;</span><span class="dv">200</span>,<span class="st">&quot;200以上&quot;</span>,<span class="st">&#39;其他&#39;</span>)))))</span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a><span class="co"># same above</span></span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a><span class="co"># case_when(num &lt;= 50 ~ &#39;1-50&#39;,</span></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a><span class="co">#           num &lt;= 100 ~ &#39;51-100&#39;,</span></span>
<span id="cb294-13"><a href="#cb294-13" aria-hidden="true" tabindex="-1"></a><span class="co">#           num &lt;= 150 ~ &#39;101-150&#39;,</span></span>
<span id="cb294-14"><a href="#cb294-14" aria-hidden="true" tabindex="-1"></a><span class="co">#           num &lt;= 200 ~ &#39;151-200&#39;,</span></span>
<span id="cb294-15"><a href="#cb294-15" aria-hidden="true" tabindex="-1"></a><span class="co">#           num &gt; 100 ~ &#39;200以上&#39;</span></span>
<span id="cb294-16"><a href="#cb294-16" aria-hidden="true" tabindex="-1"></a><span class="co">#           )</span></span>
<span id="cb294-17"><a href="#cb294-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-18"><a href="#cb294-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 个人倾向data.table </span></span>
<span id="cb294-19"><a href="#cb294-19" aria-hidden="true" tabindex="-1"></a><span class="co"># data.table::fifelse()</span></span>
<span id="cb294-20"><a href="#cb294-20" aria-hidden="true" tabindex="-1"></a><span class="co"># data.table::fcase() 是sql中case when的实现</span></span></code></pre></div>
<p>函数化后代码示例如下:</p>
<p>当需要修改区间时候仅仅只需要调整参数,而不必大量修改代码,当在脚本中需要调用多次时,能简洁代码.</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 排名区间函数</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a><span class="co">#library(tidyverse)</span></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>cut_function <span class="ot">&lt;-</span> <span class="cf">function</span>(vecto,x,n){</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>)</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>    kong <span class="ot">&lt;-</span>  i<span class="sc">*</span>x</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>    vec <span class="ot">&lt;-</span> <span class="fu">c</span>(vec,kong)</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span> <span class="fu">c</span>(vec,<span class="cn">Inf</span>)</span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (j<span class="sc">&lt;=</span>n) {</span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a>    labels[j] <span class="ot">&lt;-</span> <span class="fu">str_c</span>(vec[j]<span class="sc">+</span><span class="dv">1</span>,<span class="st">&quot;-&quot;</span>,vec[j<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb295-17"><a href="#cb295-17" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> <span class="fu">c</span>(labels,<span class="fu">paste0</span>(vec[j],<span class="st">&#39;以上&#39;</span>))</span>
<span id="cb295-18"><a href="#cb295-18" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="at">x =</span> vecto,<span class="at">breaks =</span> vec,<span class="at">labels =</span> labels) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb295-19"><a href="#cb295-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb295-20"><a href="#cb295-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-21"><a href="#cb295-21" aria-hidden="true" tabindex="-1"></a>res2 <span class="ot">&lt;-</span> <span class="fu">cut_function</span>(num,<span class="dv">50</span>,<span class="dv">4</span>)</span>
<span id="cb295-22"><a href="#cb295-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-23"><a href="#cb295-23" aria-hidden="true" tabindex="-1"></a><span class="co"># identical(res1,res2)</span></span>
<span id="cb295-24"><a href="#cb295-24" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt; TRUE</span></span></code></pre></div>
<p><a href="https://r4ds.had.co.nz/functions.html">参考资料</a></p>
<div id="简单示例-1" class="section level2" number="11.1">
<h2 number="11.1"><span class="header-section-number">11.1</span> 简单示例</h2>
<p>给函数取一个合适名字是很难的事情,徐尽可能从函数名称看出你实现的功能.</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>add_ten <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> x<span class="sc">+</span><span class="dv">10</span></span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res) <span class="co">#可以不用显示返回</span></span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a><span class="fu">add_ten</span>(<span class="dv">1</span>)</span></code></pre></div>
<p>写函数时需要考虑函数使用情况,尽可能考虑容错情况,当输入不符合预期时能友好提示错误.</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>add_ten <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.numeric</span>(x)<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">+</span><span class="dv">10</span></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Error,请输入数字&#39;</span>)</span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="条件执行" class="section level2" number="11.2">
<h2 number="11.2"><span class="header-section-number">11.2</span> 条件执行</h2>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>has_name <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> <span class="fu">names</span>(x)</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(nms)) {</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="cn">FALSE</span>, <span class="fu">length</span>(x))</span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(nms) <span class="sc">&amp;</span> nms <span class="sc">!=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="多条件执行" class="section level3" number="11.2.1">
<h3 number="11.2.1"><span class="header-section-number">11.2.1</span> 多条件执行</h3>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (this) {</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do that</span></span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (that) {</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do something else</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>当需要很多if时可考虑用switch()功能</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(x, y, op) {</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>   <span class="cf">switch</span>(op,</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">plus =</span> x <span class="sc">+</span> y,</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">minus =</span> x <span class="sc">-</span> y,</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">times =</span> x <span class="sc">*</span> y,</span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">divide =</span> x <span class="sc">/</span> y,</span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">stop</span>(<span class="st">&quot;Unknown op!&quot;</span>)</span>
<span id="cb300-8"><a href="#cb300-8" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb300-9"><a href="#cb300-9" aria-hidden="true" tabindex="-1"></a> }</span></code></pre></div>
</div>
</div>
<div id="函数参数" class="section level2" number="11.3">
<h2 number="11.3"><span class="header-section-number">11.3</span> 函数参数</h2>
<p>函数的参数通常分为两大类,一组是提供要计算的参数,另外一组提供计算时的细节参数.</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>mean_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">conf =</span> <span class="fl">0.95</span>) {</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> <span class="fu">sd</span>(x) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(x))</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> conf</span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(x) <span class="sc">+</span> se <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="fu">c</span>(alpha <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>)</span>
<span id="cb301-7"><a href="#cb301-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mean_ci</span>(x)</span>
<span id="cb301-8"><a href="#cb301-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean_ci</span>(x, <span class="at">conf =</span> <span class="fl">0.99</span>)</span></code></pre></div>
<div id="参数名称" class="section level3" number="11.3.1">
<h3 number="11.3.1"><span class="header-section-number">11.3.1</span> 参数名称</h3>
<p>参数的名称很重要,方便我们理解参数含义,调用时不会混乱.以下时几个重要的参数名称</p>
<ul>
<li>x, y, z: vectors.</li>
<li>w: a vector of weights.</li>
<li>df: a data frame.</li>
<li>i, j: numeric indices (typically rows and columns).</li>
<li>n: length, or number of rows.</li>
<li>p: number of columns.</li>
</ul>
</div>
<div id="检查参数值" class="section level3" number="11.3.2">
<h3 number="11.3.2"><span class="header-section-number">11.3.2</span> 检查参数值</h3>
<p>在写函数时,并不清楚最终函数的输出,在编写函数时进行约束是有必要的.</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>wt_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x, w) {</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">!=</span> <span class="fu">length</span>(w)) {</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;`x` and `w` must be the same length&quot;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(w <span class="sc">*</span> x) <span class="sc">/</span> <span class="fu">sum</span>(w)</span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="参数" class="section level3" number="11.3.3">
<h3 number="11.3.3"><span class="header-section-number">11.3.3</span> …参数</h3>
<p>R中的许多函数都能接受任意数量的输入：</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>)</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;e&#39;</span>,<span class="st">&#39;f&#39;</span>,<span class="st">&#39;g&#39;</span>,<span class="st">&#39;h&#39;</span>)</span></code></pre></div>
<p>下面的例子中</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>commas <span class="ot">&lt;-</span> <span class="cf">function</span>(...) stringr<span class="sc">::</span><span class="fu">str_c</span>(..., <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>)</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="fu">commas</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;a, b, c, d, e, f, g, h, i, j&quot;</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>rule <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">pad =</span> <span class="st">&quot;-&quot;</span>) {</span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">paste0</span>(...)</span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>  width <span class="ot">&lt;-</span> <span class="fu">getOption</span>(<span class="st">&quot;width&quot;</span>) <span class="sc">-</span> <span class="fu">nchar</span>(title) <span class="sc">-</span> <span class="dv">5</span></span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(title, <span class="st">&quot; &quot;</span>, stringr<span class="sc">::</span><span class="fu">str_dup</span>(pad, width), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rule</span>(<span class="st">&quot;Important output&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="返回值" class="section level2" number="11.4">
<h2 number="11.4"><span class="header-section-number">11.4</span> 返回值</h2>
<div id="显式返回" class="section level3" number="11.4.1">
<h3 number="11.4.1"><span class="header-section-number">11.4.1</span> 显式返回</h3>
<p>函数返回的通常是最后一句代码的计算结果,可以显式利用return()提前返回。但是R for Data Science 中作者说:
‘我认为最好不要使用return()来表示,您可以使用更简单的解决方案尽早返回’</p>
<ul>
<li>A common reason to do this is because the inputs are empty:</li>
</ul>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>complicated_function <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, z) {</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(y) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Complicated code here</span></span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Another reason is because you have a if statement with one complex block and one simple block. For example, you might write an if statement like this:</li>
</ul>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x) {</span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do </span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># something</span></span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that</span></span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># takes</span></span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># many</span></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lines</span></span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to</span></span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># express</span></span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb306-12"><a href="#cb306-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return something short</span></span>
<span id="cb306-13"><a href="#cb306-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb306-14"><a href="#cb306-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="编写管道函数" class="section level3" number="11.4.2">
<h3 number="11.4.2"><span class="header-section-number">11.4.2</span> 编写管道函数</h3>
<p>管道函数有两种基本类型: transformations and side-effects。使用transformations时，会将对象传递到函数的第一个参数，然后返回修改后的对象。使用side-effects时,不会对传递的对象进行转换。相反，该函数对对象执行操作，例如绘制图或保存文件。副作用函数应该“无形地”返回第一个参数，以便在不打印它们时仍可以在管道中使用它们。例如，以下简单函数在数据框中打印缺失值的数量：</p>
<p>以上从 R for Data Science 中翻译得来。</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>show_missings <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Missing values: &quot;</span>, n, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(df)</span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>以交互invisible()方式调用它,则意味着输入df不会被打印出来:</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_missings</span>(mtcars)</span></code></pre></div>
<p>但是结果仍存在，默认情况下只是不打印显示出来:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">show_missings</span>(mtcars) </span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x)</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(x)</span></code></pre></div>
<p>在管道中继续使用</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_missings</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mpg =</span> <span class="fu">ifelse</span>(mpg <span class="sc">&lt;</span> <span class="dv">20</span>, <span class="cn">NA</span>, mpg)) <span class="sc">%&gt;%</span> </span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_missings</span>() </span></code></pre></div>
</div>
</div>
<div id="环境" class="section level2" number="11.5">
<h2 number="11.5"><span class="header-section-number">11.5</span> 环境</h2>
<p>环境是复杂的,建议阅读原文.</p>
<p>The last component of a function is its environment. This is not something you need to understand deeply when you first start writing functions. However, it’s important to know a little bit about environments because they are crucial to how functions work. The environment of a function controls how R finds the value associated with a name. For example, take this function:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a>} </span></code></pre></div>
<p>在很多其他的编程语言中这样定义函数是错误的，因为没有定义<code>y</code>.在R中,这是有效的代码,因为R使用称为<code>lexical scoping</code>的方式寻找关联值.在函数内部没有定义<code>y</code>,将在上一层环境中查看<code>y</code>:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">10</span>)</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">10</span>)</span></code></pre></div>
<p>具体详细的资料请查阅：</p>
<p><a href="https://r4ds.had.co.nz/functions.html#environment" class="uri">https://r4ds.had.co.nz/functions.html#environment</a></p>
<p><a href="http://adv-r.had.co.nz/" class="uri">http://adv-r.had.co.nz/</a></p>
</div>
<div id="拓展部分" class="section level2" number="11.6">
<h2 number="11.6"><span class="header-section-number">11.6</span> 拓展部分</h2>
<p>在我之前工作中遇到需要分组计算时,我想要编写一个函数实现某些功能,但是分组的group_by()字段不一样时,导致代码没办法复用。</p>
<p>参考资料：<a href="https://dplyr.tidyverse.org/articles/programming.html" class="uri">https://dplyr.tidyverse.org/articles/programming.html</a></p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(tidyverse)</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>mean_mpg <span class="ot">=</span> <span class="cf">function</span>(data, group_col) {</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group_col) <span class="sc">%&gt;%</span></span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_mpg =</span> <span class="fu">mean</span>(mpg))</span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">mean_mpg</span>(cyl)</span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">mean_mpg</span>(gear)</span></code></pre></div>
<p>当编写如下函数时,代码将成功运行</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="co">#自定义函数</span></span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>my_summarise3 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var,mean_var, sd_var) {</span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>({{ group_var }}) <span class="sc">%&gt;%</span> </span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>({{ mean_var }}), <span class="at">sd =</span> <span class="fu">mean</span>({{ sd_var }}))</span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-8"><a href="#cb314-8" aria-hidden="true" tabindex="-1"></a>res1 <span class="ot">&lt;-</span> <span class="fu">my_summarise3</span>(<span class="at">data =</span> mtcars,<span class="at">group_var =</span> cyl,<span class="at">mean_var =</span> carb,<span class="at">sd_var =</span> gear)</span>
<span id="cb314-9"><a href="#cb314-9" aria-hidden="true" tabindex="-1"></a><span class="fu">my_summarise3</span>(<span class="at">data =</span> mtcars,<span class="at">group_var =</span> am,<span class="at">mean_var =</span> carb,<span class="at">sd_var =</span> gear)</span>
<span id="cb314-10"><a href="#cb314-10" aria-hidden="true" tabindex="-1"></a><span class="co">#正常写法</span></span>
<span id="cb314-11"><a href="#cb314-11" aria-hidden="true" tabindex="-1"></a>res2 <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb314-12"><a href="#cb314-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">%&gt;%</span> </span>
<span id="cb314-13"><a href="#cb314-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean=</span><span class="fu">mean</span>(carb),<span class="at">sd=</span><span class="fu">mean</span>(gear))</span>
<span id="cb314-14"><a href="#cb314-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-15"><a href="#cb314-15" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(res1,res2)</span>
<span id="cb314-16"><a href="#cb314-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-17"><a href="#cb314-17" aria-hidden="true" tabindex="-1"></a><span class="co">#res1 和res2 结果完全一致</span></span></code></pre></div>
<p>以上my_summarise3()函数可以按照需求任意指定聚合汇总字段。</p>
<!--chapter:end:10-function.Rmd-->
</div>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
